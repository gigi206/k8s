# =============================================================================
# ArgoCD CI-specific Helm Values
# =============================================================================
# Resource exclusions and health overrides for CI environment (K3d).
# Baked into the Helm install to avoid timing issues with post-install patches.
#
# Resource exclusions reduce ArgoCD's cluster-wide resource tracking overhead,
# improving reconciliation speed for all Applications.
# CRITICAL: removing these causes kyverno/external-secrets to go from ~30s
# to 15min+ (full 900s timeout). Keep even if argocd-cm shows chart defaults.
#
# Health overrides force Healthy status for operator-managed CRs whose health
# depends on operator reconciliation timing or missing CI dependencies.
# =============================================================================

configs:
  cm:
    # =========================================================================
    # Resource Exclusions
    # =========================================================================
    # Reduce ArgoCD's cluster-wide resource tracking. These CRD-based resources
    # depend on operators being fully ready and can slow down reconciliation.
    resource.exclusions: |
      - apiGroups:
          - monitoring.coreos.com
        kinds:
          - ServiceMonitor
          - PodMonitor
          - PrometheusRule
          - Prometheus
          - Alertmanager
        clusters:
          - "*"
      - apiGroups:
          - external-secrets.io
        kinds:
          - ClusterSecretStore
          - ExternalSecret
          - SecretStore
        clusters:
          - "*"
      - apiGroups:
          - gateway.networking.k8s.io
        kinds:
          - HTTPRoute
          - GRPCRoute
          - TLSRoute
          - TCPRoute
          - UDPRoute
          - ReferenceGrant
          - Gateway
        clusters:
          - "*"
      - apiGroups:
          - cert-manager.io
        kinds:
          - Certificate
          - CertificateRequest
          - Issuer
          - ClusterIssuer
        clusters:
          - "*"

    # =========================================================================
    # Health Overrides
    # =========================================================================
    # Force Healthy status for operator-managed CRs whose health depends on
    # operator reconciliation timing. Resources in Application manifests are
    # still health-checked even when excluded from cluster-wide tracking.

    # cert-manager.io: Certificate chain ordering issues
    # (self-signed issuer -> root cert -> CA issuer -> admission cert)
    resource.customizations.health.cert-manager.io_Certificate: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: cert-manager managed resource"
      return hs
    resource.customizations.health.cert-manager.io_CertificateRequest: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: cert-manager managed resource"
      return hs
    resource.customizations.health.cert-manager.io_Issuer: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: cert-manager managed resource"
      return hs
    resource.customizations.health.cert-manager.io_ClusterIssuer: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: cert-manager managed resource"
      return hs

    # monitoring.coreos.com: Operator needs time to reconcile CRs
    resource.customizations.health.monitoring.coreos.com_Prometheus: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: operator-managed resource"
      return hs
    resource.customizations.health.monitoring.coreos.com_Alertmanager: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: operator-managed resource"
      return hs

    # cilium.io: CiliumNetworkPolicy status depends on Cilium agent readiness
    resource.customizations.health.cilium.io_CiliumNetworkPolicy: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: Cilium managed resource"
      return hs

    # kyverno.io: PolicyException status depends on Kyverno controller
    resource.customizations.health.kyverno.io_PolicyException: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: Kyverno managed resource"
      return hs

    # gateway.networking.k8s.io: HTTPRoute ResolvedRefs condition fails in CI
    # when cross-namespace backends (oauth2-proxy) are missing ReferenceGrant.
    # Traefik sets ResolvedRefs=False -> ArgoCD health check returns Degraded.
    resource.customizations.health.gateway.networking.k8s.io_HTTPRoute: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: Gateway API managed resource"
      return hs
