# =============================================================================
# ArgoCD CI-specific Helm Values
# =============================================================================
# Health overrides for CI environment (K3d).
# Baked into the Helm install to avoid timing issues with post-install patches.
#
# Force Healthy status for operator-managed CRs whose health depends on
# operator reconciliation timing or missing CI dependencies (cert-manager
# certificate chains, Prometheus/Alertmanager CRs, oauth2-proxy HTTPRoutes).
#
# Note: resource.exclusions are NOT set here because the ArgoCD chart's
# default exclusions would override them (Helm replaces string values).
# The chart defaults already exclude Endpoints, Leases, auth resources, etc.
# =============================================================================

configs:
  cm:
    # =========================================================================
    # Health Overrides
    # =========================================================================

    # cert-manager.io: Certificate chain ordering issues
    # (self-signed issuer -> root cert -> CA issuer -> admission cert)
    resource.customizations.health.cert-manager.io_Certificate: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: cert-manager managed resource"
      return hs
    resource.customizations.health.cert-manager.io_CertificateRequest: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: cert-manager managed resource"
      return hs
    resource.customizations.health.cert-manager.io_Issuer: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: cert-manager managed resource"
      return hs
    resource.customizations.health.cert-manager.io_ClusterIssuer: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: cert-manager managed resource"
      return hs

    # monitoring.coreos.com: Operator needs time to reconcile CRs
    resource.customizations.health.monitoring.coreos.com_Prometheus: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: operator-managed resource"
      return hs
    resource.customizations.health.monitoring.coreos.com_Alertmanager: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: operator-managed resource"
      return hs

    # cilium.io: CiliumNetworkPolicy status depends on Cilium agent readiness
    resource.customizations.health.cilium.io_CiliumNetworkPolicy: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: Cilium managed resource"
      return hs

    # kyverno.io: PolicyException status depends on Kyverno controller
    resource.customizations.health.kyverno.io_PolicyException: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: Kyverno managed resource"
      return hs

    # gateway.networking.k8s.io: HTTPRoute ResolvedRefs condition fails in CI
    # when cross-namespace backends (oauth2-proxy) are missing ReferenceGrant.
    # Traefik sets ResolvedRefs=False -> ArgoCD health check returns Degraded.
    resource.customizations.health.gateway.networking.k8s.io_HTTPRoute: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: Gateway API managed resource"
      return hs
