# =============================================================================
# ArgoCD CI-specific Helm Values
# =============================================================================
# Health overrides for CI environment (K3d).
# Baked into the Helm install to avoid timing issues with post-install patches.
#
# Why: In CI, Applications deploy all resources at once, but CRD-based custom
# resources (Certificates, Issuers, Prometheus, Alertmanager) depend on their
# operators being fully ready. Dependency chains (e.g., self-signed Issuer ->
# root Certificate -> CA Issuer -> admission Certificate) cause transient
# Degraded health that may not resolve within the CI timeout.
#
# Solution: Override health assessment for operator-managed CRs to force
# Healthy status. The actual operators still reconcile the resources normally.
# =============================================================================

configs:
  cm:
    # =========================================================================
    # Health Overrides
    # =========================================================================
    # Force Healthy status for operator-managed CRs whose health depends on
    # operator reconciliation timing. This prevents false Degraded status
    # caused by dependency chains between CRD resources.

    # cert-manager.io: Certificate chain ordering issues
    # (self-signed issuer -> root cert -> CA issuer -> admission cert)
    resource.customizations.health.cert-manager.io_Certificate: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: cert-manager managed resource"
      return hs
    resource.customizations.health.cert-manager.io_CertificateRequest: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: cert-manager managed resource"
      return hs
    resource.customizations.health.cert-manager.io_Issuer: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: cert-manager managed resource"
      return hs
    resource.customizations.health.cert-manager.io_ClusterIssuer: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: cert-manager managed resource"
      return hs

    # monitoring.coreos.com: Operator needs time to reconcile CRs
    resource.customizations.health.monitoring.coreos.com_Prometheus: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: operator-managed resource"
      return hs
    resource.customizations.health.monitoring.coreos.com_Alertmanager: |
      hs = {}
      hs.status = "Healthy"
      hs.message = "CI: operator-managed resource"
      return hs
