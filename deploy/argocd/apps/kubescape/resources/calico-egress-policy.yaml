---
# =============================================================================
# Calico NetworkPolicy - Kubescape External Egress
# =============================================================================
# Calico equivalent of cilium-egress-policy.yaml
#
# Allows Kubescape to reach external services:
# - Vulnerability database updates (Grype DB)
# - Control frameworks updates (CIS, NSA, MITRE)
# - Container registry scanning
#
# Also allows internal Kubescape inter-component communication.
# =============================================================================

apiVersion: crd.projectcalico.org/v1
kind: NetworkPolicy
metadata:
  name: kubescape-allow-external-egress
  namespace: kubescape
spec:
  selector: all()
  types:
    - Egress
  egress:
    # Allow DNS (required: this policy creates implicit deny on all egress)
    - action: Allow
      protocol: UDP
      destination:
        ports: [53]
    - action: Allow
      protocol: TCP
      destination:
        ports: [53]
    # Allow cluster-internal traffic (pod + service + node CIDRs)
    # Node CIDR required for BPF DNAT (ClusterIP -> node IP before policy eval)
    - action: Allow
      destination:
        nets:
          - "10.42.0.0/16"
          - "10.43.0.0/16"
          - "192.168.121.0/24"
    # Allow internal Kubescape communication (same namespace)
    - action: Allow
      protocol: TCP
      destination:
        namespaceSelector: 'kubernetes.io/metadata.name == "kubescape"'
        ports:
          - 8080
          - 8443
          - 4002
          - 8089

    # Allow HTTPS to external services (CVE databases, registries, framework updates)
    - action: Allow
      protocol: TCP
      destination:
        notNets:
          - "10.42.0.0/16"
          - "10.43.0.0/16"
        ports:
          - 443
