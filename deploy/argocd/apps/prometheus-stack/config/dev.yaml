---
# Configuration Prometheus-Stack - Dev
environment: dev
appName: prometheus-stack

prometheusStack:
  version: "80.4.2"
  prometheus:
    # Persistence (requires features.storage.enabled)
    persistence:
      enabled: true
      size: "2Gi"

    # Retention
    retention: "2d"

    # Replicas (dev: 1)
    replicas: 1

    # Resources (dev: minimal)
    resources:
      requests:
        cpu: "100m"
        memory: "512Mi"
      limits:
        cpu: "500m"
        memory: "1Gi"

    # Ingress (dev: disabled - using Gateway API HTTPRoute)
    ingress:
      enabled: false
      hostname: "prometheus.{{ .common.domain }}"

    # Remote write receiver (for external metrics)
    enableRemoteWriteReceiver: false

  grafana:
    # Admin credentials managed via KSOPS encrypted secrets
    # See: secrets/secret-dev.yaml

    # ===================
    # OIDC Configuration (Keycloak)
    # ===================
    # Note: Les URLs OIDC sont construites dynamiquement dans l'ApplicationSet
    # en utilisant common.domain et le realm ci-dessous
    oidc:
      enabled: true
      name: "Keycloak"
      realm: "k8s"  # Keycloak realm name - URLs construites via {{ .common.domain }}
      allowSignUp: true
      autoLogin: true
      clientId: "grafana"
      scopes: "openid email profile groups"
      # Mapping des groupes Keycloak vers les roles Grafana
      # admins -> Admin, developers -> Editor, autres -> Viewer
      roleAttributePath: "contains(groups[*], 'admins') && 'Admin' || contains(groups[*], 'developers') && 'Editor' || 'Viewer'"
      allowAssignGrafanaAdmin: true

    # Replicas (dev: 1)
    replicas: 1

    # Persistence (requires features.storage.enabled)
    persistence:
      enabled: true
      size: "1Gi"

    # Resources (dev: minimal, augmenté pour éviter OOMKill)
    resources:
      requests:
        cpu: "50m"
        memory: "256Mi"
      limits:
        cpu: "200m"
        memory: "512Mi"

    # Ingress (dev: disabled - using Gateway API HTTPRoute)
    ingress:
      enabled: false
      hostname: "grafana.{{ .common.domain }}"

    # Grafana.ini configuration
    grafanaIni:
      analytics:
        check_for_updates: false

      # Alerting configuration
      unified_alerting:
        enabled: true      # Nouveau système d'alerting (Grafana 8+, obligatoire depuis Grafana 12+)

    # Sidecar dashboards configuration
    # Note: folderAnnotation est géré par ApplicationSet via features.monitoring.dashboard.folderAnnotation
    sidecar:
      dashboards:
        enabled: true
        # folderAnnotation: géré par ApplicationSet (default: features.monitoring.dashboard.folderAnnotation)
        folder: "Prometheus Stack"  # Nom du dossier Grafana pour les dashboards
        provider:
          foldersFromFilesStructure: true

    # Readiness probe
    readinessProbe:
      timeoutSeconds: 5

    # ServiceMonitor for Grafana metrics
    serviceMonitor:
      enabled: true
      labels:
        release: "{{ .features.monitoring.release }}"

  alertmanager:
    # Alertmanager (dev: enabled)
    enabled: true

    # Replicas (dev: 1)
    replicas: 1

    # Resources (dev: minimal)
    resources:
      requests:
        cpu: "50m"
        memory: "64Mi"
      limits:
        cpu: "100m"
        memory: "128Mi"

    # Ingress (dev: disabled - using Gateway API HTTPRoute)
    ingress:
      enabled: false
      hostname: "alertmanager.{{ .common.domain }}"

    # Persistence (requires features.storage.enabled)
    persistence:
      enabled: true
      size: "1Gi"

  pushgateway:
    # Pushgateway (dev: disabled)
    enabled: false

    # Resources (dev: minimal)
    resources:
      requests:
        cpu: "100m"
        memory: "128Mi"
      limits:
        cpu: "500m"
        memory: "256Mi"

    # ServiceMonitor
    serviceMonitor:
      enabled: true
      namespace: "monitoring"

syncPolicy:
  automated:
    enabled: true
    prune: true
    selfHeal: true
