---
# =============================================================================
# SecurityPolicy - OIDC Authentication (Envoy Gateway)
# =============================================================================
# Protects Prometheus and Alertmanager using Envoy Gateway's native OIDC.
# Automatically redirects unauthenticated users to Keycloak for login.
#
# Security: FAIL-CLOSE by default - if OIDC provider is unavailable, access is DENIED.
# Retry policy configured for transient failures.
#
# Requirements:
# - Backend 'backend-keycloak' for TLS connection to Keycloak
# - Secret 'oidc-client-secret' with key 'client-secret' in monitoring namespace
# - Keycloak client 'oauth2-proxy' with redirect URIs configured
# =============================================================================

# Prometheus SecurityPolicy
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: oidc-prometheus
  namespace: monitoring
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: prometheus
  oidc:
    provider:
      backendRefs:
      - group: gateway.envoyproxy.io
        kind: Backend
        name: backend-keycloak
        port: 443
        weight: 1
      issuer: "https://keycloak.PLACEHOLDER.example.com/realms/k8s"  # Patched via Kustomize
      authorizationEndpoint: "https://keycloak.PLACEHOLDER.example.com/realms/k8s/protocol/openid-connect/auth"
      tokenEndpoint: "https://keycloak.PLACEHOLDER.example.com/realms/k8s/protocol/openid-connect/token"
      # Retry policy for transient OIDC provider failures
      backendSettings:
        retry:
          numRetries: 3
          perRetry:
            backOff:
              baseInterval: 500ms
              maxInterval: 5s
          retryOn:
            triggers: ["5xx", "gateway-error", "reset", "connect-failure"]
    clientID: "oauth2-proxy"
    clientSecret:
      group: ""
      kind: Secret
      name: "oidc-client-secret"
    redirectURL: "https://prometheus.PLACEHOLDER.example.com/oauth2/callback"  # Patched via Kustomize
    logoutPath: "/oauth2/sign_out"
    refreshToken: true

---
# Alertmanager SecurityPolicy
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: oidc-alertmanager
  namespace: monitoring
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: alertmanager
  oidc:
    provider:
      backendRefs:
      - group: gateway.envoyproxy.io
        kind: Backend
        name: backend-keycloak
        port: 443
        weight: 1
      issuer: "https://keycloak.PLACEHOLDER.example.com/realms/k8s"  # Patched via Kustomize
      authorizationEndpoint: "https://keycloak.PLACEHOLDER.example.com/realms/k8s/protocol/openid-connect/auth"
      tokenEndpoint: "https://keycloak.PLACEHOLDER.example.com/realms/k8s/protocol/openid-connect/token"
      # Retry policy for transient OIDC provider failures
      backendSettings:
        retry:
          numRetries: 3
          perRetry:
            backOff:
              baseInterval: 500ms
              maxInterval: 5s
          retryOn:
            triggers: ["5xx", "gateway-error", "reset", "connect-failure"]
    clientID: "oauth2-proxy"
    clientSecret:
      group: ""
      kind: Secret
      name: "oidc-client-secret"
    redirectURL: "https://alertmanager.PLACEHOLDER.example.com/oauth2/callback"  # Patched via Kustomize
    logoutPath: "/oauth2/sign_out"
    refreshToken: true
