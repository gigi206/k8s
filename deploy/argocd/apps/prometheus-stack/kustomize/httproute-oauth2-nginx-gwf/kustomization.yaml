---
# =============================================================================
# HTTPRoute + OAuth2 SnippetsFilter for nginx-gateway-fabric
# =============================================================================
# Combines HTTPRoutes with OAuth2 authentication for nginx-gwf.
# Uses httproute/ as base and adds SnippetsFilter + extensionRef patches.
# SECURITY: All resources are in the same source, ensuring atomic deployment.
# If SnippetsFilter CRD doesn't exist, entire source fails = no unprotected routes.
# =============================================================================
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # Base HTTPRoutes
  - ../httproute
  # OAuth2 SnippetsFilter (must be created together with HTTPRoutes)
  - snippetsfilter.yaml
  - referencegrant.yaml

patches:
  # Add extensionRef to prometheus HTTPRoute
  - target:
      group: gateway.networking.k8s.io
      version: v1
      kind: HTTPRoute
      name: prometheus
    patch: |
      - op: add
        path: /spec/rules/1/filters
        value:
          - type: ExtensionRef
            extensionRef:
              group: gateway.nginx.org
              kind: SnippetsFilter
              name: oauth2-auth
  # Add extensionRef to alertmanager HTTPRoute
  - target:
      group: gateway.networking.k8s.io
      version: v1
      kind: HTTPRoute
      name: alertmanager
    patch: |
      - op: add
        path: /spec/rules/1/filters
        value:
          - type: ExtensionRef
            extensionRef:
              group: gateway.nginx.org
              kind: SnippetsFilter
              name: oauth2-auth
