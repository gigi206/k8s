---
# =============================================================================
# KeycloakRealmImport - Client OIDC Grafana
# =============================================================================
# Deploie le client OIDC Grafana dans le realm "gigix"
# Ce fichier rend Grafana autonome pour sa configuration OIDC
# =============================================================================

apiVersion: k8s.keycloak.org/v2alpha1
kind: KeycloakRealmImport
metadata:
  name: grafana-oidc-client
  namespace: keycloak
spec:
  keycloakCRName: keycloak
  realm:
    # Target le realm existant
    realm: gigix

    # ===================
    # Client OIDC Grafana
    # ===================
    clients:
      - clientId: grafana
        name: Grafana
        description: "Client OIDC pour Grafana monitoring"
        enabled: true
        clientAuthenticatorType: client-secret
        secret: "$(env:GRAFANA_CLIENT_SECRET)"
        redirectUris:
          - "https://grafana.gigix/login/generic_oauth"
          - "http://localhost:3000/login/generic_oauth"
        webOrigins:
          - "https://grafana.gigix"
        standardFlowEnabled: true
        implicitFlowEnabled: false
        directAccessGrantsEnabled: false
        serviceAccountsEnabled: false
        publicClient: false
        protocol: openid-connect
        fullScopeAllowed: true
        defaultClientScopes:
          - openid
          - profile
          - email
          - groups
        optionalClientScopes:
          - offline_access
        attributes:
          pkce.code.challenge.method: "S256"
          post.logout.redirect.uris: "https://grafana.gigix/*"

  # ===================
  # Secret Placeholder
  # ===================
  # Reference au secret dans le namespace keycloak
  placeholders:
    GRAFANA_CLIENT_SECRET:
      secret:
        name: grafana-oidc-client-secret
        key: client-secret
