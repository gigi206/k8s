---
# =============================================================================
# ExternalSecret - Transform OIDC secret in monitoring namespace
# =============================================================================
# Transforme le secret source en secret utilisable par Grafana
# Le secret source est: monitoring/grafana-oidc-client-secret (créé par KSOPS)
# =============================================================================

apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: grafana-oidc-external
  namespace: monitoring
spec:
  # Fréquence de refresh
  refreshInterval: 1h

  # Reference au ClusterSecretStore qui lit depuis monitoring namespace
  secretStoreRef:
    kind: ClusterSecretStore
    name: monitoring-oidc-secrets

  # Secret cible à créer dans monitoring namespace
  target:
    name: grafana-oidc-credentials
    creationPolicy: Owner
    deletionPolicy: Retain

  # Mapping des clés
  data:
    # Clé attendue par Grafana pour le client secret
    - secretKey: client-secret
      remoteRef:
        key: grafana-oidc-client-secret
        property: client-secret
