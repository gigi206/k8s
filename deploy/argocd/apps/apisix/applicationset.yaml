---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: apisix
  namespace: argo-cd
  annotations:
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Global config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # App-specific config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/apisix/config/*.yaml

  template:
    metadata:
      name: 'apisix'
      namespace: argo-cd
      labels:
        app: apisix
        environment: '{{ .environment }}'
      annotations:
    spec:
      project: default
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ .apisix.namespace }}'

  templatePatch: |
    spec:
      # Ignore dynamically generated resources (webhook certs, helm metadata, PostSync patches)
      ignoreDifferences:
        - group: ""
          kind: Secret
          name: apisix-ingress-controller-webhook-cert
          jsonPointers:
            - /data
        - group: admissionregistration.k8s.io
          kind: ValidatingWebhookConfiguration
          name: apisix-ingress-controller-webhook
          jqPathExpressions:
            - .webhooks[].clientConfig.caBundle
        # Ignore ConfigMap changes from PostSync configmap-patch-job (adds secret.kubernetes section)
        - group: ""
          kind: ConfigMap
          name: apisix
          jsonPointers:
            - /data

      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
          - {{ . }}
        {{- end }}
      {{- if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
        retry:
          limit: {{ .syncPolicy.retry.limit }}
          backoff:
            duration: {{ .syncPolicy.retry.backoff.duration }}
            factor: 2
            maxDuration: {{ .syncPolicy.retry.backoff.maxDuration }}

      sources:
        {{- if .rke2.cis.enabled }}
        # Source: Namespace with PSA labels for CIS profile compatibility
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/apisix/resources
          directory:
            include: "namespace.yaml"
        {{- end }}
        {{- if .features.cilium.ingressPolicy.enabled }}
        # Cilium Host Ingress Policy (allow 80/443 to nodes for LoadBalancer)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/apisix/resources
          directory:
            include: "cilium-host-ingress-policy.yaml"
        # Cilium Pod Ingress Policies (allow traffic to APISIX and ETCD pods)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/apisix/resources
          directory:
            include: "cilium-ingress-policy.yaml"
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/apisix/resources
          directory:
            include: "cilium-etcd-policy.yaml"
        {{- end }}
        {{- if .features.kyverno.enabled }}
        # Source: Kyverno PolicyException (allows SA token mount for K8s API access)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/apisix/resources
          directory:
            include: "kyverno-policy-exception.yaml"
        {{- end }}
        {{- if and .apisix.etcd.external.enabled .apisix.etcd.external.tls.enabled }}
        # TLS Certificates for etcd mTLS (server, client, peer)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/apisix/kustomize/etcd-tls
        {{- end }}
        {{- if .apisix.etcd.external.enabled }}
        # External etcd (CloudPirates OCI - quay.io/coreos/etcd)
        - repoURL: ghcr.io/cloudpirates-io/helm-charts
          targetRevision: '{{ .apisix.etcd.external.version }}'
          chart: etcd
          helm:
            releaseName: apisix-etcd
            valuesObject:
              fullnameOverride: apisix-etcd
              replicaCount: {{ .apisix.etcd.external.replicas | default 1 }}
              {{- if .apisix.etcd.external.tls.enabled }}
              # mTLS configuration (CloudPirates etcd chart structure)
              auth:
                enabled: true
                existingSecret: {{ .apisix.etcd.external.tls.serverSecret }}
                peer:
                  enabled: true
                  existingSecret: {{ .apisix.etcd.external.tls.peerSecret }}
              {{- end }}
              # Persistence configuration (disabled by default for GitOps)
              persistence:
                enabled: {{ .apisix.etcd.external.persistence.enabled }}
                {{- if .apisix.etcd.external.persistence.enabled }}
                storageClass: {{ .apisix.etcd.external.persistence.storageClass }}
                size: {{ .apisix.etcd.external.persistence.size }}
                {{- end }}
        {{- end }}
        # PostSync Job: Patch ConfigMap with secret manager config
        # Required for $secret://kubernetes/... URIs in ApisixRoute plugins
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/apisix/resources
          directory:
            include: "configmap-patch-job.yaml"
        # RBAC: Allow APISIX to read Kubernetes Secrets
        # Required for secret manager to fetch secrets
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/apisix/resources
          directory:
            include: "secret-reader-rbac.yaml"
        # Source 0: APISIX Helm Chart
        - repoURL: {{ .apisix.chart.repo }}
          chart: {{ .apisix.chart.name }}
          targetRevision: {{ .apisix.chart.version }}
          helm:
            releaseName: apisix
            # CRDs managed by apisix-ingress-controller sub-chart
            valuesObject:
              # Replica count
              replicaCount: {{ .apisix.replicaCount }}

              # Resource limits
              resources:
                requests:
                  cpu: {{ .apisix.resources.requests.cpu }}
                  memory: {{ .apisix.resources.requests.memory }}
                limits:
                  cpu: {{ .apisix.resources.limits.cpu }}
                  memory: {{ .apisix.resources.limits.memory }}

              {{- if and .features.sso.enabled (eq .features.sso.provider "keycloak") }}
              # Mount root CA for TLS verification of OIDC endpoints (Keycloak)
              extraVolumes:
                - name: root-ca
                  secret:
                    secretName: root-ca
              extraVolumeMounts:
                - name: root-ca
                  mountPath: /etc/apisix/ssl
                  readOnly: true
              {{- end }}

              # APISIX SSL configuration (for HTTPS listener support)
              apisix:
                ssl:
                  enabled: {{ .apisix.gateway.tls.enabled }}
                  listen:
                    - port: 9443
                      enable_http3: false
                  {{- if .apisix.etcd.external.tls.enabled }}
                  # CA for TLS verification of etcd server certificate
                  existingCASecret: {{ .apisix.etcd.external.tls.caSecret }}
                  certCAFilename: ca.crt
                  {{- end }}
                  {{- if and .features.sso.enabled (eq .features.sso.provider "keycloak") }}
                  # Trust cluster CA for OIDC plugin TLS verification (Keycloak)
                  ssl_trusted_certificate: /etc/apisix/ssl/ca.crt
                  {{- end }}
                {{- if .apisix.stream_proxy.enabled }}
                stream_proxy:
                  tcp:
                  {{- range .apisix.stream_proxy.tcp }}
                    - {{ . }}
                  {{- end }}
                  udp:
                  {{- range .apisix.stream_proxy.udp }}
                    - {{ . }}
                  {{- end }}
                {{- end }}

              # Service configuration
              service:
                type: {{ .apisix.gateway.type }}
                {{- if .features.loadBalancer.staticIPs.gateway }}
                loadBalancerIP: {{ .features.loadBalancer.staticIPs.gateway }}
                annotations:
                  metallb.universe.tf/address-pool: gateway
                  # External-DNS: Create DNS records for all ApisixRoute hostnames
                  external-dns.alpha.kubernetes.io/hostname: >-
                    argocd.{{ .common.domain }},
                    grafana.{{ .common.domain }},
                    prometheus.{{ .common.domain }},
                    alertmanager.{{ .common.domain }},
                    keycloak.{{ .common.domain }},
                    oauth2.{{ .common.domain }},
                    hubble.{{ .common.domain }},
                    ceph.{{ .common.domain }},
                    s3.{{ .common.domain }},
                    longhorn.{{ .common.domain }},
                    jaeger.{{ .common.domain }},
                    kiali.{{ .common.domain }},
                    neuvector.{{ .common.domain }},
                    apisix.{{ .common.domain }}
                {{- end }}
                http:
                  enabled: {{ .apisix.gateway.http.enabled }}
                  servicePort: 80
                  containerPort: 9080
                tls:
                  enabled: {{ .apisix.gateway.tls.enabled }}
                  servicePort: 443
                  containerPort: 9443
                {{- if .apisix.stream_proxy.enabled }}
                stream:
                  enabled: true
                  tcp:
                  {{- range .apisix.stream_proxy.tcp }}
                    - {{ . }}
                  {{- end }}
                  udp:
                  {{- range .apisix.stream_proxy.udp }}
                    - {{ . }}
                  {{- end }}
                {{- end }}

              # Admin API configuration
              admin:
                enabled: {{ .apisix.admin.enabled }}
                type: {{ .apisix.admin.type }}
                credentials:
                  admin: {{ .apisix.admin.credentials.admin }}
                  viewer: {{ .apisix.admin.credentials.viewer }}

              # ETCD configuration
              etcd:
                enabled: {{ .apisix.etcd.builtin.enabled }}
                auth:
                  # Disable RBAC auth (CloudPirates etcd doesn't support it)
                  rbac:
                    create: false
                  {{- if .apisix.etcd.external.tls.enabled }}
                  # mTLS configuration for etcd client
                  tls:
                    enabled: true
                    existingSecret: {{ .apisix.etcd.external.tls.clientSecret }}
                    certFilename: tls.crt
                    certKeyFilename: tls.key
                    verify: true
                    sni: apisix-etcd
                  {{- end }}
              {{- if .apisix.etcd.external.enabled }}
              # External etcd configuration
              externalEtcd:
                host:
                  - {{ .apisix.etcd.external.host }}
                # Disable user/password authentication (using mTLS instead)
                user: ""
                password: ""
              # Wait for etcd before starting APISIX
              initContainers:
                - name: wait-for-etcd
                  image: busybox:1.36
                  {{- if .apisix.etcd.external.tls.enabled }}
                  command: ["sh", "-c", "echo 'Waiting for etcd TLS...'; until nc -z apisix-etcd 2379; do sleep 2; done; echo 'etcd ready!'"]
                  {{- else }}
                  command: ["sh", "-c", "echo 'Waiting for etcd...'; until nc -z apisix-etcd 2379; do sleep 2; done; echo 'etcd ready!'"]
                  {{- end }}
                  securityContext:
                    runAsNonRoot: true
                    runAsUser: 65534
              {{- end }}

              # Enable ServiceMonitor for Prometheus
              metrics:
                serviceMonitor:
                  enabled: {{ .apisix.serviceMonitor.enabled }}
                  interval: {{ .apisix.serviceMonitor.interval }}
                  labels:
                    release: {{ .features.monitoring.release }}

              # APISIX Ingress Controller (sub-chart for Gateway API support)
              ingress-controller:
                enabled: {{ .ingressController.enabled }}
                deployment:
                  resources:
                    requests:
                      cpu: {{ .ingressController.resources.requests.cpu }}
                      memory: {{ .ingressController.resources.requests.memory }}
                    limits:
                      cpu: {{ .ingressController.resources.limits.cpu }}
                      memory: {{ .ingressController.resources.limits.memory }}
                config:
                  disableGatewayAPI: false
                gatewayProxy:
                  createDefault: true
                  provider:
                    type: ControlPlane
                    controlPlane:
                      service:
                        name: apisix-admin
                        port: 9180
                      auth:
                        type: AdminKey
                        adminKey:
                          value: {{ .apisix.admin.credentials.admin }}

        {{- if .features.monitoring.enabled }}
        # Prometheus monitoring (ServiceMonitor + PrometheusRules)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/apisix/kustomize/monitoring
          kustomize:
            commonLabels:
              release: {{ .features.monitoring.release }}
        {{- end }}

        {{- if .features.oauth2Proxy.enabled }}
        # OAuth2 Forward Auth - Dynamic HTTPRoute discovery
        # The CronJob discovers HTTPRoutes with label oauth2-protected=true
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/apisix/kustomize/plugins
        {{- end }}

        {{- if .gatewayAPI.enabled }}
        # Gateway API resources (GatewayClass, Gateway, Certificate)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/apisix/kustomize/gateway
          kustomize:
            patches:
              - target:
                  kind: Gateway
                  name: default-gateway
                patch: |
                  - op: replace
                    path: /spec/listeners/1/hostname
                    value: '*.{{ .common.domain }}'
                  {{- if .features.loadBalancer.staticIPs.gateway }}
                  - op: add
                    path: /metadata/annotations
                    value:
                      external-dns.alpha.kubernetes.io/target: '{{ .features.loadBalancer.staticIPs.gateway }}'
                  {{- end }}
              - target:
                  kind: Certificate
                  name: wildcard-k8s-local
                patch: |
                  - op: replace
                    path: /spec/dnsNames
                    value:
                      - '*.{{ .common.domain }}'
                      - '{{ .common.domain }}'
        {{- end }}

        {{- if .embeddedDashboard.enabled }}
        # =====================================================================
        # APISIX Embedded Dashboard (Admin API /ui/)
        # =====================================================================
        # Uses the built-in dashboard at apisix-admin:9180/ui/
        # Protected by openid-connect plugin for Keycloak SSO

        # Dashboard ApisixRoute with openid-connect plugin + Secret generator Job
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/apisix/kustomize/dashboard
          kustomize:
            patches:
              - target:
                  kind: ApisixRoute
                  name: apisix-dashboard
                patch: |
                  - op: replace
                    path: /spec/http/0/match/hosts/0
                    value: apisix.{{ .common.domain }}
                  - op: replace
                    path: /spec/http/0/plugins/0/config/discovery
                    value: https://keycloak.{{ .common.domain }}/realms/k8s/.well-known/openid-configuration
                  - op: replace
                    path: /spec/http/0/plugins/0/config/redirect_uri
                    value: https://apisix.{{ .common.domain }}/ui/callback
                  - op: replace
                    path: /spec/http/0/plugins/0/config/post_logout_redirect_uri
                    value: https://apisix.{{ .common.domain }}/ui/
                  - op: replace
                    path: /spec/http/0/plugins/1/config/headers/set/X-API-KEY
                    value: {{ .apisix.admin.credentials.admin }}
                  - op: replace
                    path: /spec/http/1/match/hosts/0
                    value: apisix.{{ .common.domain }}

        # Encrypted secrets (KSOPS) - OIDC client secret
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/apisix/secrets/{{ .environment }}

        {{- if and .features.sso.enabled (eq .features.sso.provider "keycloak") }}
        # SSO resources: Keycloak client Job + ExternalSecrets
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/apisix/kustomize/sso
          kustomize:
            images:
              - 'curlimages/curl={{ .images.curl.repository }}:{{ .images.curl.tag }}'
            patches:
              - target:
                  kind: Job
                  name: apisix-dashboard-keycloak-client
                patch: |
                  - op: replace
                    path: /spec/template/spec/containers/0/env/0/value
                    value: {{ .common.domain }}
        {{- end }}
        {{- if .features.cilium.defaultDenyPodIngress.enabled }}
        # Source: Cilium Pod Ingress Policy for APISIX Dashboard
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/apisix/resources
          directory:
            include: "cilium-dashboard-policy.yaml"
        {{- end }}
        {{- end }}
