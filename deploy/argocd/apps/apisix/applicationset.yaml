---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: apisix
  namespace: argo-cd
  annotations:
    argocd.argoproj.io/sync-wave: "42"  # After istio-gateway (wave 41), before prometheus-stack (wave 75)
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Global config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # App-specific config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/apisix/config/*.yaml

  template:
    metadata:
      name: 'apisix'
      namespace: argo-cd
      labels:
        app: apisix
        environment: '{{ .environment }}'
      annotations:
        argocd.argoproj.io/sync-wave: "42"
    spec:
      project: default
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ .apisix.namespace }}'

  templatePatch: |
    spec:
      # Ignore dynamically generated resources (etcd tokens, webhook certs, helm metadata)
      ignoreDifferences:
        - group: ""
          kind: Secret
          name: apisix-etcd-jwt-token
          jsonPointers:
            - /data
        - group: ""
          kind: Secret
          name: apisix-ingress-controller-webhook-cert
          jsonPointers:
            - /data
        - group: admissionregistration.k8s.io
          kind: ValidatingWebhookConfiguration
          name: apisix-ingress-controller-webhook
          jqPathExpressions:
            - .webhooks[].clientConfig.caBundle
        - group: apps
          kind: StatefulSet
          name: apisix-etcd
          jsonPointers:
            - /spec/volumeClaimTemplates/0/apiVersion
            - /spec/volumeClaimTemplates/0/kind

      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
          - {{ . }}
        {{- end }}
      {{- if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
        retry:
          limit: {{ .syncPolicy.retry.limit }}
          backoff:
            duration: {{ .syncPolicy.retry.backoff.duration }}
            factor: 2
            maxDuration: {{ .syncPolicy.retry.backoff.maxDuration }}

      sources:
        {{- if .features.cilium.ingressPolicy.enabled }}
        # Cilium Host Ingress Policy (allow 80/443 to nodes for LoadBalancer)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/apisix/resources
          directory:
            include: "cilium-host-ingress-policy.yaml"
        # Cilium Pod Ingress Policies (allow traffic to APISIX and ETCD pods)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/apisix/resources
          directory:
            include: "cilium-ingress-policy.yaml"
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/apisix/resources
          directory:
            include: "cilium-etcd-policy.yaml"
        {{- end }}
        # Source 0: APISIX Helm Chart
        - repoURL: {{ .apisix.chart.repo }}
          chart: {{ .apisix.chart.name }}
          targetRevision: {{ .apisix.chart.version }}
          helm:
            releaseName: apisix
            valuesObject:
              # Replica count
              replicaCount: {{ .apisix.replicaCount }}

              # Resource limits
              resources:
                requests:
                  cpu: {{ .apisix.resources.requests.cpu }}
                  memory: {{ .apisix.resources.requests.memory }}
                limits:
                  cpu: {{ .apisix.resources.limits.cpu }}
                  memory: {{ .apisix.resources.limits.memory }}

              # APISIX SSL configuration (for HTTPS listener support)
              apisix:
                ssl:
                  enabled: {{ .apisix.gateway.tls.enabled }}
                  listen:
                    - port: 9443
                      enable_http3: false

              # Service configuration
              service:
                type: {{ .apisix.gateway.type }}
                {{- if .apisix.gateway.loadBalancerIP }}
                annotations:
                  metallb.universe.tf/address-pool: apisix-gateway
                {{- end }}
                http:
                  enabled: {{ .apisix.gateway.http.enabled }}
                  servicePort: 80
                  containerPort: 9080
                tls:
                  enabled: {{ .apisix.gateway.tls.enabled }}
                  servicePort: 443
                  containerPort: 9443

              # Admin API configuration
              admin:
                enabled: {{ .apisix.admin.enabled }}
                type: {{ .apisix.admin.type }}
                credentials:
                  admin: {{ .apisix.admin.credentials.admin }}
                  viewer: {{ .apisix.admin.credentials.viewer }}

              # Embedded ETCD configuration
              etcd:
                enabled: {{ .apisix.etcd.enabled }}
                replicaCount: {{ .apisix.etcd.replicaCount }}
                persistence:
                  enabled: {{ .apisix.etcd.persistence.enabled }}
                  size: {{ .apisix.etcd.persistence.size }}
                # Disable pre-upgrade hook that causes issues during initial installation
                preUpgradeJob:
                  enabled: false

              # Enable ServiceMonitor for Prometheus
              serviceMonitor:
                enabled: {{ .apisix.serviceMonitor.enabled }}
                interval: {{ .apisix.serviceMonitor.interval }}
                labels:
                  release: {{ .features.monitoring.release }}

              # APISIX Ingress Controller (sub-chart for Gateway API support)
              ingress-controller:
                enabled: {{ .ingressController.enabled }}
                deployment:
                  resources:
                    requests:
                      cpu: {{ .ingressController.resources.requests.cpu }}
                      memory: {{ .ingressController.resources.requests.memory }}
                    limits:
                      cpu: {{ .ingressController.resources.limits.cpu }}
                      memory: {{ .ingressController.resources.limits.memory }}
                config:
                  disableGatewayAPI: false
                gatewayProxy:
                  createDefault: true
                  provider:
                    type: ControlPlane
                    controlPlane:
                      service:
                        name: apisix-admin
                        port: 9180
                      auth:
                        type: AdminKey
                        adminKey:
                          value: {{ .apisix.admin.credentials.admin }}

        {{- if .features.monitoring.enabled }}
        # Prometheus monitoring (ServiceMonitor + PrometheusRules)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/apisix/kustomize/monitoring
          kustomize:
            commonLabels:
              release: {{ .features.monitoring.release }}
        {{- end }}

        {{- if .features.oauth2Proxy.enabled }}
        # OAuth2 Forward Auth Post-Sync Job (applies forward-auth plugin to protected services)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/apisix/kustomize/plugins
        {{- end }}

        {{- if .gatewayAPI.enabled }}
        # Gateway API resources (GatewayClass, Gateway, Certificate)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/apisix/kustomize/gateway
          kustomize:
            patches:
              - target:
                  kind: Gateway
                  name: default-gateway
                patch: |
                  - op: replace
                    path: /spec/listeners/1/hostname
                    value: '*.{{ .common.domain }}'
                  {{- if .apisix.gateway.loadBalancerIP }}
                  - op: add
                    path: /metadata/annotations
                    value:
                      external-dns.alpha.kubernetes.io/target: '{{ .apisix.gateway.loadBalancerIP }}'
                  {{- end }}
              - target:
                  kind: Certificate
                  name: wildcard-k8s-local
                patch: |
                  - op: replace
                    path: /spec/dnsNames
                    value:
                      - '*.{{ .common.domain }}'
                      - '{{ .common.domain }}'
        {{- end }}
