---
# =============================================================================
# Job: Patch APISIX ConfigMap
# =============================================================================
# This job patches the APISIX ConfigMap to add:
# 1. secret.kubernetes section for $secret://kubernetes/... URIs in plugins
# 2. ssl_trusted_certificate in apisix.ssl for OIDC plugin TLS verification
#
# The APISIX helm chart doesn't expose these options directly.
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: apisix-configmap-secret-patch
  namespace: apisix
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 60
  template:
    metadata:
      labels:
        app: apisix-configmap-secret-patch
    spec:
      serviceAccountName: apisix-configmap-patcher
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: patch-configmap
          image: bitnami/kubectl:latest
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          imagePullPolicy: IfNotPresent
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -e
              echo "=== Patching APISIX ConfigMap ==="

              # Get current config
              echo "Reading current configuration..."
              kubectl get configmap apisix -n apisix -o jsonpath='{.data.config\.yaml}' > /tmp/config.yaml

              CHANGED=false

              # Add secret section if missing
              if ! grep -q "^secret" /tmp/config.yaml; then
                echo "Adding secret manager configuration..."
                printf '\nsecret:\n  kubernetes:\n    namespace: apisix\n' >> /tmp/config.yaml
                CHANGED=true
              else
                echo "Secret section already exists"
              fi

              # Add ssl_trusted_certificate in apisix.ssl section (for OIDC TLS verification)
              if ! grep -q "ssl_trusted_certificate" /tmp/config.yaml; then
                echo "Adding ssl_trusted_certificate for OIDC TLS..."
                # Insert after ssl_ciphers line in the apisix.ssl section
                LINE=$(grep -n "ssl_ciphers" /tmp/config.yaml | head -1 | cut -d":" -f1)
                if [ -n "$LINE" ]; then
                  sed -i "${LINE}a\\    ssl_trusted_certificate: /etc/apisix/ssl/ca.crt" /tmp/config.yaml
                fi
                CHANGED=true
              else
                echo "ssl_trusted_certificate already configured"
              fi

              if [ "$CHANGED" = "true" ]; then
                echo "Applying patched configuration..."
                kubectl create configmap apisix \
                  --from-file=config.yaml=/tmp/config.yaml \
                  -n apisix \
                  --dry-run=client -o yaml | \
                  kubectl apply -f -

                echo "Restarting APISIX deployment..."
                kubectl rollout restart deployment/apisix -n apisix
                kubectl rollout status deployment/apisix -n apisix --timeout=120s
              else
                echo "No changes needed"
              fi

              echo "=== ConfigMap patch complete ==="
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: apisix-configmap-patcher
  namespace: apisix
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: apisix-configmap-patcher
  namespace: apisix
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "patch", "create", "update"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: apisix-configmap-patcher
  namespace: apisix
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: apisix-configmap-patcher
subjects:
  - kind: ServiceAccount
    name: apisix-configmap-patcher
    namespace: apisix
