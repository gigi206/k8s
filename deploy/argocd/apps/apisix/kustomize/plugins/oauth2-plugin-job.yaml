---
# =============================================================================
# CronJob - OAuth2 Forward Auth Global Rule Manager
# =============================================================================
# This CronJob creates/maintains an APISIX Global Rule for OAuth2 authentication.
# Using a Global Rule instead of per-route plugins ensures the auth is not
# overwritten by the APISIX Ingress Controller reconciliation.
#
# Dynamic Discovery:
# The CronJob discovers HTTPRoutes with label "oauth2-protected=true" across
# all namespaces and extracts their hostnames to build the protected hosts list.
#
# The Global Rule uses serverless-pre-function to:
# 1. Check if the request host is in the protected list
# 2. Skip /oauth2/* paths (OAuth2 Proxy callback routes)
# 3. Check for _oauth2_proxy session cookie
# 4. Redirect to /oauth2/start if no valid cookie found
# =============================================================================
apiVersion: batch/v1
kind: CronJob
metadata:
  name: apisix-oauth2-plugin-applicator
  namespace: apisix
spec:
  schedule: "*/2 * * * *"  # Every 2 minutes
  concurrencyPolicy: Replace
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 90
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: oauth2-plugin-applicator
        spec:
          restartPolicy: Never
          serviceAccountName: oauth2-httproute-reader
          containers:
            - name: plugin-applicator
              image: bitnami/kubectl:latest
              env:
                - name: APISIX_ADMIN_URL
                  value: "http://apisix-admin.apisix.svc:9180"
                - name: APISIX_ADMIN_KEY
                  valueFrom:
                    secretKeyRef:
                      name: apisix-admin-credentials
                      key: admin-key
                      optional: true
              command:
                - /bin/bash
                - -c
                - |
                  set -e

                  # Default admin key if secret not available
                  ADMIN_KEY="${APISIX_ADMIN_KEY:-edd1c9f034335f136f87ad84b625c8f1}"

                  echo "=== OAuth2 Forward Auth Global Rule Manager ==="

                  # Discover all HTTPRoutes with oauth2-protected=true label
                  echo "Discovering OAuth2-protected HTTPRoutes..."
                  HOSTS=$(kubectl get httproutes -A -l oauth2-protected=true \
                    -o jsonpath='{range .items[*]}{.spec.hostnames[0]}{" "}{end}' 2>/dev/null | xargs)

                  if [ -z "$HOSTS" ]; then
                    echo "No OAuth2-protected HTTPRoutes found"
                    echo "Removing global rule if exists..."
                    curl -s -X DELETE "${APISIX_ADMIN_URL}/apisix/admin/global_rules/oauth2-forward-auth" \
                      -H "X-API-KEY: ${ADMIN_KEY}" 2>/dev/null || true
                    echo "=== Complete (no protected hosts) ==="
                    exit 0
                  fi

                  echo "Discovered protected hosts: $HOSTS"

                  # Build Lua table for protected hosts (with escaped quotes for JSON)
                  PROTECTED_LUA=""
                  for HOST in $HOSTS; do
                    [ -z "$HOST" ] && continue
                    PROTECTED_LUA="${PROTECTED_LUA}[\\\"${HOST}\\\"]=true,"
                  done
                  echo "Lua table: {${PROTECTED_LUA}}"

                  # Create Global Rule with serverless-pre-function for OAuth2 auth
                  # This function:
                  # 1. Checks if host is in protected list
                  # 2. Skips /oauth2/* paths (OAuth2 callback)
                  # 3. Checks for _oauth2_proxy session cookie
                  # 4. If no cookie, redirects to /oauth2/start with rd= parameter
                  GLOBAL_RULE='{
                    "plugins": {
                      "serverless-pre-function": {
                        "phase": "access",
                        "functions": [
                          "return function(conf, ctx) local host = ngx.var.host; local protected = {'"${PROTECTED_LUA}"'}; if not protected[host] then return end; if ngx.var.uri:match(\"^/oauth2/\") then return end; local cookie = ngx.var.http_cookie; if cookie and cookie:find(\"_oauth2_proxy=\", 1, true) then return end; ngx.status = 302; local rd = \"https://\" .. host .. ngx.var.request_uri; ngx.header[\"Location\"] = \"/oauth2/start?rd=\" .. ngx.escape_uri(rd); return ngx.exit(302) end"
                        ]
                      }
                    }
                  }'

                  echo "Creating/updating OAuth2 global rule..."
                  RESULT=$(curl -s -X PUT "${APISIX_ADMIN_URL}/apisix/admin/global_rules/oauth2-forward-auth" \
                    -H "X-API-KEY: ${ADMIN_KEY}" \
                    -H "Content-Type: application/json" \
                    -d "${GLOBAL_RULE}")

                  if echo "$RESULT" | grep -q '"serverless-pre-function"'; then
                    echo "✓ Global rule created/updated successfully"
                    echo "Protected hosts: $HOSTS"
                  else
                    echo "✗ Failed to create/update global rule"
                    echo "Response: $RESULT"
                    exit 1
                  fi

                  echo ""
                  echo "=== Complete ==="
