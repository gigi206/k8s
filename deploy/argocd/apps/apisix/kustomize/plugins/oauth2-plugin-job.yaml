---
# =============================================================================
# CronJob - OAuth2 Forward Auth Global Rule Manager
# =============================================================================
# This CronJob creates/maintains an ApisixGlobalRule K8s resource for OAuth2
# authentication. Using a K8s CRD instead of the admin API ensures the rule
# is managed by the Ingress Controller and not deleted during reconciliation.
#
# Dynamic Discovery:
# The CronJob discovers HTTPRoutes with label "oauth2-protected=true" across
# all namespaces and extracts their hostnames to build the protected hosts list.
#
# The Global Rule uses serverless-pre-function to:
# 1. Check if the request host is in the protected list
# 2. Skip /oauth2/* paths (OAuth2 Proxy callback routes)
# 3. Forward request to oauth2-proxy /oauth2/auth to validate session cookie
# 4. If 401 (unauthorized), redirect to /oauth2/start with rd= parameter
# 5. If 200/202 (valid session), allow request to continue
# =============================================================================
apiVersion: batch/v1
kind: CronJob
metadata:
  name: apisix-oauth2-plugin-applicator
  namespace: apisix
spec:
  schedule: "*/2 * * * *"  # Every 2 minutes
  concurrencyPolicy: Replace
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 90
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: oauth2-plugin-applicator
        spec:
          restartPolicy: Never
          serviceAccountName: oauth2-httproute-reader
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: plugin-applicator
              image: alpine/k8s:1.32.0
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop: ["ALL"]
              command:
                - /bin/bash
                - -c
                - |
                  set -e

                  echo "=== OAuth2 Forward Auth Global Rule Manager ==="

                  # Discover all HTTPRoutes with oauth2-protected=true label
                  echo "Discovering OAuth2-protected HTTPRoutes..."
                  HOSTS=$(kubectl get httproutes -A -l oauth2-protected=true \
                    -o jsonpath='{range .items[*]}{.spec.hostnames[0]}{" "}{end}' 2>/dev/null | xargs)

                  if [ -z "$HOSTS" ]; then
                    echo "No OAuth2-protected HTTPRoutes found"
                    echo "Removing global rule if exists..."
                    curl -s -X DELETE \
                      -H "X-API-KEY: edd1c9f034335f136f87ad84b625c8f1" \
                      "http://apisix-admin.apisix.svc:9180/apisix/admin/global_rules/oauth2-forward-auth-manual" || true
                    echo "=== Complete (no protected hosts) ==="
                    exit 0
                  fi

                  echo "Discovered protected hosts: $HOSTS"

                  # Build Lua table for protected hosts
                  PROTECTED_LUA=""
                  for HOST in $HOSTS; do
                    [ -z "$HOST" ] && continue
                    PROTECTED_LUA="${PROTECTED_LUA}[\"${HOST}\"]=true,"
                  done
                  echo "Lua table: {${PROTECTED_LUA}}"

                  # Create the Lua function for serverless-pre-function
                  # This function:
                  # 1. Checks if host is in protected list
                  # 2. Skips /oauth2/* paths (OAuth2 callback)
                  # 3. Forwards auth check to oauth2-proxy /oauth2/auth
                  # 4. If 401, redirects to /oauth2/start with rd= parameter
                  # 5. If 200/202, allows request to continue
                  LUA_FUNCTION='return function(conf, ctx) local host = ngx.var.host; local protected = {'"${PROTECTED_LUA}"'}; if not protected[host] then return end; if ngx.var.uri:match("^/oauth2/") then return end; local http = require("resty.http"); local httpc = http.new(); httpc:set_timeout(5000); local res, err = httpc:request_uri("http://oauth2-proxy.oauth2-proxy.svc:4180/oauth2/auth", {method = "GET", headers = {["Cookie"] = ngx.var.http_cookie or "", ["X-Original-URL"] = "https://" .. host .. ngx.var.request_uri}}); if res and res.status >= 200 and res.status < 300 then return end; ngx.status = 302; local rd = "https://" .. host .. ngx.var.request_uri; ngx.header["Location"] = "/oauth2/start?rd=" .. ngx.escape_uri(rd); return ngx.exit(302) end'

                  # Create global rule directly via APISIX Admin API using jq for proper JSON escaping
                  PAYLOAD=$(jq -n --arg func "${LUA_FUNCTION}" '{plugins: {"serverless-pre-function": {phase: "access", functions: [$func]}}}')
                  curl -s -X PUT \
                    -H "X-API-KEY: edd1c9f034335f136f87ad84b625c8f1" \
                    -H "Content-Type: application/json" \
                    -d "${PAYLOAD}" \
                    "http://apisix-admin.apisix.svc:9180/apisix/admin/global_rules/oauth2-forward-auth-manual"

                  if [ $? -eq 0 ]; then
                    echo "âœ“ ApisixGlobalRule created/updated successfully"
                    echo "Protected hosts: $HOSTS"
                  else
                    echo "âœ— Failed to create/update ApisixGlobalRule"
                    exit 1
                  fi

                  echo ""
                  echo "=== Complete ==="
