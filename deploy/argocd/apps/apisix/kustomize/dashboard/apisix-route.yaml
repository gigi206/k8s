---
# =============================================================================
# ApisixRoute - Embedded APISIX Dashboard with OIDC (Keycloak)
# =============================================================================
# Routes traffic to the embedded APISIX Dashboard (Admin API /ui/).
# Uses openid-connect plugin for Keycloak authentication.
# =============================================================================
apiVersion: apisix.apache.org/v2
kind: ApisixRoute
metadata:
  name: apisix-dashboard
  namespace: apisix
spec:
  ingressClassName: apisix
  http:
    - name: dashboard
      match:
        hosts:
          - apisix.PLACEHOLDER_DOMAIN  # Patched via Kustomize
        paths:
          - /ui/*
          - /apisix/admin/*
      backends:
        - serviceName: apisix-admin
          servicePort: 9180
      plugins:
        - name: openid-connect
          enable: true
          secretRef: apisix-dashboard-oidc-plugin
          config:
            client_id: "apisix-dashboard"
            discovery: "https://keycloak.PLACEHOLDER_DOMAIN/realms/k8s/.well-known/openid-configuration"
            scope: "openid profile email"
            bearer_only: false
            realm: "k8s"
            introspection_endpoint_auth_method: "client_secret_post"
            redirect_uri: "https://apisix.PLACEHOLDER_DOMAIN/ui/callback"
            logout_path: "/ui/logout"
            post_logout_redirect_uri: "https://apisix.PLACEHOLDER_DOMAIN/ui/"
            ssl_verify: true
            ssl_ca_cert_path: /etc/apisix/ssl/ca.crt
            use_pkce: true
            session:
              secret: "SESSION_SECRET_PLACEHOLDER"
        # Inject Admin API Key header for embedded dashboard
        - name: proxy-rewrite
          enable: true
          config:
            headers:
              set:
                X-API-KEY: "ADMIN_KEY_PLACEHOLDER"
    # Redirect root to /ui/
    - name: dashboard-redirect
      match:
        hosts:
          - apisix.PLACEHOLDER_DOMAIN
        paths:
          - /
      plugins:
        - name: redirect
          enable: true
          config:
            uri: /ui/
            ret_code: 302
