---
# =============================================================================
# Job: Generate OIDC Plugin Secret
# =============================================================================
# Creates the apisix-dashboard-oidc-plugin secret with correct key names
# for the openid-connect plugin secretRef.
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: apisix-dashboard-oidc-secret-gen
  namespace: apisix
  annotations:
    # PostSync hook ensures the Job runs AFTER all resources are synced,
    # including the ExternalSecret that creates apisix-dashboard-oidc secret.
    # HookSucceeded policy ensures ArgoCD deletes the Job after success,
    # avoiding conflicts with ttlSecondsAfterFinished.
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 60
  template:
    metadata:
      labels:
        app: apisix-dashboard-oidc-secret-gen
    spec:
      serviceAccountName: apisix-dashboard-secret-gen
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: secret-gen
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          image: bitnami/kubectl:latest
          imagePullPolicy: IfNotPresent
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -e
              echo "=== Generating OIDC Plugin Secret ==="

              # Check if secret already exists
              if kubectl get secret apisix-dashboard-oidc-plugin -n apisix >/dev/null 2>&1; then
                echo "Secret already exists, skipping creation"
                exit 0
              fi

              # Get values from source secret
              CLIENT_SECRET=$(kubectl get secret apisix-dashboard-oidc -n apisix -o jsonpath='{.data.client-secret}' | base64 -d)
              SESSION_SECRET=$(kubectl get secret apisix-dashboard-oidc -n apisix -o jsonpath='{.data.session-secret}' | base64 -d)

              if [ -z "$CLIENT_SECRET" ] || [ -z "$SESSION_SECRET" ]; then
                echo "ERROR: Could not retrieve secrets"
                exit 1
              fi

              # Create secret with correct key names for secretRef
              kubectl create secret generic apisix-dashboard-oidc-plugin \
                --from-literal=client_secret="$CLIENT_SECRET" \
                --from-literal=session.secret="$SESSION_SECRET" \
                -n apisix

              echo "=== Secret created successfully ==="
