---
# =============================================================================
# Job: Generate OIDC Plugin Secret
# =============================================================================
# Creates the apisix-dashboard-oidc-plugin secret with correct key names
# for the openid-connect plugin secretRef.
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: apisix-dashboard-oidc-secret-gen
  namespace: apisix
  annotations:
    # NOTE: This was changed from PreSync hook to Sync with sync-wave
    # because the source secret (apisix-dashboard-oidc) is created by
    # ExternalSecret which runs during Sync phase, not before.
    # The sync-wave ensures this Job runs AFTER the ExternalSecret creates the secret.
    argocd.argoproj.io/sync-wave: "5"
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 60
  template:
    metadata:
      labels:
        app: apisix-dashboard-oidc-secret-gen
    spec:
      serviceAccountName: apisix-dashboard-secret-gen
      restartPolicy: OnFailure
      containers:
        - name: secret-gen
          image: bitnami/kubectl:latest
          imagePullPolicy: IfNotPresent
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -e
              echo "=== Generating OIDC Plugin Secret ==="

              # Check if secret already exists
              if kubectl get secret apisix-dashboard-oidc-plugin -n apisix >/dev/null 2>&1; then
                echo "Secret already exists, skipping creation"
                exit 0
              fi

              # Get values from source secret
              CLIENT_SECRET=$(kubectl get secret apisix-dashboard-oidc -n apisix -o jsonpath='{.data.client-secret}' | base64 -d)
              SESSION_SECRET=$(kubectl get secret apisix-dashboard-oidc -n apisix -o jsonpath='{.data.session-secret}' | base64 -d)

              if [ -z "$CLIENT_SECRET" ] || [ -z "$SESSION_SECRET" ]; then
                echo "ERROR: Could not retrieve secrets"
                exit 1
              fi

              # Create secret with correct key names for secretRef
              kubectl create secret generic apisix-dashboard-oidc-plugin \
                --from-literal=client_secret="$CLIENT_SECRET" \
                --from-literal=session.secret="$SESSION_SECRET" \
                -n apisix

              echo "=== Secret created successfully ==="
