---
# =============================================================================
# Job - Patch Dashboard ConfigMap with Secrets
# =============================================================================
# This Job patches the apisix-dashboard ConfigMap to inject authentication
# credentials from the SOPS-encrypted Secret.
#
# Why this approach:
# - The apisix-dashboard Helm chart doesn't support existingSecret for auth
# - Credentials must be in a ConfigMap, not a Secret
# - We use SOPS to encrypt credentials in Git, then inject them post-install
#
# Note: These credentials are never actually used because OIDC (via APISIX
# openid-connect plugin) blocks unauthenticated requests before they reach
# the dashboard. This is purely for chart compatibility.
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: apisix-dashboard-configmap-patch
  namespace: apisix
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: apisix-dashboard-configmap-patcher
      containers:
        - name: patch-configmap
          image: bitnami/kubectl:latest
          env:
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: apisix-dashboard-auth
                  key: jwt-secret
            - name: ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: apisix-dashboard-auth
                  key: admin-password
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -e
              echo "=== Patching APISIX Dashboard ConfigMap with secrets ==="

              # Wait for ConfigMap to exist
              echo "Waiting for ConfigMap apisix-dashboard to be created..."
              MAX_RETRIES=30
              RETRY_COUNT=0
              until kubectl get configmap apisix-dashboard -n apisix > /dev/null 2>&1; do
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
                  echo "ERROR: ConfigMap not found after ${MAX_RETRIES} attempts"
                  exit 1
                fi
                echo "ConfigMap not ready, waiting 2s... (attempt ${RETRY_COUNT}/${MAX_RETRIES})"
                sleep 2
              done
              echo "ConfigMap found!"

              # Get current config
              echo "Reading current configuration..."
              kubectl get configmap apisix-dashboard -n apisix -o jsonpath='{.data.conf\.yaml}' > /tmp/conf.yaml

              # Update authentication section using sed
              echo "Injecting secrets into configuration..."

              # Replace the secret value
              sed -i "s/secret:.*/secret: \"${JWT_SECRET}\"/" /tmp/conf.yaml

              # Replace the password value (handles both quoted and unquoted)
              sed -i "s/password:.*/password: \"${ADMIN_PASSWORD}\"/" /tmp/conf.yaml

              # Patch the ConfigMap
              echo "Applying patched configuration..."
              kubectl create configmap apisix-dashboard-patched \
                --from-file=conf.yaml=/tmp/conf.yaml \
                -n apisix \
                --dry-run=client -o yaml | \
                kubectl patch configmap apisix-dashboard -n apisix --patch-file=/dev/stdin --type=merge

              # Restart the dashboard to pick up new config
              echo "Restarting dashboard deployment..."
              kubectl rollout restart deployment/apisix-dashboard -n apisix

              echo "=== ConfigMap patched successfully ==="
---
# ServiceAccount for the Job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: apisix-dashboard-configmap-patcher
  namespace: apisix
---
# Role to patch ConfigMap and restart Deployment
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: apisix-dashboard-configmap-patcher
  namespace: apisix
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "patch", "create"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "patch"]
---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: apisix-dashboard-configmap-patcher
  namespace: apisix
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: apisix-dashboard-configmap-patcher
subjects:
  - kind: ServiceAccount
    name: apisix-dashboard-configmap-patcher
    namespace: apisix
