---
# =============================================================================
# ApisixRoute - Hubble UI
# =============================================================================
# Routes traffic to Hubble UI (Cilium observability)
# Includes OAuth2 proxy route for authentication
# =============================================================================
apiVersion: apisix.apache.org/v2
kind: ApisixRoute
metadata:
  name: hubble-ui
  namespace: kube-system
spec:
  ingressClassName: apisix
  http:
    # Route /oauth2/* to OAuth2 Proxy for authentication flow
    - name: hubble-oauth2
      match:
        hosts:
          - hubble.PLACEHOLDER_DOMAIN  # Patched via Kustomize from common.domain
        paths:
          - /oauth2/*
      backends:
        - serviceName: oauth2-proxy
          servicePort: 4180
          resolveGranularity: service
      plugins:
        - name: proxy-rewrite
          enable: true
          config:
            regex_uri: ["^/oauth2/(.*)", "/$1"]
    # Route all other traffic to Hubble UI
    - name: hubble-ui
      match:
        hosts:
          - hubble.PLACEHOLDER_DOMAIN
        paths:
          - /*
      backends:
        - serviceName: hubble-ui
          servicePort: 80
