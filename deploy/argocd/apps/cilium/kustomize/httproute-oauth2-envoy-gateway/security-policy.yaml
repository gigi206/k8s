---
# =============================================================================
# SecurityPolicy - OIDC Authentication (Envoy Gateway)
# =============================================================================
# Protects Hubble UI using Envoy Gateway's native OIDC.
# Automatically redirects unauthenticated users to Keycloak for login.
#
# Security: FAIL-CLOSE by default - if OIDC provider is unavailable, access is DENIED.
# Retry policy configured for transient failures.
#
# Requirements:
# - Backend 'backend-keycloak' for TLS connection to Keycloak
# - Secret 'oidc-client-secret' with key 'client-secret' in kube-system namespace
# - Keycloak client 'oauth2-proxy' with redirect URIs configured
# =============================================================================
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: oidc-hubble
  namespace: kube-system
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: hubble-ui
  oidc:
    provider:
      backendRefs:
      - group: gateway.envoyproxy.io
        kind: Backend
        name: backend-keycloak
        port: 443
      issuer: "https://keycloak.PLACEHOLDER.example.com/realms/k8s"  # Patched via Kustomize
      authorizationEndpoint: "https://keycloak.PLACEHOLDER.example.com/realms/k8s/protocol/openid-connect/auth"
      tokenEndpoint: "https://keycloak.PLACEHOLDER.example.com/realms/k8s/protocol/openid-connect/token"
      # Retry policy for transient OIDC provider failures
      backendSettings:
        retry:
          numRetries: 3
          perRetry:
            backOff:
              baseInterval: 500ms
              maxInterval: 5s
            timeout: 5s
          retryOn:
            triggers: ["5xx", "gateway-error", "reset", "connect-failure"]
    clientID: "oauth2-proxy"
    clientSecret:
      name: "oidc-client-secret"
    redirectURL: "https://hubble.PLACEHOLDER.example.com/oauth2/callback"  # Patched via Kustomize
    logoutPath: "/oauth2/sign_out"
