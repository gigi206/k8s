---
# =============================================================================
# CiliumClusterwideNetworkPolicy - Default Deny Pod Ingress (Zero Trust)
# =============================================================================
# This policy implements Zero Trust networking by blocking ALL pod-to-pod
# ingress traffic by default. Only explicitly allowed traffic passes.
#
# BASELINE ALLOWS (minimal for cluster operation):
# - Health probes from kubelet (host)
# - Traffic from kube-system (DNS, metrics-server, CNI)
#
# EXCLUDED FROM THIS POLICY:
# - kube-system pods: Critical system components remain unrestricted
#
# ALL OTHER INGRESS IS BLOCKED BY DEFAULT.
#
# Each application must define its own CiliumNetworkPolicy to allow:
# - Intra-namespace traffic (pods talking to each other)
# - Cross-namespace traffic (monitoring, mesh, etc.)
#
# Example per-app policy:
#   deploy/argocd/apps/<app>/resources/cilium-ingress-policy.yaml
#
# WARNING: Applications without ingress policies will be isolated!
# =============================================================================

apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: default-deny-pod-ingress
spec:
  description: "Default deny all pod ingress (Zero Trust) - baseline allows only"

  # Apply to ALL real pods EXCEPT those in kube-system and cilium-spire
  # kube-system must remain unrestricted for DNS, CNI, metrics-server
  # cilium-spire must remain unrestricted: SPIRE is critical infrastructure
  # for mutual auth. If cilium-spire-ingress CiliumNetworkPolicy isn't synced
  # yet (ArgoCD timing), SPIRE server becomes unreachable, breaking all
  # pod-to-pod traffic that requires authentication.
  #
  # IMPORTANT: The "Exists" expression is required to exclude Cilium's
  # internal pseudo-endpoints (e.g., Gateway API endpoint 0) which have
  # NO labels. Without it, "NotIn: [kube-system]" matches any endpoint
  # missing the namespace label, causing the cilium.l7policy filter to
  # enforce default-deny on the Gateway listener (403 "Access denied").
  endpointSelector:
    matchExpressions:
      - key: io.kubernetes.pod.namespace
        operator: Exists
      - key: io.kubernetes.pod.namespace
        operator: NotIn
        values:
          - kube-system
          - cilium-spire

  ingress:
    # Rule 1: Allow health checks from kubelet (liveness/readiness probes)
    # Without this, all pods would fail health checks and restart
    - fromEntities:
        - host

    # Rule 2: Allow from kube-system (essential cluster services)
    # - CoreDNS: DNS resolution for all pods
    # - metrics-server: kubectl top, HPA
    # - Cilium: CNI networking
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system

    # Rule 3: Allow from Gateway API / Ingress proxy (reserved:ingress identity)
    # Traffic processed by Gateway API (Cilium, Traefik, etc.) uses the
    # reserved:ingress identity (8), NOT a kube-system pod identity.
    # Without this rule, ALL traffic through the Gateway is denied with 403
    # "Access denied" by Cilium's L7 policy filter (cilium.l7policy).
    # See: https://github.com/cilium/cilium/issues/36509
    - fromEntities:
        - ingress

    # Rule 4: Allow ICMP error messages from cluster-internal sources
    # Without this, ICMP DestinationUnreachable (type 3) and TimeExceeded
    # (type 11) from DNS responses are silently dropped, polluting Hubble
    # logs. These ICMP errors are essential for path MTU discovery and
    # proper UDP/DNS error handling.
    - fromEntities:
        - cluster
      icmps:
        - fields:
            - type: 3       # Destination Unreachable
              family: IPv4
            - type: 11      # Time Exceeded
              family: IPv4
            - type: 1       # Destination Unreachable (IPv6)
              family: IPv6
            - type: 3       # Time Exceeded (IPv6)
              family: IPv6

    # NO OTHER RULES = ALL OTHER INGRESS DENIED
    # Per-app CiliumNetworkPolicy must explicitly allow:
    # - Same namespace: fromEndpoints with io.kubernetes.pod.namespace: <ns>
    # - Cross namespace: fromEndpoints with specific namespace labels
    # - Specific ports: toPorts with port numbers
