---
# =============================================================================
# External-DNS ApplicationSet - Wave 45 (DNS Automation)
# =============================================================================
# Déploie External-DNS pour synchroniser les Ingress/Services avec un provider DNS
# Wave 45: Après Gateway API (15) et Istio (40) pour accéder aux CRDs
# Docs: https://github.com/kubernetes-sigs/external-dns
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: external-dns
  namespace: argo-cd
  annotations:
    argocd.argoproj.io/sync-wave: "45"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Config de base (valeurs par défaut)
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # Config spécifique à l'application
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/external-dns/config/*.yaml

  template:
    metadata:
      name: external-dns
      namespace: argo-cd
      annotations:
        argocd.argoproj.io/sync-wave: "45"
    spec:
      project: default

      destination:
        server: https://kubernetes.default.svc
        namespace: external-dns

      syncPolicy:
        retry:
          limit: 10
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 10m

  templatePatch: |
    spec:
      {{- if eq .externalDns.provider "coredns" }}
      {{- if .externalDns.coredns.enabled }}
      sources:
      {{- $sources := list }}
      {{- if .features.cilium.ingressPolicy.enabled }}
      {{- $sources = append $sources (dict "repoURL" "https://github.com/gigi206/k8s" "targetRevision" .git.revision "path" "deploy/argocd/apps/external-dns/resources" "directory" (dict "include" "cilium-host-ingress-policy.yaml")) }}
      {{- $sources = append $sources (dict "repoURL" "https://github.com/gigi206/k8s" "targetRevision" .git.revision "path" "deploy/argocd/apps/external-dns/resources" "directory" (dict "include" "cilium-ingress-policy.yaml")) }}
      {{- end }}
      {{- $sources = append $sources (dict "repoURL" "https://kubernetes-sigs.github.io/external-dns" "targetRevision" .externalDns.versions.chart "chart" "external-dns" "helm" (dict "valuesObject" (dict "interval" .externalDns.interval "provider" (dict "name" "coredns") "sources" .externalDns.sources "env" (list (dict "name" "ETCD_URLS" "value" "http://external-dns-etcd:2379")) "initContainers" (list (dict "name" "wait-for-etcd" "image" "busybox:1.36" "command" (list "sh" "-c" "echo 'Waiting for etcd...'; until nc -z external-dns-etcd 2379; do echo 'Waiting for etcd...'; sleep 2; done; echo 'etcd is ready!'") "securityContext" (dict "runAsNonRoot" true "runAsUser" 65534)))))) }}
      {{- $corednsParams := list (dict "name" "replicaCount" "value" (toString (.externalDns.coredns.replicas | default 1))) (dict "name" "serviceType" "value" (.externalDns.coredns.serviceType | default "ClusterIP")) (dict "name" "rbac.create" "value" "true") (dict "name" "isClusterService" "value" "false") }}
      {{- if and .externalDns.coredns (hasKey .externalDns.coredns "loadBalancerIP") }}
      {{- $corednsParams = append $corednsParams (dict "name" "service.loadBalancerIP" "value" .externalDns.coredns.loadBalancerIP) }}
      {{- $corednsParams = append $corednsParams (dict "name" "service.annotations.metallb\\.universe\\.tf/address-pool" "value" "external-dns") }}
      {{- end }}
      {{- $corednsParams = concat $corednsParams (list (dict "name" "servers[0].zones[0].zone" "value" (printf "%s." .common.domain)) (dict "name" "servers[0].port" "value" "53") (dict "name" "servers[0].plugins[0].name" "value" "errors") (dict "name" "servers[0].plugins[1].name" "value" "health") (dict "name" "servers[0].plugins[1].configBlock" "value" "lameduck 5s") (dict "name" "servers[0].plugins[2].name" "value" "ready") (dict "name" "servers[0].plugins[3].name" "value" "prometheus") (dict "name" "servers[0].plugins[3].parameters" "value" "0.0.0.0:9153") (dict "name" "servers[0].plugins[4].name" "value" "cache") (dict "name" "servers[0].plugins[4].parameters" "value" "30") (dict "name" "servers[0].plugins[5].name" "value" "loop") (dict "name" "servers[0].plugins[6].name" "value" "reload") (dict "name" "servers[0].plugins[7].name" "value" "loadbalance") (dict "name" "servers[0].plugins[8].name" "value" "etcd") (dict "name" "servers[0].plugins[8].parameters" "value" .common.domain) (dict "name" "servers[0].plugins[8].configBlock" "value" "path /skydns\nendpoint http://external-dns-etcd:2379")) }}
      {{- $sources = append $sources (dict "repoURL" "https://coredns.github.io/helm" "chart" "coredns" "targetRevision" .externalDns.versions.coredns "helm" (dict "parameters" $corednsParams)) }}
      {{- if .externalDns.etcd.enabled }}
      {{- $sources = append $sources (dict "repoURL" "https://groundhog2k.github.io/helm-charts" "chart" "etcd" "targetRevision" .externalDns.versions.etcd "helm" (dict "parameters" (list (dict "name" "fullnameOverride" "value" "external-dns-etcd") (dict "name" "replicas" "value" (toString (.externalDns.etcd.replicas | default 1)))))) }}
      {{- end }}
      {{- if .features.monitoring.enabled }}
      {{- $sources = append $sources (dict "repoURL" "https://github.com/gigi206/k8s" "targetRevision" .git.revision "path" "deploy/argocd/apps/external-dns/kustomize/monitoring/services") }}
      {{- $sources = append $sources (dict "repoURL" "https://github.com/gigi206/k8s" "targetRevision" .git.revision "path" "deploy/argocd/apps/external-dns/kustomize/monitoring/monitors" "kustomize" (dict "commonLabels" (dict "release" .features.monitoring.release))) }}
      {{- end }}
      {{- toYaml $sources | nindent 4 }}
      {{- else }}
      sources:
      {{- $sources := list }}
      {{- if .features.cilium.ingressPolicy.enabled }}
      {{- $sources = append $sources (dict "repoURL" "https://github.com/gigi206/k8s" "targetRevision" .git.revision "path" "deploy/argocd/apps/external-dns/resources" "directory" (dict "include" "cilium-host-ingress-policy.yaml")) }}
      {{- $sources = append $sources (dict "repoURL" "https://github.com/gigi206/k8s" "targetRevision" .git.revision "path" "deploy/argocd/apps/external-dns/resources" "directory" (dict "include" "cilium-ingress-policy.yaml")) }}
      {{- end }}
      {{- $sources = append $sources (dict "repoURL" "https://kubernetes-sigs.github.io/external-dns" "targetRevision" .externalDns.versions.chart "chart" "external-dns" "helm" (dict "parameters" (list (dict "name" "provider.name" "value" (.externalDns.provider | default "cloudflare")) (dict "name" "txtOwnerId" "value" (.externalDns.txtOwnerId | default "k8s-test")) (dict "name" "policy" "value" (.externalDns.policy | default "sync")) (dict "name" "interval" "value" (.externalDns.interval | default "15s")) (dict "name" "rbac.create" "value" (toString (.externalDns.rbac.create | default true))) (dict "name" "crd.create" "value" (toString (.externalDns.crd.create | default true))) (dict "name" "domainFilters[0]" "value" .common.domain)))) }}
      {{- if .features.monitoring.enabled }}
      {{- $sources = append $sources (dict "repoURL" "https://github.com/gigi206/k8s" "targetRevision" .git.revision "path" "deploy/argocd/apps/external-dns/kustomize/monitoring/services") }}
      {{- $sources = append $sources (dict "repoURL" "https://github.com/gigi206/k8s" "targetRevision" .git.revision "path" "deploy/argocd/apps/external-dns/kustomize/monitoring/monitors" "kustomize" (dict "commonLabels" (dict "release" .features.monitoring.release))) }}
      {{- end }}
      {{- toYaml $sources | nindent 4 }}
      {{- end }}
      {{- else }}
      sources:
      {{- $sources := list }}
      {{- if .features.cilium.ingressPolicy.enabled }}
      {{- $sources = append $sources (dict "repoURL" "https://github.com/gigi206/k8s" "targetRevision" .git.revision "path" "deploy/argocd/apps/external-dns/resources" "directory" (dict "include" "cilium-host-ingress-policy.yaml")) }}
      {{- $sources = append $sources (dict "repoURL" "https://github.com/gigi206/k8s" "targetRevision" .git.revision "path" "deploy/argocd/apps/external-dns/resources" "directory" (dict "include" "cilium-ingress-policy.yaml")) }}
      {{- end }}
      {{- $sources = append $sources (dict "repoURL" "https://kubernetes-sigs.github.io/external-dns" "targetRevision" .externalDns.versions.chart "chart" "external-dns" "helm" (dict "parameters" (list (dict "name" "provider.name" "value" (.externalDns.provider | default "cloudflare")) (dict "name" "txtOwnerId" "value" (.externalDns.txtOwnerId | default "k8s-test")) (dict "name" "policy" "value" (.externalDns.policy | default "sync")) (dict "name" "interval" "value" (.externalDns.interval | default "15s")) (dict "name" "rbac.create" "value" (toString (.externalDns.rbac.create | default true))) (dict "name" "crd.create" "value" (toString (.externalDns.crd.create | default true))) (dict "name" "domainFilters[0]" "value" .common.domain)))) }}
      {{- if .features.monitoring.enabled }}
      {{- $sources = append $sources (dict "repoURL" "https://github.com/gigi206/k8s" "targetRevision" .git.revision "path" "deploy/argocd/apps/external-dns/kustomize/monitoring/services") }}
      {{- $sources = append $sources (dict "repoURL" "https://github.com/gigi206/k8s" "targetRevision" .git.revision "path" "deploy/argocd/apps/external-dns/kustomize/monitoring/monitors" "kustomize" (dict "commonLabels" (dict "release" .features.monitoring.release))) }}
      {{- end }}
      {{- toYaml $sources | nindent 4 }}
      {{- end }}
      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
        - {{ . }}
        {{- end }}
      {{- if not .features.externalDns.enabled }}
        automated: null
      {{- else if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
