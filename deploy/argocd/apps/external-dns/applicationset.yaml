---
# =============================================================================
# External-DNS ApplicationSet - Wave 45 (DNS Automation)
# =============================================================================
# Déploie External-DNS pour synchroniser les Ingress/Services avec un provider DNS
# Wave 45: Après Gateway API (15) et Istio (40) pour accéder aux CRDs
# Docs: https://github.com/kubernetes-sigs/external-dns
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: external-dns
  namespace: argo-cd
  annotations:
    argocd.argoproj.io/sync-wave: "45"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Config de base (valeurs par défaut)
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # Config spécifique à l'application
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/external-dns/config/*.yaml

  template:
    metadata:
      name: external-dns
      namespace: argo-cd
      annotations:
        argocd.argoproj.io/sync-wave: "45"
    spec:
      project: default

      destination:
        server: https://kubernetes.default.svc
        namespace: external-dns

      syncPolicy:
        retry:
          limit: 10
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 10m

  templatePatch: |
    spec:
      # Ignore fields set by API server but not in Helm charts
      ignoreDifferences:
        - group: apps
          kind: StatefulSet
          name: external-dns-etcd
          jqPathExpressions:
            - .spec.persistentVolumeClaimRetentionPolicy
            - .spec.volumeClaimTemplates
            - .status
      sources:
        {{- /* Cilium policies - common to all providers */ -}}
        {{- if .features.cilium.ingressPolicy.enabled }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/external-dns/resources
          directory:
            include: "cilium-host-ingress-policy.yaml"
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/external-dns/resources
          directory:
            include: "cilium-ingress-policy.yaml"
        {{- if .externalDns.etcd.enabled }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/external-dns/resources
          directory:
            include: "cilium-etcd-policy.yaml"
        {{- end }}
        {{- end }}
        {{- if .features.kyverno.enabled }}
        # Source: Kyverno PolicyException (allows SA token mount for K8s API access)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/external-dns/resources
          directory:
            include: "kyverno-policy-exception.yaml"
        {{- end }}

        {{- /* TLS Certificates for etcd mTLS (server, client, peer) */ -}}
        {{- if and .externalDns.etcd.enabled .externalDns.etcd.tls.enabled }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/external-dns/kustomize/etcd-tls
        {{- end }}

        {{- /* CoreDNS mode with etcd backend */ -}}
        {{- if and (eq .externalDns.provider "coredns") .externalDns.coredns.enabled }}
        # External-DNS configured for CoreDNS
        - repoURL: https://kubernetes-sigs.github.io/external-dns
          targetRevision: '{{ .externalDns.version }}'
          chart: external-dns
          helm:
            valuesObject:
              interval: '{{ .externalDns.interval }}'
              provider:
                name: coredns
              sources:
              {{- range .externalDns.sources }}
                - {{ . }}
              {{- end }}
              {{- if and .features.gatewayAPI.enabled (eq .features.gatewayAPI.controller.provider "istio") }}
                - istio-gateway
              {{- end }}
              env:
                - name: ETCD_URLS
                  {{- if .externalDns.etcd.tls.enabled }}
                  value: "https://external-dns-etcd:2379"
                {{- else }}
                  value: "http://external-dns-etcd:2379"
                {{- end }}
                {{- if .externalDns.etcd.tls.enabled }}
                - name: ETCD_CA_FILE
                  value: "/etc/etcd/certs/ca/ca.crt"
                - name: ETCD_CERT_FILE
                  value: "/etc/etcd/certs/client/tls.crt"
                - name: ETCD_KEY_FILE
                  value: "/etc/etcd/certs/client/tls.key"
                {{- end }}
              {{- if .externalDns.etcd.tls.enabled }}
              extraVolumes:
                - name: etcd-ca
                  secret:
                    secretName: {{ .externalDns.etcd.tls.caSecret }}
                - name: etcd-client-tls
                  secret:
                    secretName: {{ .externalDns.etcd.tls.clientSecret }}
              extraVolumeMounts:
                - name: etcd-ca
                  mountPath: /etc/etcd/certs/ca
                  readOnly: true
                - name: etcd-client-tls
                  mountPath: /etc/etcd/certs/client
                  readOnly: true
              {{- end }}
              {{- if .externalDns.resources }}
              resources:
                requests:
                  cpu: '{{ .externalDns.resources.requests.cpu }}'
                  memory: '{{ .externalDns.resources.requests.memory }}'
                limits:
                  cpu: '{{ .externalDns.resources.limits.cpu }}'
                  memory: '{{ .externalDns.resources.limits.memory }}'
              {{- end }}
              initContainers:
                - name: wait-for-etcd
                  image: busybox:1.36
                  {{- if .externalDns.etcd.tls.enabled }}
                  command: ["sh", "-c", "echo 'Waiting for etcd TLS...'; until nc -z external-dns-etcd 2379; do sleep 2; done; echo 'etcd ready!'"]
                  {{- else }}
                  command: ["sh", "-c", "echo 'Waiting for etcd...'; until nc -z external-dns-etcd 2379; do echo 'Waiting for etcd...'; sleep 2; done; echo 'etcd is ready!'"]
                  {{- end }}
                  securityContext:
                    runAsNonRoot: true
                    runAsUser: 65534
                    allowPrivilegeEscalation: false
                    readOnlyRootFilesystem: true
                    capabilities:
                      drop: ["ALL"]
                    seccompProfile:
                      type: RuntimeDefault
                  {{- if .externalDns.waitForEtcd }}
                  {{- if .externalDns.waitForEtcd.resources }}
                  resources:
                    requests:
                      cpu: '{{ .externalDns.waitForEtcd.resources.requests.cpu }}'
                      memory: '{{ .externalDns.waitForEtcd.resources.requests.memory }}'
                    limits:
                      cpu: '{{ .externalDns.waitForEtcd.resources.limits.cpu }}'
                      memory: '{{ .externalDns.waitForEtcd.resources.limits.memory }}'
                  {{- end }}
                  {{- end }}
        # CoreDNS server
        - repoURL: https://coredns.github.io/helm
          targetRevision: '{{ .externalDns.coredns.version }}'
          chart: coredns
          helm:
            valuesObject:
              replicaCount: {{ .externalDns.coredns.replicas | default 1 }}
              serviceType: '{{ .externalDns.coredns.serviceType | default "ClusterIP" }}'
              rbac:
                create: true
              isClusterService: false
              # PSA restricted compatibility
              podSecurityContext:
                runAsNonRoot: true
                runAsUser: 1000
                runAsGroup: 1000
                fsGroup: 1000
                seccompProfile:
                  type: RuntimeDefault
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop: ["ALL"]
                readOnlyRootFilesystem: true
              {{- if .features.externalDns.loadBalancerIP }}
              service:
                loadBalancerIP: '{{ .features.externalDns.loadBalancerIP }}'
                annotations:
                  metallb.universe.tf/address-pool: external-dns
              {{- end }}
              {{- if .externalDns.coredns.resources }}
              resources:
                requests:
                  cpu: '{{ .externalDns.coredns.resources.requests.cpu }}'
                  memory: '{{ .externalDns.coredns.resources.requests.memory }}'
                limits:
                  cpu: '{{ .externalDns.coredns.resources.limits.cpu }}'
                  memory: '{{ .externalDns.coredns.resources.limits.memory }}'
              {{- end }}
              {{- if .externalDns.etcd.tls.enabled }}
              extraVolumes:
                - name: etcd-ca
                  secret:
                    secretName: {{ .externalDns.etcd.tls.caSecret }}
                - name: etcd-client-tls
                  secret:
                    secretName: {{ .externalDns.etcd.tls.clientSecret }}
              extraVolumeMounts:
                - name: etcd-ca
                  mountPath: /etc/etcd/certs/ca
                  readOnly: true
                - name: etcd-client-tls
                  mountPath: /etc/etcd/certs/client
                  readOnly: true
              {{- end }}
              servers:
                - zones:
                    - zone: '{{ .common.domain }}.'
                  port: 53
                  plugins:
                    - name: errors
                    - name: health
                      configBlock: "lameduck 5s"
                    - name: ready
                    - name: prometheus
                      parameters: "0.0.0.0:9153"
                    - name: cache
                      parameters: "30"
                    - name: loop
                    - name: reload
                    - name: loadbalance
                    - name: etcd
                      parameters: '{{ .common.domain }}'
                      {{- if .externalDns.etcd.tls.enabled }}
                      configBlock: |
                        path /skydns
                        endpoint https://external-dns-etcd:2379
                        tls /etc/etcd/certs/client/tls.crt /etc/etcd/certs/client/tls.key /etc/etcd/certs/ca/ca.crt
                      {{- else }}
                      configBlock: |
                        path /skydns
                        endpoint http://external-dns-etcd:2379
                      {{- end }}
        {{- if .externalDns.etcd.enabled }}
        # etcd backend for CoreDNS (CloudPirates OCI - quay.io/coreos/etcd)
        - repoURL: ghcr.io/cloudpirates-io/helm-charts
          targetRevision: '{{ .externalDns.etcd.version }}'
          chart: etcd
          helm:
            releaseName: external-dns-etcd
            valuesObject:
              fullnameOverride: external-dns-etcd
              replicaCount: {{ .externalDns.etcd.replicas | default 1 }}
              # PSA restricted compatibility
              podSecurityContext:
                runAsNonRoot: true
                runAsUser: 1000
                runAsGroup: 1000
                fsGroup: 1000
                seccompProfile:
                  type: RuntimeDefault
              containerSecurityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop: ["ALL"]
                readOnlyRootFilesystem: false
              {{- if .externalDns.etcd.resources }}
              resources:
                requests:
                  cpu: '{{ .externalDns.etcd.resources.requests.cpu }}'
                  memory: '{{ .externalDns.etcd.resources.requests.memory }}'
                limits:
                  cpu: '{{ .externalDns.etcd.resources.limits.cpu }}'
                  memory: '{{ .externalDns.etcd.resources.limits.memory }}'
              {{- end }}
              {{- if .externalDns.etcd.tls.enabled }}
              # mTLS configuration (CloudPirates etcd chart structure)
              auth:
                enabled: true
                existingSecret: {{ .externalDns.etcd.tls.serverSecret }}
                peer:
                  enabled: true
                  existingSecret: {{ .externalDns.etcd.tls.peerSecret }}
              {{- end }}
        {{- end }}

        {{- /* Standard provider mode (cloudflare, etc.) */ -}}
        {{- else }}
        # External-DNS with standard provider
        - repoURL: https://kubernetes-sigs.github.io/external-dns
          targetRevision: '{{ .externalDns.version }}'
          chart: external-dns
          helm:
            valuesObject:
              provider:
                name: '{{ .externalDns.provider | default "cloudflare" }}'
              txtOwnerId: '{{ .externalDns.txtOwnerId | default "k8s-test" }}'
              policy: '{{ .externalDns.policy | default "sync" }}'
              interval: '{{ .externalDns.interval | default "15s" }}'
              rbac:
                create: {{ .externalDns.rbac.create | default true }}
              crd:
                create: {{ .externalDns.crd.create | default true }}
              domainFilters:
                - '{{ .common.domain }}'
              sources:
              {{- range .externalDns.sources }}
                - {{ . }}
              {{- end }}
              {{- if and .features.gatewayAPI.enabled (eq .features.gatewayAPI.controller.provider "istio") }}
                - istio-gateway
              {{- end }}
        {{- end }}

        {{- /* Monitoring - common to all providers */ -}}
        {{- if .features.monitoring.enabled }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/external-dns/kustomize/monitoring/services
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/external-dns/kustomize/monitoring/monitors
          kustomize:
            commonLabels:
              release: '{{ .features.monitoring.release }}'
        {{- end }}

      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
        - {{ . }}
        {{- end }}
      {{- if not .features.externalDns.enabled }}
        automated: null
      {{- else if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
