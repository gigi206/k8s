---
# =============================================================================
# External-DNS ApplicationSet - Wave 45 (DNS Automation)
# =============================================================================
# Déploie External-DNS pour synchroniser les Ingress/Services avec un provider DNS
# Wave 45: Après Gateway API (15) et Istio (40) pour accéder aux CRDs
# Docs: https://github.com/kubernetes-sigs/external-dns
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: external-dns
  namespace: argo-cd
  annotations:
    argocd.argoproj.io/sync-wave: "45"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Config de base (valeurs par défaut)
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # Config spécifique à l'application
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/external-dns/config/*.yaml

  template:
    metadata:
      name: external-dns
      namespace: argo-cd
      annotations:
        argocd.argoproj.io/sync-wave: "45"
    spec:
      project: default

      destination:
        server: https://kubernetes.default.svc
        namespace: external-dns

      syncPolicy:
        retry:
          limit: 10
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 10m

  templatePatch: |
    spec:
      sources:
        {{- /* Cilium policies - common to all providers */ -}}
        {{- if .features.cilium.ingressPolicy.enabled }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/external-dns/resources
          directory:
            include: "cilium-host-ingress-policy.yaml"
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/external-dns/resources
          directory:
            include: "cilium-ingress-policy.yaml"
        {{- end }}

        {{- /* CoreDNS mode with etcd backend */ -}}
        {{- if and (eq .externalDns.provider "coredns") .externalDns.coredns.enabled }}
        # External-DNS configured for CoreDNS
        - repoURL: https://kubernetes-sigs.github.io/external-dns
          targetRevision: '{{ .externalDns.versions.chart }}'
          chart: external-dns
          helm:
            valuesObject:
              interval: '{{ .externalDns.interval }}'
              provider:
                name: coredns
              sources: {{ .externalDns.sources | toYaml | nindent 16 }}
              env:
                - name: ETCD_URLS
                  value: "http://external-dns-etcd:2379"
              initContainers:
                - name: wait-for-etcd
                  image: busybox:1.36
                  command: ["sh", "-c", "echo 'Waiting for etcd...'; until nc -z external-dns-etcd 2379; do echo 'Waiting for etcd...'; sleep 2; done; echo 'etcd is ready!'"]
                  securityContext:
                    runAsNonRoot: true
                    runAsUser: 65534
        # CoreDNS server
        - repoURL: https://coredns.github.io/helm
          targetRevision: '{{ .externalDns.versions.coredns }}'
          chart: coredns
          helm:
            parameters:
              - name: replicaCount
                value: '{{ .externalDns.coredns.replicas | default 1 }}'
              - name: serviceType
                value: '{{ .externalDns.coredns.serviceType | default "ClusterIP" }}'
              - name: rbac.create
                value: "true"
              - name: isClusterService
                value: "false"
              {{- if and .externalDns.coredns (hasKey .externalDns.coredns "loadBalancerIP") }}
              - name: service.loadBalancerIP
                value: '{{ .externalDns.coredns.loadBalancerIP }}'
              - name: service.annotations.metallb\.universe\.tf/address-pool
                value: external-dns
              {{- end }}
              - name: servers[0].zones[0].zone
                value: '{{ .common.domain }}.'
              - name: servers[0].port
                value: "53"
              - name: servers[0].plugins[0].name
                value: errors
              - name: servers[0].plugins[1].name
                value: health
              - name: servers[0].plugins[1].configBlock
                value: "lameduck 5s"
              - name: servers[0].plugins[2].name
                value: ready
              - name: servers[0].plugins[3].name
                value: prometheus
              - name: servers[0].plugins[3].parameters
                value: "0.0.0.0:9153"
              - name: servers[0].plugins[4].name
                value: cache
              - name: servers[0].plugins[4].parameters
                value: "30"
              - name: servers[0].plugins[5].name
                value: loop
              - name: servers[0].plugins[6].name
                value: reload
              - name: servers[0].plugins[7].name
                value: loadbalance
              - name: servers[0].plugins[8].name
                value: etcd
              - name: servers[0].plugins[8].parameters
                value: '{{ .common.domain }}'
              - name: servers[0].plugins[8].configBlock
                value: |
                  path /skydns
                  endpoint http://external-dns-etcd:2379
        {{- if .externalDns.etcd.enabled }}
        # etcd backend for CoreDNS
        - repoURL: https://groundhog2k.github.io/helm-charts
          targetRevision: '{{ .externalDns.versions.etcd }}'
          chart: etcd
          helm:
            parameters:
              - name: fullnameOverride
                value: external-dns-etcd
              - name: replicas
                value: '{{ .externalDns.etcd.replicas | default 1 }}'
        {{- end }}

        {{- /* Standard provider mode (cloudflare, etc.) */ -}}
        {{- else }}
        # External-DNS with standard provider
        - repoURL: https://kubernetes-sigs.github.io/external-dns
          targetRevision: '{{ .externalDns.versions.chart }}'
          chart: external-dns
          helm:
            parameters:
              - name: provider.name
                value: '{{ .externalDns.provider | default "cloudflare" }}'
              - name: txtOwnerId
                value: '{{ .externalDns.txtOwnerId | default "k8s-test" }}'
              - name: policy
                value: '{{ .externalDns.policy | default "sync" }}'
              - name: interval
                value: '{{ .externalDns.interval | default "15s" }}'
              - name: rbac.create
                value: '{{ .externalDns.rbac.create | default true }}'
              - name: crd.create
                value: '{{ .externalDns.crd.create | default true }}'
              - name: domainFilters[0]
                value: '{{ .common.domain }}'
        {{- end }}

        {{- /* Monitoring - common to all providers */ -}}
        {{- if .features.monitoring.enabled }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/external-dns/kustomize/monitoring/services
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/external-dns/kustomize/monitoring/monitors
          kustomize:
            commonLabels:
              release: '{{ .features.monitoring.release }}'
        {{- end }}

      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
        - {{ . }}
        {{- end }}
      {{- if not .features.externalDns.enabled }}
        automated: null
      {{- else if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
