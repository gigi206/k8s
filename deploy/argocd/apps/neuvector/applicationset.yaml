---
# =============================================================================
# NeuVector ApplicationSet (Container Security)
# =============================================================================
# Deploys NeuVector container security platform with:
# - Controller (policy engine, single or HA)
# - Enforcer (runtime security DaemonSet on each node)
# - Manager (Web UI)
# - Scanner (CVE vulnerability scanning)
# - Monitor (Prometheus exporter)
# Docs: https://open-docs.neuvector.com/
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: neuvector
  namespace: argo-cd
  annotations:
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/neuvector/config/*.yaml

  template:
    metadata:
      name: neuvector
      namespace: argo-cd
      annotations:
    spec:
      project: default

      destination:
        server: https://kubernetes.default.svc
        namespace: neuvector

      syncPolicy:
        retry:
          limit: 10
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 10m

  templatePatch: |
    spec:
      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
          - {{ . }}
        {{- end }}
      {{- if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
      ignoreDifferences:
        # Ignore auto-added fields in ExternalSecrets
        - group: external-secrets.io
          kind: ExternalSecret
          jqPathExpressions:
            - .spec.data[].remoteRef.conversionStrategy
            - .spec.data[].remoteRef.decodingStrategy
            - .spec.data[].remoteRef.metadataPolicy
      sources:
        {{- if .features.networkPolicy.egressPolicy.enabled }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium egress policy (CVE databases, registries)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "cilium-egress-policy.yaml"
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico egress policy (CVE databases, registries)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "calico-egress-policy.yaml"
          {{- end }}
        {{- end }}
        {{- if and .features.networkPolicy.egressPolicy.enabled (eq .features.gatewayAPI.controller.provider "apisix") .features.sso.enabled (eq .features.sso.provider "keycloak") }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Keycloak OIDC egress - Cilium (APISIX only - LoadBalancer IP is RFC1918)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/cilium-egress
          kustomize:
            patches:
              - target:
                  kind: CiliumNetworkPolicy
                  name: neuvector-allow-keycloak-egress
                patch: |
                  - op: replace
                    path: /spec/egress/0/toFQDNs/0/matchName
                    value: keycloak.{{ .common.domain }}
          {{- else if eq .cni.primary "calico" }}
        # Source: Keycloak OIDC egress - Calico (APISIX only - LoadBalancer IP is RFC1918)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/calico-egress
          kustomize:
            patches:
              - target:
                  kind: NetworkPolicy
                  name: neuvector-allow-keycloak-egress
                patch: |
                  - op: replace
                    path: /spec/egress/0/destination/nets/0
                    value: '{{ .features.loadBalancer.staticIPs.gateway }}/32'
          {{- end }}
        {{- end }}
        {{- if .features.networkPolicy.defaultDenyPodIngress.enabled }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium internal ingress policy (monitoring, neuvector namespace)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "cilium-ingress-policy.yaml"
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico internal ingress policy (monitoring, neuvector namespace)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "calico-ingress-policy.yaml"
          {{- end }}
        {{- end }}
        {{- if .features.networkPolicy.ingressPolicy.enabled }}
        # Source: Host ingress policy - conditional per Gateway provider
        {{- if eq .features.gatewayAPI.controller.provider "istio" }}
          {{- if eq .cni.primary "cilium" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "cilium-ingress-policy-istio.yaml"
          {{- else if eq .cni.primary "calico" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "calico-ingress-policy-istio.yaml"
          {{- end }}
        {{- else if eq .features.gatewayAPI.controller.provider "apisix" }}
          {{- if eq .cni.primary "cilium" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "cilium-ingress-policy-apisix.yaml"
          {{- else if eq .cni.primary "calico" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "calico-ingress-policy-apisix.yaml"
          {{- end }}
        {{- else if eq .features.gatewayAPI.controller.provider "traefik" }}
          {{- if eq .cni.primary "cilium" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "cilium-ingress-policy-traefik.yaml"
          {{- else if eq .cni.primary "calico" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "calico-ingress-policy-traefik.yaml"
          {{- end }}
        {{- else if eq .features.gatewayAPI.controller.provider "nginx-gwf" }}
          {{- if eq .cni.primary "cilium" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "cilium-ingress-policy-nginx-gwf.yaml"
          {{- else if eq .cni.primary "calico" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "calico-ingress-policy-nginx-gwf.yaml"
          {{- end }}
        {{- else if eq .features.gatewayAPI.controller.provider "envoy-gateway" }}
          {{- if eq .cni.primary "cilium" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "cilium-ingress-policy-envoy-gateway.yaml"
          {{- else if eq .cni.primary "calico" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "calico-ingress-policy-envoy-gateway.yaml"
          {{- end }}
        {{- else if eq .features.gatewayAPI.controller.provider "cilium" }}
          {{- if eq .cni.primary "cilium" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "cilium-ingress-policy-cilium.yaml"
          {{- else if eq .cni.primary "calico" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "calico-ingress-policy-cilium.yaml"
          {{- end }}
        {{- end }}
        {{- end }}
        {{- if .rke2.cis.enabled }}
        # Source: Namespace with PSA labels for CIS profile compatibility
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "namespace.yaml"
        {{- end }}
        {{- if .features.kubescape.enabled }}
        # Source: Kubescape exceptions for enforcer privileged workloads
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "kubescape-exceptions.yaml"
        {{- end }}
        {{- if .features.kyverno.enabled }}
        # Source: Kyverno PolicyException (allows SA token mount for K8s API access)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/resources
          directory:
            include: "kyverno-policy-exception.yaml"
        {{- end }}
        # Source: RBAC workaround for cert-manager mode
        # Bug: chart only creates 'neuvector-binding-secret-controller' when autoGenerateCert=true
        # But controller always verifies it exists, causing startup failure
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/rbac
        {{- if and .features.sso.enabled (eq .features.sso.provider "keycloak") }}
        # Source 2: SSO resources (ExternalSecret, Keycloak client, CA patch) - only when SSO enabled
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/sso
          kustomize:
            images:
              - 'curlimages/curl={{ .images.curl.repository }}:{{ .images.curl.tag }}'
            patches:
              - target:
                  kind: Job
                  name: neuvector-keycloak-client
                patch: |
                  - op: replace
                    path: /spec/template/spec/containers/0/env/0/value
                    value: {{ .common.domain }}
        {{- end }}

        # Source 2: Encrypted secrets (KSOPS)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/secrets/{{ .environment }}

        {{- if .features.gatewayAPI.enabled }}
        {{- if .features.gatewayAPI.httpRoute.enabled }}
        {{- if eq .features.gatewayAPI.controller.provider "envoy-gateway" }}
        # Source 3: Backend + HTTPRoute for envoy-gateway (HTTP/1.1 required by NeuVector)
        # NeuVector Manager only supports HTTP/1.1, but Envoy uses HTTP/2 by default via ALPN.
        # The Backend CRD with alpnProtocols: ["http/1.1"] forces HTTP/1.1 negotiation.
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/httproute-envoy-gateway
          kustomize:
            patches:
              - target:
                  kind: HTTPRoute
                  name: neuvector-manager
                patch: |
                  - op: replace
                    path: /spec/hostnames/0
                    value: neuvector.{{ .common.domain }}
                  - op: replace
                    path: /spec/parentRefs/0/namespace
                    value: '{{ .features.gatewayAPI.controller.gatewayNamespace }}'
        {{- else }}
        # Source 3: HTTPRoute (Gateway API standard) - for non-envoy-gateway providers
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/httproute
          kustomize:
            patches:
              - target:
                  kind: HTTPRoute
                  name: neuvector-manager
                patch: |
                  - op: replace
                    path: /spec/hostnames/0
                    value: neuvector.{{ .common.domain }}
                  - op: replace
                    path: /spec/parentRefs/0/namespace
                    value: '{{ .features.gatewayAPI.controller.gatewayNamespace }}'
        {{- if eq .features.gatewayAPI.controller.provider "cilium" }}
                  - op: replace
                    path: /spec/rules/0/backendRefs/0/name
                    value: neuvector-manager-http-proxy
                  - op: replace
                    path: /spec/rules/0/backendRefs/0/port
                    value: 8080
        {{- end }}
              - target:
                  kind: ReferenceGrant
                  name: allow-neuvector-httproute
                patch: |
                  - op: replace
                    path: /metadata/namespace
                    value: '{{ .features.gatewayAPI.controller.gatewayNamespace }}'
        {{- if eq .features.gatewayAPI.controller.provider "traefik" }}
        # Source 3b: BackendTLSPolicy for Traefik (HTTPS backend validation)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/httproute-traefik
        {{- else if eq .features.gatewayAPI.controller.provider "nginx-gwf" }}
        # Source 3b: BackendTLSPolicy for nginx-gateway-fabric (HTTPS backend validation)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/httproute-nginx-gwf
        {{- else if eq .features.gatewayAPI.controller.provider "cilium" }}
        # Source 3b: HTTP-to-HTTPS proxy for Cilium Gateway (no BackendTLSPolicy support)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/httproute-cilium
        {{- end }}
        {{- end }}
        {{- else if eq .features.gatewayAPI.controller.provider "apisix" }}
        # Source 3: APISIX native CRDs (when HTTPRoute disabled and provider is apisix)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/apisix
          kustomize:
            patches:
              - target:
                  kind: ApisixRoute
                  name: neuvector-manager
                patch: |
                  - op: replace
                    path: /spec/http/0/match/hosts/0
                    value: neuvector.{{ .common.domain }}
        {{- end }}
        {{- end }}

        {{- if or .features.serviceMesh.enabled (eq .features.gatewayAPI.controller.provider "istio") }}
        # Source 4a: Istio DestinationRule (only for Istio/service mesh)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/istio
        {{- end }}

        {{- if or .features.serviceMesh.enabled (eq .features.gatewayAPI.controller.provider "istio") (eq .features.gatewayAPI.controller.provider "envoy-gateway") (eq .features.gatewayAPI.controller.provider "traefik") (eq .features.gatewayAPI.controller.provider "nginx-gwf") (eq .features.gatewayAPI.controller.provider "cilium") }}
        # Source 4b: TLS certificates (for HTTPS backend validation)
        # Used by Istio, Envoy Gateway, Traefik, nginx-gateway-fabric and Cilium to validate NeuVector Manager TLS
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/certificates
          kustomize:
            patches:
              - target:
                  kind: Certificate
                  name: neuvector-manager-tls
                patch: |
                  - op: replace
                    path: /spec/dnsNames/4
                    value: neuvector.{{ .common.domain }}
        {{- end }}

        {{- if or .features.serviceMesh.enabled (eq .features.gatewayAPI.controller.provider "istio") }}
        # Source 4c: Istio CA ExternalSecret (sync CA to istio-system for DestinationRule)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/certificates-istio
        {{- end }}

        {{- if .features.monitoring.enabled }}
        # Source 5: PrometheusRules
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/neuvector/kustomize/monitoring
          kustomize:
            commonLabels:
              release: '{{ .features.monitoring.release }}'
        {{- end }}

        # Source 6: NeuVector Core Helm chart
        - repoURL: https://neuvector.github.io/neuvector-helm/
          targetRevision: '{{ .neuvector.version }}'
          chart: core
          helm:
            valuesObject:
              # Bootstrap password (must match neuvector-admin-credentials secret)
              bootstrapPassword: "admin"

              # RKE2/K3s runtime configuration
              # The k3s.enabled option is deprecated in NeuVector 5.3.0+
              # Use runtimePath directly for containerd socket access
              runtimePath: /run/k3s/containerd/containerd.sock

              # Internal certificates configuration
              # Using cert-manager for internal certificates (avoids cert-upgrader lease issues)
              internal:
                certmanager:
                  enabled: true
                  secretname: neuvector-internal-certs
                # Disable auto-generation when using cert-manager
                autoGenerateCert: false
                autoRotateCert: false

              # Controller configuration
              controller:
                enabled: true
                replicas: {{ .neuvector.controller.replicas | default 1 }}
                apisvc:
                  type: ClusterIP
                # Internal certificate for controller (required when certmanager.enabled=true)
                # Bug in chart: checks internal.certmanager.enabled but uses controller.internal.certificate.secret
                internal:
                  certificate:
                    secret: neuvector-internal-certs
                resources:
                  requests:
                    cpu: {{ .neuvector.controller.resources.requests.cpu | default "100m" }}
                    memory: {{ .neuvector.controller.resources.requests.memory | default "256Mi" }}
                  limits:
                    cpu: {{ .neuvector.controller.resources.limits.cpu | default "500m" }}
                    memory: {{ .neuvector.controller.resources.limits.memory | default "512Mi" }}
                # OIDC Configuration is managed via SOPS secret (neuvector-init)
                # See: secrets/dev/secret.yaml and secrets/prod/secret.yaml
                # The neuvector-init secret contains userinitcfg.yaml and oidcinitcfg.yaml

              # Enforcer configuration (DaemonSet)
              enforcer:
                enabled: true
                # Internal certificate for enforcer (required when certmanager.enabled=true)
                internal:
                  certificate:
                    secret: neuvector-internal-certs
                resources:
                  requests:
                    cpu: {{ .neuvector.enforcer.resources.requests.cpu | default "100m" }}
                    memory: {{ .neuvector.enforcer.resources.requests.memory | default "128Mi" }}
                  limits:
                    cpu: {{ .neuvector.enforcer.resources.limits.cpu | default "500m" }}
                    memory: {{ .neuvector.enforcer.resources.limits.memory | default "512Mi" }}

              # Manager configuration (Web UI)
              manager:
                enabled: true
                {{- if or .features.serviceMesh.enabled (eq .features.gatewayAPI.controller.provider "istio") (eq .features.gatewayAPI.controller.provider "envoy-gateway") (eq .features.gatewayAPI.controller.provider "traefik") (eq .features.gatewayAPI.controller.provider "nginx-gwf") (eq .features.gatewayAPI.controller.provider "cilium") }}
                # Use cert-manager certificate for TLS (allows Istio/Envoy Gateway/Traefik/nginx-gwf/Cilium to validate)
                certificate:
                  secret: neuvector-manager-tls-cert
                  keyFile: tls.key
                  pemFile: tls.crt
                {{- end }}
                svc:
                  type: ClusterIP
                route:
                  enabled: false  # Using HTTPRoute instead
                resources:
                  requests:
                    cpu: {{ .neuvector.manager.resources.requests.cpu | default "50m" }}
                    memory: {{ .neuvector.manager.resources.requests.memory | default "128Mi" }}
                  limits:
                    cpu: {{ .neuvector.manager.resources.limits.cpu | default "200m" }}
                    memory: {{ .neuvector.manager.resources.limits.memory | default "256Mi" }}

              # Scanner configuration
              cve:
                scanner:
                  enabled: true
                  replicas: {{ .neuvector.scanner.replicas | default 1 }}
                  # Internal certificate for scanner (required when certmanager.enabled=true)
                  internal:
                    certificate:
                      secret: neuvector-internal-certs
                  resources:
                    requests:
                      cpu: {{ .neuvector.scanner.resources.requests.cpu | default "100m" }}
                      memory: {{ .neuvector.scanner.resources.requests.memory | default "512Mi" }}
                    limits:
                      cpu: {{ .neuvector.scanner.resources.limits.cpu | default "500m" }}
                      memory: {{ .neuvector.scanner.resources.limits.memory | default "1Gi" }}

              # CRD webhook
              crdwebhook:
                enabled: true

        {{- if .features.monitoring.enabled }}
        # Source 7: NeuVector Monitor Helm chart (Prometheus exporter)
        - repoURL: https://neuvector.github.io/neuvector-helm/
          targetRevision: '{{ .neuvector.monitorVersion | default .neuvector.version }}'
          chart: monitor
          helm:
            valuesObject:
              exporter:
                enabled: true
                apiSvc: neuvector-svc-controller-api:10443
                ctrlSecretName: neuvector-admin-credentials
                {{- if .neuvector.exporter.resources }}
                resources:
                  requests:
                    cpu: '{{ .neuvector.exporter.resources.requests.cpu }}'
                    memory: '{{ .neuvector.exporter.resources.requests.memory }}'
                  limits:
                    cpu: '{{ .neuvector.exporter.resources.limits.cpu }}'
                    memory: '{{ .neuvector.exporter.resources.limits.memory }}'
                {{- end }}
                # WARNING: enforcerStats impacts performance
                enforcerStats:
                  enabled: {{ .neuvector.exporter.enforcerStats.enabled | default false }}
                svc:
                  enabled: true
                  type: ClusterIP
                serviceMonitor:
                  enabled: true
                  labels:
                    release: '{{ .features.monitoring.release }}'
                  interval: 30s
                  scrapeTimeout: 30s
        {{- end }}
