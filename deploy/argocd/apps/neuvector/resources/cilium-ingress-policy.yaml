---
# =============================================================================
# CiliumNetworkPolicy - NeuVector Internal Ingress Security
# =============================================================================
# Restricts access to NeuVector pods to authorized internal sources:
# - neuvector: Internal pod communication (controller, scanner, enforcer, manager)
# - monitoring: Prometheus metrics scraping
#
# Gateway-specific ingress rules are in separate files:
# - cilium-ingress-policy-traefik.yaml
# - cilium-ingress-policy-istio.yaml
# - cilium-ingress-policy-apisix.yaml
# =============================================================================

apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: neuvector-ingress
  namespace: neuvector
spec:
  description: "Allow internal ingress to NeuVector from authorized sources"
  endpointSelector: {}  # Applies to all pods in neuvector namespace

  ingress:
    # Allow internal NeuVector communication (same namespace)
    # Controller <-> Controller, Scanner -> Controller, Enforcer -> Controller
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: neuvector
      toPorts:
        - ports:
            - port: "8443"    # Manager web UI
              protocol: TCP
            - port: "10443"   # Controller fed/console
              protocol: TCP
            - port: "18300"   # Controller cluster communication
              protocol: TCP
            - port: "18300"   # Controller cluster communication (UDP)
              protocol: UDP
            - port: "18301"   # Controller gRPC
              protocol: TCP
            - port: "18301"   # Controller gRPC (UDP)
              protocol: UDP
            - port: "18400"   # Controller internal (enforcer/scanner)
              protocol: TCP
            - port: "18401"   # Controller internal
              protocol: TCP
            - port: "18402"   # Scanner port
              protocol: TCP
            - port: "8068"    # Prometheus exporter
              protocol: TCP

    # Allow from monitoring namespace (Prometheus scrape)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: monitoring
      toPorts:
        - ports:
            - port: "8068"    # Prometheus exporter metrics
              protocol: TCP
