---
# =============================================================================
# CiliumNetworkPolicy - NeuVector External Egress
# =============================================================================
# Allows NeuVector to reach external services:
# - CVE database updates (NIST NVD, etc.)
# - Container registry scanning
# - License validation
#
# This policy complements the cluster-wide default-deny-external-egress policy
# defined in deploy/argocd/apps/cilium/resources/
# =============================================================================

apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: neuvector-allow-external-egress
  namespace: neuvector
spec:
  description: "Allow NeuVector to access CVE databases and registries"

  # Apply to all pods in neuvector namespace
  endpointSelector: {}

  egress:
    # Allow internal NeuVector communication (same namespace)
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: neuvector
      toPorts:
        - ports:
            - port: "8443"    # Manager web UI
              protocol: TCP
            - port: "10443"   # Controller fed/console
              protocol: TCP
            - port: "18300"   # Controller cluster communication
              protocol: TCP
            - port: "18300"
              protocol: UDP
            - port: "18301"   # Controller gRPC
              protocol: TCP
            - port: "18301"
              protocol: UDP
            - port: "18400"   # Controller internal
              protocol: TCP
            - port: "18401"   # Controller internal
              protocol: TCP
            - port: "18402"   # Scanner port
              protocol: TCP

    # Allow HTTPS to external services (CVE databases, registries)
    - toEntities:
        - world
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
