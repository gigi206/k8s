---
# =============================================================================
# Job to patch NeuVector controller with CA certificate mount
# =============================================================================
# The CA certificate is synced by ExternalSecret (external-secret-ca.yaml).
# This Job only patches the deployment to mount it and set SSL_CERT_FILE.
#
# Why a Job? The NeuVector Helm chart doesn't support extraVolumes/extraVolumeMounts.
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: neuvector-controller-ca-patch
  namespace: neuvector
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: neuvector-controller-ca-patch
      restartPolicy: OnFailure
      containers:
        - name: kubectl
          image: registry.k8s.io/kubectl:v1.35.0
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "=== Patching NeuVector controller to mount CA certificate ==="

              # Wait for root-ca secret to be created by ExternalSecret
              echo "Waiting for root-ca secret..."
              for i in $(seq 1 30); do
                if kubectl get secret root-ca -n neuvector >/dev/null 2>&1; then
                  echo "root-ca secret found"
                  break
                fi
                echo "Waiting... ($i/30)"
                sleep 2
              done

              if ! kubectl get secret root-ca -n neuvector >/dev/null 2>&1; then
                echo "ERROR: root-ca secret not found after 60s"
                exit 1
              fi

              # Check if deployment patch is already applied
              EXISTING_VOL=$(kubectl get deployment neuvector-controller-pod -n neuvector \
                -o jsonpath='{.spec.template.spec.volumes[?(@.name=="root-ca")].name}' 2>/dev/null || echo "")

              if [ "$EXISTING_VOL" = "root-ca" ]; then
                echo "CA volume already mounted, restarting controller to pick up any CA updates..."
                kubectl rollout restart deployment/neuvector-controller-pod -n neuvector
                exit 0
              fi

              # Apply strategic merge patch to add volume and volumeMount
              echo "Patching NeuVector controller deployment..."
              kubectl patch deployment neuvector-controller-pod -n neuvector --type=strategic -p '
              {
                "spec": {
                  "template": {
                    "spec": {
                      "containers": [
                        {
                          "name": "neuvector-controller-pod",
                          "env": [
                            {
                              "name": "SSL_CERT_FILE",
                              "value": "/etc/ssl/certs/root-ca/ca.crt"
                            }
                          ],
                          "volumeMounts": [
                            {
                              "name": "root-ca",
                              "mountPath": "/etc/ssl/certs/root-ca",
                              "readOnly": true
                            }
                          ]
                        }
                      ],
                      "volumes": [
                        {
                          "name": "root-ca",
                          "secret": {
                            "secretName": "root-ca"
                          }
                        }
                      ]
                    }
                  }
                }
              }'

              echo "=== Done! Controller will restart with cluster CA certificate ==="
---
# ServiceAccount for the patch job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: neuvector-controller-ca-patch
  namespace: neuvector
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
---
# Role to allow patching deployment and reading secrets in neuvector namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: neuvector-controller-ca-patch
  namespace: neuvector
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
rules:
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "patch"]
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["root-ca"]
    verbs: ["get"]
---
# RoleBinding for the patch job
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: neuvector-controller-ca-patch
  namespace: neuvector
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
subjects:
  - kind: ServiceAccount
    name: neuvector-controller-ca-patch
    namespace: neuvector
roleRef:
  kind: Role
  name: neuvector-controller-ca-patch
  apiGroup: rbac.authorization.k8s.io
