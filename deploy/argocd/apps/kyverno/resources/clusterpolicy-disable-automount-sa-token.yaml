---
# =============================================================================
# ClusterPolicy: Disable ServiceAccount Token Automount
# =============================================================================
# Mutates all pods to set automountServiceAccountToken: false by default.
# Applications that need K8s API access must create a PolicyException.
#
# CIS Kubernetes Benchmark 5.1.6:
# "Ensure that Service Account Tokens are only mounted where necessary"
#
# Pattern: Each app that needs K8s API access creates its own PolicyException
# in its resources/ directory (e.g., kyverno-policy-exception.yaml)
# =============================================================================
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disable-automount-sa-token
  annotations:
    policies.kyverno.io/title: Disable Automount ServiceAccount Token
    policies.kyverno.io/category: Security Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Kubernetes automatically mounts ServiceAccount tokens in pods, which can
      be exploited if a pod is compromised. This policy mutates pods to disable
      automatic token mounting for workloads that don't need Kubernetes API access.
      Applications requiring K8s API access must define a PolicyException.
spec:
  # Kyverno defaults (explicit to avoid OutOfSync)
  admission: true
  emitWarning: false
  validationFailureAction: Audit
  # Mutate existing resources on policy update
  mutateExistingOnPolicyUpdate: false
  # Apply to new pods only (not existing)
  background: false
  rules:
    - name: disable-automount-sa-token
      skipBackgroundRequests: true
      match:
        any:
          - resources:
              kinds:
                - Pod
              operations:
                - CREATE
      exclude:
        any:
          # === System namespaces (always need API access - cannot be excepted) ===
          - resources:
              namespaces:
                - kube-system
                - kube-public
                - kube-node-lease
          # === Policy engine itself (must be excluded - cannot use PolicyException) ===
          - resources:
              namespaces:
                - kyverno
          # === SPIRE (Cilium mutual auth) - fundamentally requires SA token ===
          # SPIRE server uses k8sbundle Notifier and k8s NodeResolver which need
          # the K8s API. Without the token, SPIRE crashes and mutual auth blocks
          # ALL inter-pod traffic. Excluded here (not via PolicyException) because
          # the Helm controller may update SPIRE before the PE is applied.
          - resources:
              namespaces:
                - cilium-spire
      mutate:
        patchStrategicMerge:
          spec:
            automountServiceAccountToken: false
