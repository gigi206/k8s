---
# =============================================================================
# Job - Create OBC + Velero S3 credentials + BackupStorageLocation
# =============================================================================
# 1. Creates ObjectBucketClaim via kubectl (avoids ArgoCD REST mapper issues
#    when the OBC CRD is not yet cached - see ceph-storage-presync-check.yaml)
# 2. Waits for OBC to be Bound (Secret + ConfigMap provisioned by Rook-Ceph)
# 3. Creates a Secret with Velero AWS credentials format
# 4. Creates a BackupStorageLocation CR pointing to the S3 bucket
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: velero-s3-credentials
  namespace: velero
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
    argocd.argoproj.io/sync-wave: "1"
spec:
  backoffLimit: 10
  template:
    metadata:
      labels:
        kyverno.io/exclude-sa-token: "true"
    spec:
      restartPolicy: OnFailure
      serviceAccountName: velero-credentials-job
      automountServiceAccountToken: true
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: create-credentials
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          image: docker.io/bitnami/kubectl:latest
          env:
            - name: OBC_SECRET_NAME
              value: "velero-storage"
            - name: OBC_CONFIGMAP_NAME
              value: "velero-storage"
            - name: TARGET_SECRET_NAME
              value: "velero-s3-credentials"
            - name: NAMESPACE
              value: "velero"
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e

              echo "Creating ObjectBucketClaim (if not exists)..."
              kubectl apply -f - <<'OBC'
              apiVersion: objectbucket.io/v1alpha1
              kind: ObjectBucketClaim
              metadata:
                name: velero-storage
                namespace: velero
              spec:
                generateBucketName: velero
                storageClassName: ceph-bucket
              OBC
              echo "ObjectBucketClaim applied."

              echo "Waiting for OBC Secret ${OBC_SECRET_NAME}..."
              until kubectl get secret "${OBC_SECRET_NAME}" -n "${NAMESPACE}" >/dev/null 2>&1; do
                echo "  Secret not found, retrying in 5s..."
                sleep 5
              done

              echo "Waiting for OBC ConfigMap ${OBC_CONFIGMAP_NAME}..."
              until kubectl get configmap "${OBC_CONFIGMAP_NAME}" -n "${NAMESPACE}" >/dev/null 2>&1; do
                echo "  ConfigMap not found, retrying in 5s..."
                sleep 5
              done

              echo "Reading OBC credentials..."
              AWS_ACCESS_KEY_ID=$(kubectl get secret "${OBC_SECRET_NAME}" -n "${NAMESPACE}" -o jsonpath='{.data.AWS_ACCESS_KEY_ID}' | base64 -d)
              AWS_SECRET_ACCESS_KEY=$(kubectl get secret "${OBC_SECRET_NAME}" -n "${NAMESPACE}" -o jsonpath='{.data.AWS_SECRET_ACCESS_KEY}' | base64 -d)
              BUCKET_HOST=$(kubectl get configmap "${OBC_CONFIGMAP_NAME}" -n "${NAMESPACE}" -o jsonpath='{.data.BUCKET_HOST}')
              BUCKET_PORT=$(kubectl get configmap "${OBC_CONFIGMAP_NAME}" -n "${NAMESPACE}" -o jsonpath='{.data.BUCKET_PORT}')
              BUCKET_NAME=$(kubectl get configmap "${OBC_CONFIGMAP_NAME}" -n "${NAMESPACE}" -o jsonpath='{.data.BUCKET_NAME}')

              echo "Creating Velero credentials secret..."
              CLOUD_CREDENTIALS=$(printf '[default]\naws_access_key_id=%s\naws_secret_access_key=%s\n' "${AWS_ACCESS_KEY_ID}" "${AWS_SECRET_ACCESS_KEY}")

              kubectl create secret generic "${TARGET_SECRET_NAME}" \
                --namespace="${NAMESPACE}" \
                --from-literal=cloud="${CLOUD_CREDENTIALS}" \
                --dry-run=client -o yaml | kubectl apply -f -

              echo "Creating BackupStorageLocation..."
              if kubectl apply -f - <<BSL
              apiVersion: velero.io/v1
              kind: BackupStorageLocation
              metadata:
                name: default
                namespace: ${NAMESPACE}
                labels:
                  app.kubernetes.io/managed-by: velero-credentials-job
              spec:
                provider: aws
                default: true
                objectStorage:
                  bucket: ${BUCKET_NAME}
                credential:
                  name: ${TARGET_SECRET_NAME}
                  key: cloud
                config:
                  region: us-east-1
                  s3ForcePathStyle: "true"
                  s3Url: "http://${BUCKET_HOST}:${BUCKET_PORT}"
              BSL
              then
                echo "BackupStorageLocation created successfully."
              else
                echo "WARNING: BSL creation failed (CRDs may not be installed yet)."
                echo "The Secret was created. BSL will be created on the next ArgoCD sync."
              fi

              echo "Velero S3 credentials setup completed."
---
# ServiceAccount for the credentials Job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: velero-credentials-job
  namespace: velero
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
automountServiceAccountToken: false
---
# Role for reading OBC secrets, creating Velero credentials and BSL
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: velero-credentials-job
  namespace: velero
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "update", "patch"]
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get"]
  - apiGroups: ["velero.io"]
    resources: ["backupstoragelocations"]
    verbs: ["get", "create", "update", "patch"]
  - apiGroups: ["objectbucket.io"]
    resources: ["objectbucketclaims"]
    verbs: ["get", "create", "update", "patch"]
---
# RoleBinding for the credentials Job
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: velero-credentials-job
  namespace: velero
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
subjects:
  - kind: ServiceAccount
    name: velero-credentials-job
    namespace: velero
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: velero-credentials-job
