---
# =============================================================================
# LoxiLB ApplicationSet (Load Balancer) - Official Manifests
# =============================================================================
# Déploie LoxiLB pour fournir des IPs LoadBalancer via eBPF
# Source: https://github.com/loxilb-io/kube-loxilb (manifests officiels)
# Docs: https://docs.loxilb.io/
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: loxilb
  namespace: argo-cd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Config de base (valeurs par défaut)
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # Config spécifique à l'application
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/loxilb/config/*.yaml

  template:
    metadata:
      name: loxilb
      namespace: argo-cd
    spec:
      project: default

      sources:
        # Placeholder - sera remplacé par templatePatch
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: 'HEAD'
          path: deploy/argocd/apps/loxilb/kustomize/kube-loxilb

      destination:
        server: https://kubernetes.default.svc
        namespace: kube-system

      syncPolicy:
        retry:
          limit: 10
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 10m

  templatePatch: |
    spec:
      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
          - {{ . }}
        {{- end }}
      {{- if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
      sources:
        {{- if eq .loxilb.mode "external" }}
        # =======================================================================
        # External Mode: kube-loxilb only (no in-cluster loxilb DaemonSet)
        # =======================================================================
        # loxilb runs as an external Docker container (e.g. --net=host on k3d)
        # kube-loxilb connects to it via --loxiURL.
        # No eBPF conflict with Cilium (no Multus required).
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/kube-loxilb-external
          kustomize:
            images:
              - 'ghcr.io/loxilb-io/kube-loxilb={{ .loxilb.kubeLoxilbImage }}:{{ .loxilb.kubeLoxilbTag }}'
            patches:
              - target:
                  group: apps
                  version: v1
                  kind: Deployment
                  name: kube-loxilb
                patch: |
                  - op: replace
                    path: /spec/template/spec/initContainers/0/env/0/value
                    value: '{{ index .loxilb.loxiURL 0 }}'
                  - op: replace
                    path: /spec/template/spec/containers/0/args
                    value:
                      - --loxiURL={{ join "," .loxilb.loxiURL }}
                      - --cidrPools=defaultPool={{ .features.loadBalancer.pools.default.range }}
                      - --setRoles=0.0.0.0
                      - --setLBMode={{ .loxilb.setLBMode }}
                      - --noZoneName
              {{- if .loxilb.bgp.enabled }}
                      - --setBGP={{ .loxilb.bgp.localASN }}
                      {{- if eq .features.loadBalancer.mode "bgp" }}
                      - --extBGPPeers={{ range $i, $p := .features.loadBalancer.bgp.peers }}{{ if $i }},{{ end }}{{ $p.address }}:{{ $p.asn }}{{ end }}
                      {{- else }}
                      - --extBGPPeers={{ .loxilb.bgp.extBGPPeers }}
                      {{- end }}
              {{- end }}
        {{- if .features.networkPolicy.egressPolicy.enabled }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium egress policy (external loxilb API access)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/cilium-egress
          kustomize:
            patches:
              - target:
                  kind: CiliumNetworkPolicy
                  name: loxilb-allow-external-egress
                patch: |
                  - op: replace
                    path: /spec/egress/0/toCIDR
                    value:
                    {{- range .loxilb.loxiURL }}
                      - '{{ regexReplaceAll "https?://([0-9.]+):.*" . "$1" }}/32'
                    {{- end }}
                  - op: replace
                    path: /spec/egress/0/toPorts/0/ports/0/port
                    value: '{{ regexReplaceAll ".*:([0-9]+)$" (index .loxilb.loxiURL 0) "$1" }}'
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico egress policy (external loxilb API access)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/calico-egress
          kustomize:
            patches:
              - target:
                  kind: NetworkPolicy
                  name: loxilb-allow-external-egress
                patch: |
                  - op: replace
                    path: /spec/egress/0/destination/nets
                    value:
                    {{- range .loxilb.loxiURL }}
                      - '{{ regexReplaceAll "https?://([0-9.]+):.*" . "$1" }}/32'
                    {{- end }}
                  - op: replace
                    path: /spec/egress/0/destination/ports/0
                    value: {{ regexReplaceAll ".*:([0-9]+)$" (index .loxilb.loxiURL 0) "$1" }}
          {{- end }}
        {{- end }}
        {{- if .loxilb.bgp.enabled }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium BGP peering (PodCIDR advertisement to loxilb)
        # Cilium v1.19+: CiliumBGPClusterConfig + CiliumBGPPeerConfig + CiliumBGPAdvertisement
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/cilium-bgp-peering
          kustomize:
            patches:
              - target:
                  kind: CiliumBGPClusterConfig
                  name: loxilb-external-bgp
                patch: |
                  - op: replace
                    path: /spec/bgpInstances/0/localASN
                    value: {{ .features.loadBalancer.bgp.localASN }}
                  - op: replace
                    path: /spec/bgpInstances/0/peers
                    value:
                    {{- if eq .features.loadBalancer.mode "bgp" }}
                    {{- range .features.loadBalancer.bgp.peers }}
                      - name: "peer-{{ .address }}"
                        peerASN: {{ .asn }}
                        peerAddress: '{{ .address }}'
                        peerConfigRef:
                          name: "loxilb-external-peer"
                    {{- end }}
                    {{- else }}
                    {{- range $i, $url := .loxilb.loxiURL }}
                      - name: "loxilb-direct-{{ $i }}"
                        peerASN: {{ $.loxilb.bgp.localASN }}
                        peerAddress: '{{ regexReplaceAll "https?://([0-9.]+):.*" $url "$1" }}'
                        peerConfigRef:
                          name: "loxilb-external-peer"
                    {{- end }}
                    {{- end }}
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico BGP peering (PodCIDR advertisement via BGP)
        # In bgp mode: peer with FRR router instead of loxilb directly
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/calico-bgp-peering
          kustomize:
            patches:
              - target:
                  group: crd.projectcalico.org
                  version: v1
                  kind: BGPPeer
                  name: loxilb-external-bgp
                patch: |
                  - op: replace
                    path: /spec/peerIP
                    value: '{{ if eq .features.loadBalancer.mode "bgp" }}{{ (index .features.loadBalancer.bgp.peers 0).address }}{{ else }}{{ regexReplaceAll "https?://([0-9.]+):.*" (index .loxilb.loxiURL 0) "$1" }}{{ end }}'
                  - op: replace
                    path: /spec/asNumber
                    value: {{ if eq .features.loadBalancer.mode "bgp" }}{{ (index .features.loadBalancer.bgp.peers 0).asn }}{{ else }}{{ .loxilb.bgp.localASN }}{{ end }}
          {{- end }}
        {{- end }}
        {{- if .features.networkPolicy.defaultDenyPodIngress.enabled }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium ingress policy (allow DNAT'd LB traffic from loxilb to pods)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/cilium-ingress
          kustomize:
            patches:
              - target:
                  kind: CiliumClusterwideNetworkPolicy
                  name: loxilb-allow-external-ingress
                patch: |
                  - op: replace
                    path: /spec/ingress/0/fromCIDR
                    value:
                    {{- range .loxilb.loxiURL }}
                      - '{{ regexReplaceAll "https?://([0-9.]+):.*" . "$1" }}/32'
                    {{- end }}
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico ingress policy (allow DNAT'd LB traffic from loxilb to pods)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/calico-ingress
          kustomize:
            patches:
              - target:
                  kind: GlobalNetworkPolicy
                  name: loxilb-allow-external-ingress
                patch: |
                  - op: replace
                    path: /spec/ingress/0/source/nets
                    value:
                    {{- range .loxilb.loxiURL }}
                      - '{{ regexReplaceAll "https?://([0-9.]+):.*" . "$1" }}/32'
                    {{- end }}
          {{- end }}
        {{- end }}
        {{- if and .loxilb.bgp.enabled .features.networkPolicy.ingressPolicy.enabled (ne .features.loadBalancer.mode "bgp") }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium host ingress policy (allow BGP port 179 from loxilb to nodes)
        # (In bgp mode, the frr app deploys this policy for FRR IP instead)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/cilium-host-ingress
          kustomize:
            patches:
              - target:
                  kind: CiliumClusterwideNetworkPolicy
                  name: loxilb-bgp-host-ingress
                patch: |
                  - op: replace
                    path: /spec/ingress/0/fromCIDR
                    value:
                    {{- range .loxilb.loxiURL }}
                      - '{{ regexReplaceAll "https?://([0-9.]+):.*" . "$1" }}/32'
                    {{- end }}
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico host ingress policy (allow BGP port 179 from loxilb to nodes)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/calico-host-ingress
          kustomize:
            patches:
              - target:
                  kind: GlobalNetworkPolicy
                  name: loxilb-bgp-host-ingress
                patch: |
                  - op: replace
                    path: /spec/ingress/0/source/nets
                    value:
                    {{- range .loxilb.loxiURL }}
                      - '{{ regexReplaceAll "https?://([0-9.]+):.*" . "$1" }}/32'
                    {{- end }}
          {{- end }}
        {{- end }}
        {{- else }}
        # =======================================================================
        # Source 1: kube-loxilb (controller) - In-cluster mode
        # =======================================================================
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/kube-loxilb
          kustomize:
            images:
              - 'ghcr.io/loxilb-io/kube-loxilb={{ .loxilb.kubeLoxilbImage }}:{{ .loxilb.kubeLoxilbTag }}'
            patches:
              - target:
                  group: apps
                  version: v1
                  kind: Deployment
                  name: kube-loxilb
                patch: |
                  - op: replace
                    path: /spec/template/spec/containers/0/args
                    {{- if eq .features.loadBalancer.mode "bgp" }}
                    value:
                      - --cidrPools=defaultPool={{ .features.loadBalancer.pools.default.range }}
                      - --setRoles=0.0.0.0
                      - --setBGP={{ .features.loadBalancer.bgp.localASN }}
                      - --setLBMode={{ .loxilb.setLBMode }}
                      - --noZoneName
                    {{- else }}
                    value:
                      - --cidrPools=defaultPool={{ .features.loadBalancer.pools.default.range }}
                      - --setRoles=0.0.0.0
                      - --setLBMode={{ .loxilb.setLBMode }}
                      - --noZoneName
                    {{- end }}

        # =======================================================================
        # Source 2: loxilb daemon (L2, BGP, or Multus mode)
        # =======================================================================
        # Mode selection:
        # - BGP mode: uses loxilb-bgp (hostNetwork: true, BGP enabled)
        # - Multus mode: uses loxilb-multus (hostNetwork: false, Multus interface)
        # - L2 mode (default): uses loxilb (hostNetwork: true)
        {{- if eq .features.loadBalancer.mode "bgp" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/loxilb-bgp
          kustomize:
            images:
              - 'ghcr.io/loxilb-io/loxilb={{ .loxilb.loxilbImage }}:{{ .loxilb.loxilbTag }}'
        {{- else if .cni.multus.enabled }}
        # Multus mode: secondary interface for Cilium compatibility
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/loxilb-multus
          kustomize:
            images:
              - 'ghcr.io/loxilb-io/loxilb={{ .loxilb.loxilbImage }}:{{ .loxilb.loxilbTag }}'

        # NetworkAttachmentDefinition for Multus
        {{- if .cni.multus.whereabouts }}
        # Whereabouts IPAM: dynamic IP allocation for multi-node deployments
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/network-attachment-definition-whereabouts
        {{- else }}
        # Static IPAM: fixed IP for single-node deployments
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/network-attachment-definition
        {{- end }}
        {{- else }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/loxilb
          kustomize:
            images:
              - 'ghcr.io/loxilb-io/loxilb={{ .loxilb.loxilbImage }}:{{ .loxilb.loxilbTag }}'
        {{- end }}

        {{- if eq .features.loadBalancer.mode "bgp" }}
        # =======================================================================
        # Source 3: CRDs for BGP (only in BGP mode)
        # =======================================================================
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/crds

        # =======================================================================
        # Source 4: BGPPeerService CR (only in BGP mode)
        # =======================================================================
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/loxilb/kustomize/bgp
          kustomize:
            patches:
              - target:
                  group: bgppeer.loxilb.io
                  version: v1
                  kind: BGPPeerService
                  name: default-peer
                patch: |
                  - op: replace
                    path: /spec/ipAddress
                    value: '{{ (index .features.loadBalancer.bgp.peers 0).address }}'
                  - op: replace
                    path: /spec/remoteAs
                    value: {{ (index .features.loadBalancer.bgp.peers 0).asn }}
        {{- end }}
        {{- end }}
