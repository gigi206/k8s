---
# =============================================================================
# CiliumNetworkPolicy - Longhorn Internal Ingress
# =============================================================================
# Allows internal communication within longhorn-system namespace and from
# dependent namespaces (monitoring, kube-system)
# Note: CSI driver uses local Unix sockets on nodes, no network policy needed.
# =============================================================================
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: longhorn-internal
  namespace: longhorn-system
spec:
  description: "Allow internal ingress to Longhorn"
  endpointSelector: {}  # Applies to all pods in longhorn-system namespace

  ingress:
    # Allow from monitoring namespace (Prometheus scrape)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: monitoring
      toPorts:
        - ports:
            - port: "9500"    # Manager metrics
              protocol: TCP

    # Allow from kube-system (API server webhook calls)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system
      toPorts:
        - ports:
            - port: "9443"    # Webhook validation
              protocol: TCP

    # Allow internal Longhorn communication (same namespace)
    # Manager <-> Manager, UI <-> Manager, Operator <-> Manager
    # Instance Manager gRPC: 8500 (API), 8501 (Proxy), 8502 (Disk), 8503 (Instance)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: longhorn-system
      toPorts:
        - ports:
            - port: "8000"    # Frontend UI
              protocol: TCP
            - port: "3260"    # iSCSI target (tgtd)
              protocol: TCP
            - port: "8500"    # Instance Manager gRPC API
              protocol: TCP
            - port: "8501"    # Instance Manager Proxy Service
              protocol: TCP
            - port: "8502"    # Instance Manager Disk Service
              protocol: TCP
            - port: "8503"    # Instance Manager Instance Service
              protocol: TCP
            - port: "9500"    # Manager metrics/communication
              protocol: TCP
            - port: "9501"    # Manager WebSocket
              protocol: TCP
            - port: "9443"    # Webhooks
              protocol: TCP
            - port: "9502"    # Admission webhook
              protocol: TCP
            - port: "9503"    # Recovery backend
              protocol: TCP
