---
# =============================================================================
# Istio AuthorizationPolicy for OAuth2 Proxy ext_authz
# =============================================================================
# Protects Longhorn UI by requiring authentication via OAuth2 Proxy
# In Istio ambient mode, must use targetRef with Gateway instead of selector
# =============================================================================

apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: oauth2-proxy-longhorn
  namespace: istio-system
spec:
  targetRef:
    kind: Gateway
    group: gateway.networking.k8s.io
    name: default-gateway
  action: CUSTOM
  provider:
    name: oauth2-proxy
  rules:
    - to:
        - operation:
            hosts:
              - "longhorn.PLACEHOLDER.example.com"  # Patched via Kustomize from common.domain
