{{- if .Values.features.ciliumEgressPolicy }}
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: rancher-client-allow-egress
  namespace: cattle-system
spec:
  description: "Allow cattle-cluster-agent egress to Rancher server, kube-apiserver and DNS"
  endpointSelector:
    matchLabels:
      app: cattle-cluster-agent
  egress:
    {{- $rancherHost := .Values.server.url | trimPrefix "https://" | trimPrefix "http://" }}
    - toFQDNs:
        - matchName: {{ $rancherHost | quote }}
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
    - toCIDR:
        - {{ .Values.server.ip }}/32
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
    - toEntities:
        - kube-apiserver
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: rancher-client-ingress
  namespace: cattle-system
spec:
  description: "Allow all ingress to cattle-system pods"
  endpointSelector: {}
  ingress:
    - fromEntities:
        - cluster
        - world
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: rancher-fleet-allow-egress
  namespace: cattle-fleet-system
spec:
  description: "Allow fleet-agent egress to Rancher server, kube-apiserver and DNS"
  endpointSelector: {}
  egress:
    - toFQDNs:
        - matchName: {{ $rancherHost | quote }}
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
    - toCIDR:
        - {{ .Values.server.ip }}/32
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
    - toEntities:
        - kube-apiserver
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: rancher-fleet-ingress
  namespace: cattle-fleet-system
spec:
  description: "Allow all ingress to cattle-fleet-system pods"
  endpointSelector: {}
  ingress:
    - fromEntities:
        - cluster
        - world
{{- end }}
