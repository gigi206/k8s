---
# =============================================================================
# ExternalSecret - Transform OIDC secret in istio-system namespace
# =============================================================================
# Transforme le secret source en secret utilisable par Kiali
# Le secret source est: istio-system/kiali-oidc-client-secret (créé par KSOPS)
# Le secret cible est utilisé par le Helm chart kiali-server
# =============================================================================

apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: kiali-oidc-external
  namespace: istio-system
spec:
  # Fréquence de refresh
  refreshInterval: 1h

  # Reference au ClusterSecretStore qui lit depuis istio-system namespace
  secretStoreRef:
    kind: ClusterSecretStore
    name: istio-system-oidc-secrets

  # Secret cible: kiali (nom attendu par kiali-server helm chart)
  # Kiali cherche le secret OIDC dans un secret nomme "kiali" avec la cle "oidc-secret"
  target:
    name: kiali
    creationPolicy: Owner
    deletionPolicy: Retain

  # Mapping des cles
  data:
    # Cle attendue par Kiali pour le client secret OIDC
    - secretKey: oidc-secret
      remoteRef:
        key: kiali-oidc-client-secret
        property: client-secret
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
