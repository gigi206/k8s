---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: istio
  namespace: argo-cd
  annotations:
    argocd.argoproj.io/sync-wave: "40"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Global config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # App-specific config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/istio/config/*.yaml

  template:
    metadata:
      name: 'istio'
      namespace: argo-cd
      labels:
        app: istio
        environment: '{{ .environment }}'
      annotations:
        argocd.argoproj.io/sync-wave: "40"
        notifications.argoproj.io/subscribe.on-sync-succeeded.slack: gitops-notifications
    spec:
      project: default
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ .istio.namespace }}'

  templatePatch: |
    spec:
      syncPolicy:
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
          - RespectIgnoreDifferences=true
      {{- if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
        retry:
          limit: 10
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 10m

      ignoreDifferences:
        # Ignore dynamic caBundle in ValidatingWebhookConfigurations
        - group: admissionregistration.k8s.io
          kind: ValidatingWebhookConfiguration
          name: istio-validator-istio-system
          jqPathExpressions:
            - .webhooks[]
        - group: admissionregistration.k8s.io
          kind: ValidatingWebhookConfiguration
          name: istiod-default-validator
          jqPathExpressions:
            - .webhooks[]
        # Ignore dynamic metadata in DaemonSet
        - group: apps
          kind: DaemonSet
          name: ztunnel
          namespace: istio-system
          jqPathExpressions:
            - .metadata.annotations["deprecated.daemonset.template.generation"]
            - .spec.template

      sources:
        # Source 0: Base resources (Namespace, IngressClass)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/resources
          directory:
            include: "*.yaml"

        # Source 1: Istio Base (CRDs)
        - repoURL: https://istio-release.storage.googleapis.com/charts
          chart: base
          targetRevision: {{ .istio.version }}
          helm:
            releaseName: istio-base
            valuesObject:
              global:
                istioNamespace: {{ .istio.namespace }}

        # Source 2: Istiod (Control Plane)
        - repoURL: https://istio-release.storage.googleapis.com/charts
          chart: istiod
          targetRevision: {{ .istio.version }}
          helm:
            releaseName: istiod
            valuesObject:
              # Use ambient profile for ambient mesh mode
              profile: ambient

              # Workaround: env must be defined as map (chart bug - template fails if env is nil)
              env: {}

              # Mesh configuration
              meshConfig:
                # Enable Kubernetes Ingress controller
                # Modes: OFF, STRICT (requires annotation), DEFAULT (all ingress)
                ingressControllerMode: DEFAULT
                ingressClass: istio
                ingressService: istio-ingressgateway
                ingressSelector: ingressgateway

              global:
                istioNamespace: {{ .istio.namespace }}

              # Pilot configuration
              pilot:
                replicaCount: {{ .istio.pilot.replicas }}
                resources:
                  requests:
                    cpu: {{ .istio.pilot.resources.requests.cpu }}
                    memory: {{ .istio.pilot.resources.requests.memory }}
                  limits:
                    cpu: {{ .istio.pilot.resources.limits.cpu }}
                    memory: {{ .istio.pilot.resources.limits.memory }}
                env:
                  PILOT_DEFAULT_WAYPOINT_REPLICAS: "{{ .istio.pilot.env.PILOT_DEFAULT_WAYPOINT_REPLICAS }}"

              # Metrics and monitoring
              telemetry:
                enabled: true
                v2:
                  enabled: true
                  prometheus:
                    enabled: true

        # Source 3: Istio CNI (Required for Ambient)
        - repoURL: https://istio-release.storage.googleapis.com/charts
          chart: cni
          targetRevision: {{ .istio.version }}
          helm:
            releaseName: istio-cni
            valuesObject:
              # Use ambient profile for ambient mesh mode
              profile: ambient

              global:
                istioNamespace: {{ .istio.namespace }}

              cni:
                # CNI chaining with Cilium
                chained: true
                cniBinDir: /opt/cni/bin
                cniConfDir: /etc/cni/net.d
                cniConfFileName: "05-cilium.conflist"

                # Resources for CNI DaemonSet
                resources:
                  requests:
                    cpu: {{ .istio.cni.resources.requests.cpu }}
                    memory: {{ .istio.cni.resources.requests.memory }}
                  limits:
                    cpu: {{ .istio.cni.resources.limits.cpu }}
                    memory: {{ .istio.cni.resources.limits.memory }}

        # Source 4: ztunnel (Ambient Data Plane)
        - repoURL: https://istio-release.storage.googleapis.com/charts
          chart: ztunnel
          targetRevision: {{ .istio.version }}
          helm:
            releaseName: ztunnel
            valuesObject:
              global:
                istioNamespace: {{ .istio.namespace }}

              # Resources for ztunnel DaemonSet
              resources:
                requests:
                  cpu: {{ .istio.ztunnel.resources.requests.cpu }}
                  memory: {{ .istio.ztunnel.resources.requests.memory }}
                limits:
                  cpu: {{ .istio.ztunnel.resources.limits.cpu }}
                  memory: {{ .istio.ztunnel.resources.limits.memory }}

        {{- if .kiali.enabled }}
        # Source 5: Kiali Server (Helm chart)
        - repoURL: https://kiali.org/helm-charts
          chart: kiali-server
          targetRevision: {{ .kiali.version }}
          helm:
            releaseName: kiali
            valuesObject:
              # Deployment configuration
              deployment:
                replicas: {{ .kiali.replicas }}
                resources:
                  requests:
                    cpu: {{ .kiali.resources.requests.cpu }}
                    memory: {{ .kiali.resources.requests.memory }}
                  limits:
                    cpu: {{ .kiali.resources.limits.cpu }}
                    memory: {{ .kiali.resources.limits.memory }}

              # Istio configuration
              external_services:
                istio:
                  root_namespace: {{ .istio.namespace }}
                  config_map_name: istio
                  istio_sidecar_injector_config_map_name: istio-sidecar-injector
                  istio_identity_domain: svc.cluster.local
                  url_service_version: http://istiod.{{ .istio.namespace }}:15014/version

                # Prometheus integration
                {{- if .features.monitoring.enabled }}
                prometheus:
                  url: http://{{ .features.monitoring.release }}-kube-prom-prometheus.monitoring:9090
                {{- end }}

                # Grafana integration (with basic auth)
                {{- if .features.monitoring.enabled }}
                grafana:
                  enabled: true
                  url: http://{{ .features.monitoring.release }}-grafana.monitoring:80
                  in_cluster_url: http://{{ .features.monitoring.release }}-grafana.monitoring:80
                  auth:
                    type: basic
                    username: secret:istio-system:kiali-grafana-credentials:username
                    password: secret:istio-system:kiali-grafana-credentials:password
                {{- end }}

                # Tracing (Jaeger) - disabled by default
                tracing:
                  enabled: false

              # Authentication strategy
              auth:
                strategy: {{ .kiali.auth.strategy }}

              # Server configuration
              server:
                port: 20001
                web_root: /

              # Kiali feature flags
              kiali_feature_flags:
                istio_injection_action: true
                ui_defaults:
                  graph:
                    traffic:
                      grpc: "requests"
                      http: "requests"
                      tcp: "sent"
        {{- end }}

        {{- if .features.gatewayAPI.httpRoute.enabled }}
        # Source: HTTPRoute (Gateway API) - conditional
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/httproute
        {{- end }}

        {{- if .features.monitoring.enabled }}
        # Source: PrometheusRules for monitoring Istio (with release label)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/kustomize
          kustomize:
            commonLabels:
              release: '{{ .features.monitoring.release }}'
        {{- end }}
