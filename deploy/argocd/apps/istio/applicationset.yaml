---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: istio
  namespace: argo-cd
  annotations:
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Global config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # App-specific config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/istio/config/*.yaml

  template:
    metadata:
      name: 'istio'
      namespace: argo-cd
      labels:
        app: istio
        environment: '{{ .environment }}'
      annotations:
    spec:
      project: default
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ .istio.namespace }}'

  templatePatch: |
    spec:
      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
          - {{ . }}
        {{- end }}
      {{- if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
        retry:
          limit: 10
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 10m

      ignoreDifferences:
        # Ignore auto-added fields in ExternalSecrets
        - group: external-secrets.io
          kind: ExternalSecret
          jqPathExpressions:
            - .spec.data[].remoteRef.conversionStrategy
            - .spec.data[].remoteRef.decodingStrategy
            - .spec.data[].remoteRef.metadataPolicy
        # Ignore dynamic caBundle in ValidatingWebhookConfigurations
        - group: admissionregistration.k8s.io
          kind: ValidatingWebhookConfiguration
          name: istio-validator-istio-system
          jqPathExpressions:
            - .webhooks[]
        - group: admissionregistration.k8s.io
          kind: ValidatingWebhookConfiguration
          name: istiod-default-validator
          jqPathExpressions:
            - .webhooks[]
        # Ignore dynamic metadata in DaemonSet
        - group: apps
          kind: DaemonSet
          name: ztunnel
          namespace: istio-system
          jqPathExpressions:
            - .metadata.annotations["deprecated.daemonset.template.generation"]
            - .spec.template

      sources:
        # Source 0: Namespace - always deployed
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/resources
          directory:
            include: "namespace.yaml"
        # Source 0b: IngressClass - always deployed
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/resources
          directory:
            include: "ingressclass.yaml"
        {{- if .features.cilium.defaultDenyPodIngress.enabled }}
        # Source 0c: Cilium internal ingress policy (monitoring, kube-system, istio-system)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/resources
          directory:
            include: "cilium-ingress-policy.yaml"
        {{- end }}
        {{- if .features.cilium.ingressPolicy.enabled }}
        # Source: Cilium ingress policy - conditional per Gateway provider
        {{- if eq .features.gatewayAPI.controller.provider "istio" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/resources
          directory:
            include: "cilium-ingress-policy-istio.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "apisix" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/resources
          directory:
            include: "cilium-ingress-policy-apisix.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "traefik" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/resources
          directory:
            include: "cilium-ingress-policy-traefik.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "nginx-gwf" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/resources
          directory:
            include: "cilium-ingress-policy-nginx-gwf.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "cilium" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/resources
          directory:
            include: "cilium-ingress-policy-cilium.yaml"
        {{- end }}
        {{- end }}
        {{- if .features.kyverno.enabled }}
        # Source: Kyverno PolicyException (allows SA token mount for K8s API access)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/resources
          directory:
            include: "kyverno-policy-exception.yaml"
        {{- end }}
        {{- if .istio.mtls.enabled }}
        # Source 0d: mTLS PeerAuthentication - mesh-wide mTLS enforcement
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/kustomize/mtls
          kustomize:
            patches:
              - target:
                  kind: PeerAuthentication
                  name: default
                patch: |
                  - op: replace
                    path: /spec/mtls/mode
                    value: {{ .istio.mtls.mode }}
        {{- end }}
        {{- if .features.sso.enabled }}
        # Source: SSO generic resources (ClusterSecretStore, ExternalSecrets, Telemetry)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/kustomize/sso
        {{- end }}
        {{- if and .features.sso.enabled (eq .features.sso.provider "keycloak") }}
        # Source: Keycloak-specific resources (Kiali client Job)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/kustomize/sso-keycloak
          kustomize:
            images:
              - 'curlimages/curl={{ .images.curl.repository }}:{{ .images.curl.tag }}'
            patches:
              - target:
                  kind: Job
                  name: kiali-keycloak-client
                patch: |
                  - op: replace
                    path: /spec/template/spec/containers/0/env/0/value
                    value: {{ .common.domain }}
        {{- end }}

        {{- if and .features.oauth2Proxy.enabled .features.gatewayAPI.httpRoute.enabled }}
        # Source: AuthorizationPolicy for OAuth2 Proxy ext_authz (Hubble UI protection)
        # Moved from Cilium to ensure Istio CRDs exist before AuthorizationPolicy is created
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/istio/kustomize/oauth2-authz
          kustomize:
            patches:
              - target:
                  kind: AuthorizationPolicy
                  name: oauth2-proxy-hubble
                patch: |
                  - op: replace
                    path: /spec/rules/0/to/0/operation/hosts/0
                    value: hubble.{{ .common.domain }}
        {{- end }}

        # Source: Encrypted secrets (KSOPS)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/secrets/{{ .environment }}

        # Source 1: Istio Base (CRDs)
        - repoURL: https://istio-release.storage.googleapis.com/charts
          chart: base
          targetRevision: {{ .istio.version }}
          helm:
            releaseName: istio-base
            valuesObject:
              global:
                istioNamespace: {{ .istio.namespace }}

        # Source 2: Istiod (Control Plane)
        - repoURL: https://istio-release.storage.googleapis.com/charts
          chart: istiod
          targetRevision: {{ .istio.version }}
          helm:
            releaseName: istiod
            valuesObject:
              # Use ambient profile for ambient mesh mode
              profile: ambient

              # Workaround: env must be defined as map (chart bug - template fails if env is nil)
              env: {}

              # Mesh configuration
              meshConfig:
                # Enable Kubernetes Ingress controller
                # Modes: OFF, STRICT (requires annotation), DEFAULT (all ingress)
                ingressControllerMode: DEFAULT
                ingressClass: istio
                ingressService: istio-ingressgateway
                ingressSelector: ingressgateway

                {{- if and .features.tracing.enabled (eq .features.tracing.provider "tempo") }}
                # Distributed tracing configuration (Tempo via OTLP)
                enableTracing: true
                defaultProviders:
                  tracing:
                    - otel
                extensionProviders:
                  - name: otel
                    opentelemetry:
                      service: {{ .istio.tracing.otlpAddress | replace ":4317" "" }}
                      port: 4317
                  # Access logging provider with JSON format including trace_id
                  - name: access-log-json
                    envoyFileAccessLog:
                      path: /dev/stdout
                      logFormat:
                        labels:
                          timestamp: "%START_TIME%"
                          method: "%REQ(:METHOD)%"
                          path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
                          protocol: "%PROTOCOL%"
                          response_code: "%RESPONSE_CODE%"
                          response_flags: "%RESPONSE_FLAGS%"
                          bytes_received: "%BYTES_RECEIVED%"
                          bytes_sent: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"
                          upstream_host: "%UPSTREAM_HOST%"
                          upstream_cluster: "%UPSTREAM_CLUSTER%"
                          trace_id: "%TRACE_ID%"
                          span_id: "%REQ(X-B3-SPANID)%"
                          authority: "%REQ(:AUTHORITY)%"
                          user_agent: "%REQ(USER-AGENT)%"
                          request_id: "%REQ(X-REQUEST-ID)%"
                {{- if and .features.sso.enabled .istio.extensionProviders .istio.extensionProviders.oauth2Proxy .istio.extensionProviders.oauth2Proxy.enabled }}
                  # OAuth2 Proxy extension provider for external authorization
                  # Security: FAIL-CLOSE - if OAuth2 is unavailable, access is DENIED
                  - name: oauth2-proxy
                    envoyExtAuthzHttp:
                      service: {{ .istio.extensionProviders.oauth2Proxy.service }}
                      port: {{ .istio.extensionProviders.oauth2Proxy.port }}
                      # FAIL-CLOSE: block access if auth service is unavailable
                      timeout: 5s
                      failOpen: false
                      statusOnError: "503"
                      headersToDownstreamOnDeny:
                        - content-type
                        - set-cookie
                      headersToUpstreamOnAllow:
                        - authorization
                        - path
                        - x-auth-request-user
                        - x-auth-request-email
                        - x-auth-request-access-token
                      headersToDownstreamOnAllow:
                        - set-cookie
                      includeRequestHeadersInCheck:
                        - authorization
                        - cookie
                      includeAdditionalHeadersInCheck:
                        X-Auth-Request-Redirect: '%REQ(x-forwarded-proto)%://%REQ(:authority)%%REQ(:path)%'
                      pathPrefix: /oauth2/auth
                {{- end }}
                defaultConfig:
                  tracing:
                    sampling: {{ .istio.tracing.sampling }}
                {{- else if and .features.tracing.enabled (eq .features.tracing.provider "jaeger") }}
                # Distributed tracing configuration (Jaeger via Zipkin)
                enableTracing: true
                defaultProviders:
                  tracing:
                    - zipkin
                extensionProviders:
                  - name: zipkin
                    zipkin:
                      service: {{ .istio.tracing.zipkinAddress | replace ":9411" "" }}
                      port: 9411
                  # Access logging provider with JSON format including trace_id
                  - name: access-log-json
                    envoyFileAccessLog:
                      path: /dev/stdout
                      logFormat:
                        labels:
                          timestamp: "%START_TIME%"
                          method: "%REQ(:METHOD)%"
                          path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
                          protocol: "%PROTOCOL%"
                          response_code: "%RESPONSE_CODE%"
                          response_flags: "%RESPONSE_FLAGS%"
                          bytes_received: "%BYTES_RECEIVED%"
                          bytes_sent: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"
                          upstream_host: "%UPSTREAM_HOST%"
                          upstream_cluster: "%UPSTREAM_CLUSTER%"
                          trace_id: "%TRACE_ID%"
                          span_id: "%REQ(X-B3-SPANID)%"
                          authority: "%REQ(:AUTHORITY)%"
                          user_agent: "%REQ(USER-AGENT)%"
                          request_id: "%REQ(X-REQUEST-ID)%"
                {{- if and .features.sso.enabled .istio.extensionProviders .istio.extensionProviders.oauth2Proxy .istio.extensionProviders.oauth2Proxy.enabled }}
                  # OAuth2 Proxy extension provider for external authorization
                  # Security: FAIL-CLOSE - if OAuth2 is unavailable, access is DENIED
                  - name: oauth2-proxy
                    envoyExtAuthzHttp:
                      service: {{ .istio.extensionProviders.oauth2Proxy.service }}
                      port: {{ .istio.extensionProviders.oauth2Proxy.port }}
                      # FAIL-CLOSE: block access if auth service is unavailable
                      timeout: 5s
                      failOpen: false
                      statusOnError: "503"
                      headersToDownstreamOnDeny:
                        - content-type
                        - set-cookie
                      headersToUpstreamOnAllow:
                        - authorization
                        - path
                        - x-auth-request-user
                        - x-auth-request-email
                        - x-auth-request-access-token
                      headersToDownstreamOnAllow:
                        - set-cookie
                      includeRequestHeadersInCheck:
                        - authorization
                        - cookie
                      includeAdditionalHeadersInCheck:
                        X-Auth-Request-Redirect: '%REQ(x-forwarded-proto)%://%REQ(:authority)%%REQ(:path)%'
                      pathPrefix: /oauth2/auth
                {{- end }}
                defaultConfig:
                  tracing:
                    sampling: {{ .istio.tracing.sampling }}
                    zipkin:
                      address: {{ .istio.tracing.zipkinAddress }}
                {{- else }}
                # No tracing - still define access logging provider for namespace-level enablement
                extensionProviders:
                  # Access logging provider with JSON format including trace_id
                  - name: access-log-json
                    envoyFileAccessLog:
                      path: /dev/stdout
                      logFormat:
                        labels:
                          timestamp: "%START_TIME%"
                          method: "%REQ(:METHOD)%"
                          path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
                          protocol: "%PROTOCOL%"
                          response_code: "%RESPONSE_CODE%"
                          response_flags: "%RESPONSE_FLAGS%"
                          bytes_received: "%BYTES_RECEIVED%"
                          bytes_sent: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"
                          upstream_host: "%UPSTREAM_HOST%"
                          upstream_cluster: "%UPSTREAM_CLUSTER%"
                          trace_id: "%TRACE_ID%"
                          span_id: "%REQ(X-B3-SPANID)%"
                          authority: "%REQ(:AUTHORITY)%"
                          user_agent: "%REQ(USER-AGENT)%"
                          request_id: "%REQ(X-REQUEST-ID)%"
                {{- if and .features.sso.enabled .istio.extensionProviders .istio.extensionProviders.oauth2Proxy .istio.extensionProviders.oauth2Proxy.enabled }}
                  # OAuth2 Proxy extension provider for external authorization
                  # Security: FAIL-CLOSE - if OAuth2 is unavailable, access is DENIED
                  - name: oauth2-proxy
                    envoyExtAuthzHttp:
                      service: {{ .istio.extensionProviders.oauth2Proxy.service }}
                      port: {{ .istio.extensionProviders.oauth2Proxy.port }}
                      # FAIL-CLOSE: block access if auth service is unavailable
                      timeout: 5s
                      failOpen: false
                      statusOnError: "503"
                      headersToDownstreamOnDeny:
                        - content-type
                        - set-cookie
                      headersToUpstreamOnAllow:
                        - authorization
                        - path
                        - x-auth-request-user
                        - x-auth-request-email
                        - x-auth-request-access-token
                      headersToDownstreamOnAllow:
                        - set-cookie
                      includeRequestHeadersInCheck:
                        - authorization
                        - cookie
                      includeAdditionalHeadersInCheck:
                        X-Auth-Request-Redirect: '%REQ(x-forwarded-proto)%://%REQ(:authority)%%REQ(:path)%'
                      pathPrefix: /oauth2/auth
                {{- end }}
                {{- end }}

              global:
                istioNamespace: {{ .istio.namespace }}

              # Pilot configuration
              pilot:
                replicaCount: {{ .istio.pilot.replicas }}
                resources:
                  requests:
                    cpu: {{ .istio.pilot.resources.requests.cpu }}
                    memory: {{ .istio.pilot.resources.requests.memory }}
                  limits:
                    cpu: {{ .istio.pilot.resources.limits.cpu }}
                    memory: {{ .istio.pilot.resources.limits.memory }}
                env:
                  PILOT_DEFAULT_WAYPOINT_REPLICAS: "{{ .istio.pilot.env.PILOT_DEFAULT_WAYPOINT_REPLICAS }}"

              # Metrics and monitoring
              telemetry:
                enabled: true
                v2:
                  enabled: true
                  prometheus:
                    enabled: true

        # Source 3: Istio CNI (Required for Ambient)
        - repoURL: https://istio-release.storage.googleapis.com/charts
          chart: cni
          targetRevision: {{ .istio.version }}
          helm:
            releaseName: istio-cni
            valuesObject:
              # Use ambient profile for ambient mesh mode
              profile: ambient

              global:
                istioNamespace: {{ .istio.namespace }}

              cni:
                # CNI chaining with Cilium
                chained: true
                cniBinDir: /opt/cni/bin
                cniConfDir: /etc/cni/net.d
                cniConfFileName: "05-cilium.conflist"

                # Resources for CNI DaemonSet
                resources:
                  requests:
                    cpu: {{ .istio.cni.resources.requests.cpu }}
                    memory: {{ .istio.cni.resources.requests.memory }}
                  limits:
                    cpu: {{ .istio.cni.resources.limits.cpu }}
                    memory: {{ .istio.cni.resources.limits.memory }}

        # Source 4: ztunnel (Ambient Data Plane)
        - repoURL: https://istio-release.storage.googleapis.com/charts
          chart: ztunnel
          targetRevision: {{ .istio.version }}
          helm:
            releaseName: ztunnel
            valuesObject:
              # Use distroless variant to match other Istio components
              variant: distroless

              global:
                istioNamespace: {{ .istio.namespace }}

              # Resources for ztunnel DaemonSet
              resources:
                requests:
                  cpu: {{ .istio.ztunnel.resources.requests.cpu }}
                  memory: {{ .istio.ztunnel.resources.requests.memory }}
                limits:
                  cpu: {{ .istio.ztunnel.resources.limits.cpu }}
                  memory: {{ .istio.ztunnel.resources.limits.memory }}

        {{- if .kiali.enabled }}
        # Source 5: Kiali Server (Helm chart)
        - repoURL: https://kiali.org/helm-charts
          chart: kiali-server
          targetRevision: {{ .kiali.version }}
          helm:
            releaseName: kiali
            valuesObject:
              # Deployment configuration
              deployment:
                replicas: {{ .kiali.replicas }}
                resources:
                  requests:
                    cpu: {{ .kiali.resources.requests.cpu }}
                    memory: {{ .kiali.resources.requests.memory }}
                  limits:
                    cpu: {{ .kiali.resources.limits.cpu }}
                    memory: {{ .kiali.resources.limits.memory }}
                # Mount CA certificate for TLS verification
                custom_secrets:
                  - name: root-ca
                    mount: /etc/ssl/certs/root-ca
                {{- if .features.monitoring.enabled }}
                  # Mount Grafana credentials for kiali-server helm chart
                  # See: https://kiali.io/docs/faq/installation/
                  - name: kiali-grafana-username
                    mount: /kiali-override-secrets/grafana-username
                  - name: kiali-grafana-password
                    mount: /kiali-override-secrets/grafana-password
                {{- end }}
                # Environment variable to use custom CA
                pod_annotations: {}
                pod_labels: {}
                custom_envs:
                  - name: SSL_CERT_FILE
                    value: /etc/ssl/certs/root-ca/ca.crt

              # Istio configuration
              external_services:
                istio:
                  root_namespace: {{ .istio.namespace }}
                  config_map_name: istio
                  istio_sidecar_injector_config_map_name: istio-sidecar-injector
                  istio_identity_domain: svc.cluster.local
                  url_service_version: http://istiod.{{ .istio.namespace }}:15014/version

                # Prometheus integration
                {{- if .features.monitoring.enabled }}
                prometheus:
                  url: http://{{ .features.monitoring.release }}-kube-prom-prometheus.monitoring:9090
                {{- end }}

                # Grafana integration (with basic auth via mounted secrets)
                {{- if .features.monitoring.enabled }}
                grafana:
                  enabled: true
                  external_url: http://{{ .features.monitoring.release }}-grafana.monitoring:80
                  internal_url: http://{{ .features.monitoring.release }}-grafana.monitoring:80
                  auth:
                    type: basic
                    username: secret:kiali-grafana-username:value.txt
                    password: secret:kiali-grafana-password:value.txt
                {{- end }}

                # Tracing integration (Tempo or Jaeger)
                {{- if and .features.tracing.enabled (eq .features.tracing.provider "tempo") }}
                tracing:
                  enabled: true
                  provider: tempo
                  in_cluster_url: http://tempo.tempo.svc.cluster.local:3100
                  use_grpc: false
                {{- else if and .features.tracing.enabled (eq .features.tracing.provider "jaeger") }}
                tracing:
                  enabled: true
                  in_cluster_url: http://jaeger-query.jaeger.svc.cluster.local:16686
                  url: https://jaeger.{{ .common.domain }}
                  use_grpc: false
                {{- else }}
                tracing:
                  enabled: false
                {{- end }}

              # Authentication strategy
              # When SSO disabled, force anonymous; otherwise use configured strategy
              # issuer_uri construit dynamiquement avec common.domain
              auth:
                {{- if .features.sso.enabled }}
                strategy: {{ .kiali.auth.strategy }}
                {{- if eq .kiali.auth.strategy "openid" }}
                openid:
                  client_id: {{ .kiali.auth.openid.clientId }}
                  issuer_uri: https://keycloak.{{ .common.domain }}/realms/{{ .kiali.auth.openid.realm }}
                  scopes:
                  {{- range .kiali.auth.openid.scopes }}
                    - {{ . }}
                  {{- end }}
                  username_claim: {{ .kiali.auth.openid.usernameClaim }}
                  disable_rbac: {{ .kiali.auth.openid.disableRbac }}
                {{- end }}
                {{- else }}
                # SSO disabled - use anonymous authentication
                strategy: anonymous
                {{- end }}

              # Server configuration
              server:
                port: 20001
                web_root: /
                # External URL configuration for OIDC redirects
                # See: https://github.com/kiali/kiali/issues/3111
                web_fqdn: kiali.{{ .common.domain }}
                web_port: "443"
                web_schema: https

              # Kiali feature flags
              kiali_feature_flags:
                istio_injection_action: true
                ui_defaults:
                  graph:
                    traffic:
                      grpc: "requests"
                      http: "requests"
                      tcp: "sent"
        {{- end }}

        {{- if .features.gatewayAPI.enabled }}
        {{- if .features.gatewayAPI.httpRoute.enabled }}
        # Source: HTTPRoute (Gateway API standard)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/kustomize/httproute
          kustomize:
            patches:
              - target:
                  kind: HTTPRoute
                  name: kiali
                patch: |
                  - op: replace
                    path: /spec/hostnames/0
                    value: kiali.{{ .common.domain }}
        {{- else if eq .features.gatewayAPI.controller.provider "apisix" }}
        # Source: APISIX native CRDs (when HTTPRoute disabled and provider is apisix)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/kustomize/apisix
          kustomize:
            patches:
              - target:
                  kind: ApisixRoute
                  name: kiali
                patch: |
                  - op: replace
                    path: /spec/http/0/match/hosts/0
                    value: kiali.{{ .common.domain }}
        {{- end }}
        {{- end }}

        {{- if .features.monitoring.enabled }}
        # Source: PrometheusRules for monitoring Istio (with release label)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: {{ .git.revision }}
          path: deploy/argocd/apps/istio/kustomize/monitoring
          kustomize:
            commonLabels:
              release: '{{ .features.monitoring.release }}'
        {{- end }}
