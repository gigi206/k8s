---
# =============================================================================
# Harbor ApplicationSet (Container Registry)
# =============================================================================
# Deploys Harbor container registry with Helm chart
# Integrates with: Rook/Ceph (storage), Prometheus (monitoring),
# Keycloak (SSO/OIDC), Gateway API (routing)
# Docs: https://goharbor.io/docs/
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: harbor
  namespace: argo-cd
  annotations:
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Global config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # App-specific config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/harbor/config/*.yaml

  template:
    metadata:
      name: harbor
      namespace: argo-cd
      annotations:
    spec:
      project: default

      sources:
        # Source: Harbor Helm Chart
        - repoURL: https://helm.goharbor.io
          targetRevision: '{{ .harbor.version }}'
          chart: harbor
          helm:
            releaseName: harbor

      destination:
        server: https://kubernetes.default.svc
        namespace: harbor

      syncPolicy:
        retry:
          limit: 10
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 10m

  templatePatch: |
    spec:
      ignoreDifferences:
        - group: external-secrets.io
          kind: ExternalSecret
          jqPathExpressions:
            - .spec.data[].remoteRef.conversionStrategy
            - .spec.data[].remoteRef.decodingStrategy
            - .spec.data[].remoteRef.metadataPolicy
            - .spec.target.deletionPolicy
            - .status
      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
          - {{ . }}
        {{- end }}
      {{- if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}

      sources:
        {{- if .rke2.cis.enabled }}
        # Source: Namespace with PSA labels for CIS profile compatibility
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "namespace.yaml"
        {{- end }}

        {{- if eq .features.storage.provider "rook" }}
        # Source: PreSync hook - Wait for Ceph storage before creating PVCs
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "ceph-storage-presync-check.yaml"
        {{- end }}

        # Source: SOPS-encrypted secrets (admin credentials + OIDC client secret)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/secrets/{{ .environment }}

        {{- if .features.networkPolicy.defaultDenyPodIngress.enabled }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium internal ingress policy (pod-to-pod communication)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "cilium-ingress-policy.yaml"
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico internal ingress policy (pod-to-pod communication)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "calico-ingress-policy.yaml"
          {{- end }}
        {{- end }}

        {{- if .features.networkPolicy.ingressPolicy.enabled }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium ingress policy - conditional per Gateway provider
        {{- if eq .features.gatewayAPI.controller.provider "istio" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "cilium-ingress-policy-istio.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "apisix" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "cilium-ingress-policy-apisix.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "traefik" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "cilium-ingress-policy-traefik.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "nginx-gwf" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "cilium-ingress-policy-nginx-gwf.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "envoy-gateway" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "cilium-ingress-policy-envoy-gateway.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "cilium" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "cilium-ingress-policy-cilium.yaml"
        {{- end }}
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico ingress policy - conditional per Gateway provider
        {{- if eq .features.gatewayAPI.controller.provider "istio" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "calico-ingress-policy-istio.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "apisix" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "calico-ingress-policy-apisix.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "traefik" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "calico-ingress-policy-traefik.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "nginx-gwf" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "calico-ingress-policy-nginx-gwf.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "envoy-gateway" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "calico-ingress-policy-envoy-gateway.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "cilium" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "calico-ingress-policy-cilium.yaml"
        {{- end }}
          {{- end }}
        {{- end }}

        {{- if .features.kyverno.enabled }}
        # Source: Kyverno PolicyException (allows SA token mount for Harbor jobs)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/resources
          directory:
            include: "kyverno-policy-exception.yaml"
        {{- end }}

        {{- if .features.gatewayAPI.enabled }}
        {{- if .features.gatewayAPI.httpRoute.enabled }}
        # Source: HTTPRoute (Gateway API standard)
        # NOTE: Harbor supports native OIDC - no gateway-level oauth2-proxy needed
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/kustomize/httproute
          kustomize:
            patches:
              - target:
                  kind: HTTPRoute
                  name: harbor
                patch: |
                  - op: replace
                    path: /spec/hostnames/0
                    value: harbor.{{ .common.domain }}
                  - op: replace
                    path: /spec/parentRefs/0/namespace
                    value: '{{ .features.gatewayAPI.controller.gatewayNamespace }}'
              - target:
                  kind: ReferenceGrant
                  name: gateway-harbor-tls
                patch: |
                  - op: replace
                    path: /spec/from/0/namespace
                    value: '{{ .features.gatewayAPI.controller.gatewayNamespace }}'
        {{- end }}
        {{- end }}

        {{- if .features.monitoring.enabled }}
        # Source: Prometheus monitoring (ServiceMonitor + PrometheusRules)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/kustomize/monitoring
          kustomize:
            commonLabels:
              release: '{{ .features.monitoring.release }}'
              grafana_dashboard: '{{ .features.monitoring.dashboard.label }}'
            commonAnnotations:
              "{{ .features.monitoring.dashboard.folderAnnotation }}": '{{ .features.monitoring.dashboard.baseFolder }}/{{ .dashboard.folder }}'
        {{- end }}

        {{- if and .features.sso.enabled (eq .features.sso.provider "keycloak") }}
        # Source: SSO - Keycloak OIDC client + Harbor OIDC configuration
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/harbor/kustomize/sso
          kustomize:
            images:
              - 'curlimages/curl={{ .images.curl.repository }}:{{ .images.curl.tag }}'
            patches:
              - target:
                  kind: Job
                  name: harbor-keycloak-oidc-client
                patch: |
                  - op: replace
                    path: /spec/template/spec/containers/0/env/0/value
                    value: {{ .common.domain }}
              - target:
                  kind: Job
                  name: harbor-oidc-config
                patch: |
                  - op: replace
                    path: /spec/template/spec/containers/0/env/0/value
                    value: {{ .common.domain }}
        {{- end }}

        # Source: Harbor Helm Chart
        - repoURL: https://helm.goharbor.io
          targetRevision: '{{ .harbor.version }}'
          chart: harbor
          helm:
            releaseName: harbor
            valuesObject:
              expose:
                type: '{{ .harbor.expose.type }}'
                tls:
                  enabled: false
                clusterIP:
                  name: harbor
              externalURL: https://harbor.{{ .common.domain }}
              internalTLS:
                enabled: {{ .harbor.internalTLS.enabled }}
              existingSecretAdminPassword: "harbor-admin-credentials"
              existingSecretAdminPasswordKey: "HARBOR_ADMIN_PASSWORD"
              caBundleSecretName: "root-ca"
              persistence:
                persistentVolumeClaim:
                  registry:
                    storageClass: '{{ .features.storage.class }}'
                    size: '{{ .harbor.persistence.registry.size }}'
                    annotations:
                      argocd.argoproj.io/sync-options: Prune=false
                  jobservice:
                    jobLog:
                      storageClass: '{{ .features.storage.class }}'
                      size: '{{ .harbor.persistence.jobservice.size }}'
                      annotations:
                        argocd.argoproj.io/sync-options: Prune=false
                  database:
                    storageClass: '{{ .features.storage.class }}'
                    size: '{{ .harbor.persistence.database.size }}'
                    annotations:
                      argocd.argoproj.io/sync-options: Prune=false
                  redis:
                    storageClass: '{{ .features.storage.class }}'
                    size: '{{ .harbor.persistence.redis.size }}'
                    annotations:
                      argocd.argoproj.io/sync-options: Prune=false
                  trivy:
                    storageClass: '{{ .features.storage.class }}'
                    size: '{{ .harbor.persistence.trivy.size }}'
                    annotations:
                      argocd.argoproj.io/sync-options: Prune=false
              portal:
                replicas: {{ .harbor.portal.replicas }}
              core:
                replicas: {{ .harbor.core.replicas }}
              jobservice:
                replicas: {{ .harbor.jobservice.replicas }}
              registry:
                replicas: {{ .harbor.registry.replicas }}
              trivy:
                enabled: true
                replicas: {{ .harbor.trivy.replicas }}
              {{- if .features.monitoring.enabled }}
              metrics:
                enabled: true
                serviceMonitor:
                  enabled: true
                  additionalLabels:
                    release: '{{ .features.monitoring.release }}'
              {{- end }}
              cache:
                enabled: true
                expireHours: 24
