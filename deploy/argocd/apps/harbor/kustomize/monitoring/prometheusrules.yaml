---
# =============================================================================
# Harbor - Prometheus Rules
# =============================================================================
# Alertes for Harbor container registry components
# =============================================================================

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: harbor-prometheus-rules
  namespace: harbor
  labels:
    prometheus: harbor
    role: alert-rules
spec:
  groups:
    # =========================================================================
    # Harbor Core Rules
    # =========================================================================
    - name: harbor-core.rules
      interval: 30s
      rules:
        # CRITICAL: Harbor core is down
        - alert: HarborCoreDown
          expr: |
            kube_deployment_status_replicas_available{
              deployment="harbor-core",
              namespace="harbor"
            } == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Harbor Core is down"
            description: "All Harbor Core pods are unavailable for 5 minutes."

        # HIGH: Harbor core pod restarting
        - alert: HarborCorePodRestarting
          expr: |
            rate(kube_pod_container_status_restarts_total{
              pod=~"harbor-core-.*",
              namespace="harbor"
            }[15m]) > 0
          for: 10m
          labels:
            severity: high
          annotations:
            summary: "Harbor Core pod is restarting"
            description: "Harbor Core pod {{ $labels.pod }} has been restarting."

    # =========================================================================
    # Harbor Registry Rules
    # =========================================================================
    - name: harbor-registry.rules
      interval: 30s
      rules:
        # CRITICAL: Harbor registry is down
        - alert: HarborRegistryDown
          expr: |
            kube_deployment_status_replicas_available{
              deployment="harbor-registry",
              namespace="harbor"
            } == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Harbor Registry is down"
            description: "All Harbor Registry pods are unavailable. Docker push/pull will fail."

        # WARNING: Harbor registry high storage usage
        - alert: HarborRegistryStorageHigh
          expr: |
            kubelet_volume_stats_available_bytes{
              persistentvolumeclaim=~"harbor-registry.*",
              namespace="harbor"
            } / kubelet_volume_stats_capacity_bytes{
              persistentvolumeclaim=~"harbor-registry.*",
              namespace="harbor"
            } < 0.2
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Harbor Registry storage running low"
            description: "Harbor Registry storage is below 20% available."

    # =========================================================================
    # Harbor Database Rules (CNPG)
    # =========================================================================
    - name: harbor-database.rules
      interval: 30s
      rules:
        # CRITICAL: Harbor CNPG database is down
        - alert: HarborDatabaseDown
          expr: |
            cnpg_collector_up{cluster="harbor-db"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Harbor Database is down"
            description: "Harbor PostgreSQL CNPG cluster 'harbor-db' is unreachable."

        # WARNING: High replication lag
        - alert: HarborDatabaseHighReplicationLag
          expr: |
            cnpg_pg_replication_lag{cluster="harbor-db"} > 30
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Harbor Database replication lag is high"
            description: "Harbor CNPG replication lag is {{ $value }}s (threshold: 30s)."

        # WARNING: Harbor database storage running low
        - alert: HarborDatabaseStorageLow
          expr: |
            kubelet_volume_stats_available_bytes{
              persistentvolumeclaim=~"harbor-db-.*",
              namespace="harbor"
            } / kubelet_volume_stats_capacity_bytes{
              persistentvolumeclaim=~"harbor-db-.*",
              namespace="harbor"
            } < 0.2
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Harbor Database storage running low"
            description: "Harbor CNPG database storage is below 20% available."

    # =========================================================================
    # Harbor Trivy Rules
    # =========================================================================
    - name: harbor-trivy.rules
      interval: 30s
      rules:
        # WARNING: Trivy vulnerability scanner is down
        - alert: HarborTrivyDown
          expr: |
            kube_statefulset_status_replicas_ready{
              statefulset="harbor-trivy",
              namespace="harbor"
            } == 0
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Harbor Trivy scanner is down"
            description: "Trivy vulnerability scanner is unavailable. Image scanning will not work."
---
# =============================================================================
# PodMonitor pour le cluster PostgreSQL CNPG
# =============================================================================
# Note: le label 'release' est injecte via Kustomize commonLabels
# IMPORTANT: Le nom doit etre different de "harbor-db" (nom du cluster CNPG)
# car CNPG supprime les PodMonitors portant le meme nom que le cluster
# quand enablePodMonitor=false

apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: harbor-postgresql
  namespace: harbor
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: harbor-db
      app.kubernetes.io/name: postgresql
  podMetricsEndpoints:
    - port: metrics
      metricRelabelings:
        - sourceLabels: [cluster]
          targetLabel: cnpg_cluster
