---
# =============================================================================
# ExternalSecret - Sync ArgoCD secrets from argo-cd namespace
# =============================================================================
# Synchronise les secrets ArgoCD depuis le secret source vers argocd-secret
# Le secret source est: argo-cd/argocd-oidc-client-secret (créé par KSOPS)
# Le secret cible remplace le secret argocd-secret créé par le chart Helm
# =============================================================================

apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: argocd-secret-external
  namespace: argo-cd
spec:
  # Fréquence de refresh
  refreshInterval: 1h

  # Reference au ClusterSecretStore qui lit depuis argo-cd namespace
  secretStoreRef:
    kind: ClusterSecretStore
    name: argo-cd-oidc-secrets

  # Secret cible: argocd-secret (utilisé par ArgoCD)
  target:
    name: argocd-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      metadata:
        labels:
          app.kubernetes.io/name: argocd-secret
          app.kubernetes.io/part-of: argocd

  # Mapping des clés depuis le secret source vers argocd-secret
  data:
    # Client secret OIDC Keycloak
    - secretKey: oidc.keycloak.clientSecret
      remoteRef:
        key: argocd-oidc-client-secret
        property: client-secret
    # Password admin ArgoCD
    - secretKey: admin.password
      remoteRef:
        key: argocd-oidc-client-secret
        property: admin-password
    # Clé de signature JWT
    - secretKey: server.secretkey
      remoteRef:
        key: argocd-oidc-client-secret
        property: server-secretkey
