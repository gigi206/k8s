---
# Configuration ArgoCD - Dev
environment: dev
appName: argocd

# Dashboard configuration
dashboard:
  folder: "ArgoCD"  # Subfolder under baseFolder for ArgoCD dashboards

argocd:
  version: "9.4.1"
  configs:
    params:
      "server.insecure": "true"  # Run server without TLS (TLS terminated by Gateway API)

    # ===================
    # OIDC Configuration (Keycloak)
    # ===================
    cm: {}
    # Note: Gateway and Keycloak health checks are built-in to ArgoCD

    # ===================
    # RBAC Configuration
    # ===================
    rbac:
      policy.default: role:readonly
      policy.csv: |
        # Groupe admins -> role:admin (acces complet)
        g, admins, role:admin
        # Groupe developers -> role:developer (sync apps)
        p, role:developer, applications, get, */*, allow
        p, role:developer, applications, sync, */*, allow
        p, role:developer, applications, action/*, */*, allow
        p, role:developer, logs, get, */*, allow
        p, role:developer, exec, create, */*, allow
        g, developers, role:developer
        # Groupe readonly -> role:readonly (lecture seule, defaut)
        g, readonly, role:readonly
      scopes: "[groups]"

  # KSOPS init container (actual: idle, runs once at startup)
  ksops:
    resources:
      requests:
        cpu: "5m"
        memory: "32Mi"
      limits:
        cpu: "50m"
        memory: "64Mi"

  server:
    ingress:
      enabled: false  # Disabled - using Gateway API HTTPRoute instead
      # hostname managed by ApplicationSet: argocd.{{ .common.domain }}
    replicas: 1
    resources:
      requests:
        cpu: "5m"
        memory: "50Mi"
      limits:
        cpu: "200m"
        memory: "256Mi"
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  controller:
    replicas: 1
    resources:
      requests:
        cpu: "60m"
        memory: "1Gi"
      limits:
        cpu: "2000m"
        memory: "2Gi"
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  repoServer:
    replicas: 1
    resources:
      requests:
        cpu: "15m"
        memory: "128Mi"
      limits:
        cpu: "2000m"
        memory: "512Mi"
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  # Dex/SSO disabled for dev
  dex:
    enabled: false

  # ApplicationSet controller (actual: 13m/46Mi)
  applicationSet:
    resources:
      requests:
        cpu: "15m"
        memory: "64Mi"
      limits:
        cpu: "100m"
        memory: "128Mi"
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  # Notifications controller (actual: 1m/39Mi)
  notifications:
    resources:
      requests:
        cpu: "5m"
        memory: "50Mi"
      limits:
        cpu: "50m"
        memory: "128Mi"
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  # Redis (actual: 4m/35Mi)
  redis:
    ha: false
    resources:
      requests:
        cpu: "10m"
        memory: "45Mi"
      limits:
        cpu: "200m"
        memory: "128Mi"

syncPolicy:
  automated:
    enabled: true
    prune: true
    selfHeal: true
