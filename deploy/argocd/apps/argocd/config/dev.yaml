---
# Configuration ArgoCD - Dev
environment: dev
appName: argocd

# Dashboard configuration
dashboard:
  folder: "ArgoCD"  # Subfolder under baseFolder for ArgoCD dashboards

# versions:
#   argocd: "9.0.5"

argocd:
  configs:
    params:
      "server.insecure": "true"  # Run server without TLS (TLS terminated by Gateway API)

    # ===================
    # OIDC Configuration (Keycloak)
    # ===================
    cm:
      url: "https://argocd.gigix"
      oidc.config: |
        name: Keycloak
        issuer: https://keycloak.gigix/realms/gigix
        clientID: argocd
        clientSecret: $oidc.keycloak.clientSecret
        requestedScopes:
          - openid
          - profile
          - email
          - groups
        enablePKCEAuthentication: true

    # ===================
    # RBAC Configuration
    # ===================
    rbac:
      policy.default: role:readonly
      policy.csv: |
        # Groupe admins -> role:admin (acces complet)
        g, admins, role:admin
        # Groupe developers -> role:developer (sync apps)
        p, role:developer, applications, get, */*, allow
        p, role:developer, applications, sync, */*, allow
        p, role:developer, applications, action/*, */*, allow
        p, role:developer, logs, get, */*, allow
        p, role:developer, exec, create, */*, allow
        g, developers, role:developer
        # Groupe readonly -> role:readonly (lecture seule, defaut)
        g, readonly, role:readonly
      scopes: "[groups]"

  server:
    ingress:
      enabled: false  # Disabled - using Gateway API HTTPRoute instead
      # hostname managed by ApplicationSet: argocd.{{ .common.domain }}
    replicas: 1
    resources:
      requests:
        cpu: "100m"
        memory: "128Mi"
      limits:
        cpu: "200m"
        memory: "256Mi"
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  controller:
    replicas: 1
    resources:
      requests:
        cpu: "500m"
        memory: "1Gi"
      limits:
        cpu: "2000m"
        memory: "2Gi"
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  repoServer:
    replicas: 1
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  # Redis (single instance for dev)
  redis:
    ha: false

  # Dex/SSO disabled for dev
  dex:
    enabled: false

  # ApplicationSet controller
  applicationSet:
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  # Notifications controller
  notifications:
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

syncPolicy:
  automated:
    enabled: true
    prune: true
    selfHeal: true
