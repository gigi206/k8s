---
# Configuration ArgoCD - Prod
environment: prod
appName: argocd

# Dashboard configuration
dashboard:
  folder: "ArgoCD"  # Subfolder under baseFolder for ArgoCD dashboards

argocd:
  version: "9.1.8"
  configs:
    params:
      "server.insecure": "false"

    # ===================
    # RBAC Configuration
    # ===================
    rbac:
      policy.default: role:readonly
      policy.csv: |
        # Groupe admins -> role:admin (acces complet)
        g, admins, role:admin
        # Groupe developers -> role:developer (sync apps)
        p, role:developer, applications, get, */*, allow
        p, role:developer, applications, sync, */*, allow
        p, role:developer, applications, action/*, */*, allow
        p, role:developer, logs, get, */*, allow
        p, role:developer, exec, create, */*, allow
        g, developers, role:developer
        # Groupe readonly -> role:readonly (lecture seule, defaut)
        g, readonly, role:readonly
      scopes: "[groups]"

  server:
    ingress:
      enabled: true
      # hostname managed by ApplicationSet: argocd.{{ .common.domain }}
    replicas: 3
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  controller:
    replicas: 3
    resources:
      requests:
        cpu: "500m"
        memory: "512Mi"
      limits:
        cpu: "2000m"
        memory: "2Gi"
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  repoServer:
    replicas: 3
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  # Redis HA for production
  redis:
    ha: true

  # Dex disabled - using native OIDC with Keycloak
  dex:
    enabled: false

  # ApplicationSet controller
  applicationSet:
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

  # Notifications controller
  notifications:
    metrics:
      serviceMonitor:
        relabelings:
          - targetLabel: cluster
            replacement: in-cluster
            action: replace

syncPolicy:
  automated:
    enabled: false  # Prod: manual sync
    prune: true
    selfHeal: true
