---
# =============================================================================
# CiliumNetworkPolicy - ArgoCD Internal Ingress
# =============================================================================
# Allows internal communication within argo-cd namespace and from
# dependent namespaces (monitoring, kube-system)
# =============================================================================
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: argocd-internal
  namespace: argo-cd
spec:
  description: "Allow internal ingress to ArgoCD"
  endpointSelector: {}  # Applies to all pods in argo-cd namespace

  ingress:
    # Allow from monitoring namespace (Prometheus scrape)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: monitoring
      toPorts:
        - ports:
            - port: "8080"    # ApplicationSet controller metrics
              protocol: TCP
            - port: "8082"    # Application controller metrics
              protocol: TCP
            - port: "8083"    # Server metrics
              protocol: TCP
            - port: "8084"    # Repo server metrics
              protocol: TCP
            - port: "8085"    # Controller metrics
              protocol: TCP
            - port: "8087"    # Notifications metrics
              protocol: TCP
            - port: "9001"    # Notifications controller metrics
              protocol: TCP
            - port: "9121"    # Redis exporter metrics
              protocol: TCP

    # Allow webhook calls from kube-apiserver (all nodes)
    # Uses host + remote-node because the API server may run on any node
    # (as a host process in K3d/K3s or as a pod in kube-system)
    - fromEntities:
        - host
        - remote-node
      toPorts:
        - ports:
            - port: "8443"    # Webhook server
              protocol: TCP

    # Allow internal ArgoCD communication (same namespace)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: argo-cd
      toPorts:
        - ports:
            - port: "8080"    # Server HTTP
              protocol: TCP
            - port: "8443"    # Server gRPC
              protocol: TCP
            - port: "8081"    # Repo Server gRPC
              protocol: TCP
            - port: "6379"    # Redis cache
              protocol: TCP
            - port: "8083"    # Server metrics
              protocol: TCP
            - port: "8084"    # Repo server metrics
              protocol: TCP
            - port: "8085"    # Controller metrics
              protocol: TCP
            - port: "8086"    # ApplicationSet metrics
              protocol: TCP
            - port: "8087"    # Notifications metrics
              protocol: TCP
            - port: "9121"    # Redis metrics
              protocol: TCP
