---
# =============================================================================
# CiliumNetworkPolicy - ArgoCD External Egress
# =============================================================================
# Allows ArgoCD to reach external services:
# - GitHub (git repositories)
# - Helm registries (charts.helm.sh, ghcr.io, etc.)
# - Container registries (for Kustomize remote bases)
#
# Internal cluster traffic (kube-apiserver, DNS, pod-to-pod) is already allowed
# by the CiliumClusterwideNetworkPolicy (default-deny-external-egress).
# This policy only adds external access for ArgoCD.
#
# See: deploy/argocd/apps/cilium/resources/default-deny-external-egress.yaml
# =============================================================================

apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: argocd-allow-external-egress
  namespace: argo-cd
spec:
  description: "Allow ArgoCD to access external Git repos and Helm registries"

  # Apply to all pods in argo-cd namespace
  endpointSelector: {}

  egress:
    # Allow HTTPS to external services (GitHub, Helm registries, container registries)
    - toEntities:
        - world
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
            - port: "22"
              protocol: TCP  # SSH for git clone

    # Allow access to ingress gateway (LoadBalancer) for OIDC to Keycloak
    # The LoadBalancer IP is a private RFC1918 IP not included in "world"
    - toCIDR:
        - 192.168.121.0/24
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
