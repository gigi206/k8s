---
# =============================================================================
# Calico NetworkPolicy - cert-manager External Egress
# =============================================================================
# Calico equivalent of cilium-egress-policy.yaml
#
# Allows cert-manager to reach ACME servers for certificate issuance:
# - Let's Encrypt (acme-v02.api.letsencrypt.org, etc.)
# - Other ACME providers
#
# notNets excludes internal cluster CIDRs (pod + service) so this rule
# only matches traffic destined for external endpoints.
# =============================================================================

apiVersion: crd.projectcalico.org/v1
kind: NetworkPolicy
metadata:
  name: cert-manager-allow-external-egress
  namespace: cert-manager
spec:
  selector: all()
  types:
    - Egress
  egress:
    # Allow DNS (required: this policy creates implicit deny on all egress)
    - action: Allow
      protocol: UDP
      destination:
        ports: [53]
    - action: Allow
      protocol: TCP
      destination:
        ports: [53]
    # Allow cluster-internal traffic (pod + service + node CIDRs)
    # Node CIDR required for BPF DNAT (ClusterIP -> node IP before policy eval)
    - action: Allow
      destination:
        nets:
          - "10.42.0.0/16"
          - "10.43.0.0/16"
          - "192.168.121.0/24"
    # Allow HTTPS to ACME servers (Let's Encrypt, etc.)
    - action: Allow
      protocol: TCP
      destination:
        notNets:
          - "10.42.0.0/16"
          - "10.43.0.0/16"
        ports:
          - 443
