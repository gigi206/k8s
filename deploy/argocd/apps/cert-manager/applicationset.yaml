---
# =============================================================================
# Cert-Manager ApplicationSet (Certificate Management)
# =============================================================================
# Déploie Cert-Manager pour gérer automatiquement les certificats TLS
# Docs: https://cert-manager.io/
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: cert-manager
  namespace: argo-cd
  annotations:
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Config de base (valeurs par défaut)
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # Config spécifique à l'application
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/cert-manager/config/*.yaml

  template:
    metadata:
      name: cert-manager
      namespace: argo-cd
      annotations:
    spec:
      project: default

      # Sources fully defined in templatePatch (conditional logic)
      # This placeholder is required by ArgoCD but will be replaced
      sources:
        - repoURL: https://charts.jetstack.io
          targetRevision: '{{ .certManager.version }}'
          chart: cert-manager

      destination:
        server: https://kubernetes.default.svc
        namespace: cert-manager

      syncPolicy:
        retry:
          limit: 10
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 10m

  templatePatch: |
    spec:
      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
          - {{ . }}
        {{- end }}
      {{- if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
      sources:
        {{- if .features.networkPolicy.egressPolicy.enabled }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium egress policy
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/cert-manager/resources
          directory:
            include: "cilium-egress-policy.yaml"
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico egress policy
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/cert-manager/resources
          directory:
            include: "calico-egress-policy.yaml"
          {{- end }}
        {{- end }}
        {{- if .features.networkPolicy.ingressPolicy.enabled }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium ingress policy
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/cert-manager/resources
          directory:
            include: "cilium-ingress-policy.yaml"
          {{- if eq .cluster.distribution "k3d" }}
        # Source: Supplementary K3d webhook policy (host+remote-node fallback)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/cert-manager/resources
          directory:
            include: "cilium-webhook-policy-k3d.yaml"
          {{- end }}
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico ingress policy
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/cert-manager/resources
          directory:
            include: "calico-ingress-policy.yaml"
          {{- end }}
        {{- end }}
        {{- if .features.kyverno.enabled }}
        # Source: Kyverno PolicyException (allows SA token mount for K8s API access)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/cert-manager/resources
          directory:
            include: "kyverno-policy-exception.yaml"
        {{- end }}
        {{- if .features.monitoring.enabled }}
        # Source 3: Prometheus monitoring (conditional) - with dynamic release label
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/cert-manager/kustomize/monitoring
          kustomize:
            commonLabels:
              release: '{{ .features.monitoring.release }}'
              grafana_dashboard: '{{ .features.monitoring.dashboard.label }}'

            commonAnnotations:
              "{{ .features.monitoring.dashboard.folderAnnotation }}": '{{ .features.monitoring.dashboard.baseFolder }}/{{ .dashboard.folder }}'
        {{- end }}
        - repoURL: https://charts.jetstack.io
          targetRevision: '{{ .certManager.version }}'
          chart: cert-manager
          helm:
            parameters:
            # CRDs installation (required)
            - name: crds.enabled
              value: "true"
            - name: crds.keep
              value: "true"

            {{- if .features.monitoring.enabled }}
            # Prometheus metrics
            - name: prometheus.enabled
              value: 'true'
            - name: prometheus.servicemonitor.enabled
              value: 'true'
            - name: prometheus.servicemonitor.labels.release
              value: '{{ .features.monitoring.release }}'
            {{- end }}

            # Gateway API support - disabled when provider is APISIX (manages its own Gateway API)
            {{- if and .certManager.gatewayAPI.enabled (ne .features.gatewayAPI.controller.provider "apisix") }}
            - name: config.enableGatewayAPI
              value: "true"
            {{- end }}

            # Controller replicas and resources
            {{- if .certManager.replicas }}
            - name: replicaCount
              value: "{{ .certManager.replicas }}"
            {{- end }}
            {{- if .certManager.resources }}
            - name: resources.requests.cpu
              value: '{{ .certManager.resources.requests.cpu }}'
            - name: resources.requests.memory
              value: '{{ .certManager.resources.requests.memory }}'
            - name: resources.limits.cpu
              value: '{{ .certManager.resources.limits.cpu }}'
            - name: resources.limits.memory
              value: '{{ .certManager.resources.limits.memory }}'
            {{- end }}

            # Webhook configuration
            {{- if .certManager.webhook.replicas }}
            - name: webhook.replicaCount
              value: "{{ .certManager.webhook.replicas }}"
            {{- end }}
            {{- if .certManager.webhook.resources }}
            - name: webhook.resources.requests.cpu
              value: '{{ .certManager.webhook.resources.requests.cpu }}'
            - name: webhook.resources.requests.memory
              value: '{{ .certManager.webhook.resources.requests.memory }}'
            - name: webhook.resources.limits.cpu
              value: '{{ .certManager.webhook.resources.limits.cpu }}'
            - name: webhook.resources.limits.memory
              value: '{{ .certManager.webhook.resources.limits.memory }}'
            {{- end }}

            # CA Injector configuration
            {{- if .certManager.cainjector.replicas }}
            - name: cainjector.replicaCount
              value: "{{ .certManager.cainjector.replicas }}"
            {{- end }}
            {{- if .certManager.cainjector.resources }}
            - name: cainjector.resources.requests.cpu
              value: '{{ .certManager.cainjector.resources.requests.cpu }}'
            - name: cainjector.resources.requests.memory
              value: '{{ .certManager.cainjector.resources.requests.memory }}'
            - name: cainjector.resources.limits.cpu
              value: '{{ .certManager.cainjector.resources.limits.cpu }}'
            - name: cainjector.resources.limits.memory
              value: '{{ .certManager.cainjector.resources.limits.memory }}'
            {{- end }}

            # Startup API Check
            {{- if .certManager.startupapicheck.resources }}
            - name: startupapicheck.resources.requests.cpu
              value: '{{ .certManager.startupapicheck.resources.requests.cpu }}'
            - name: startupapicheck.resources.requests.memory
              value: '{{ .certManager.startupapicheck.resources.requests.memory }}'
            - name: startupapicheck.resources.limits.cpu
              value: '{{ .certManager.startupapicheck.resources.limits.cpu }}'
            - name: startupapicheck.resources.limits.memory
              value: '{{ .certManager.startupapicheck.resources.limits.memory }}'
            {{- end }}
        # Source 2: ClusterIssuers, ClusterSecretStore, and webhook readiness check
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: 'deploy/argocd/apps/{{ .appName }}/resources'
          directory:
            include: "{cluster-secret-store.yaml,clusterissuer-selfsigned.yaml,webhook-readiness-check.yaml}"
