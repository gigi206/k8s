---
# =============================================================================
# Keycloak Client Creation Job for OAuth2 Proxy
# =============================================================================
# Creates the oauth2-proxy OIDC client in Keycloak realm
# =============================================================================

apiVersion: batch/v1
kind: Job
metadata:
  name: oauth2-proxy-keycloak-client
  namespace: keycloak
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: create-client
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          image: curlimages/curl:8.17.0
          env:
            - name: DOMAIN
              value: "PLACEHOLDER.example.com"  # Patched via Kustomize from common.domain
            - name: KEYCLOAK_URL
              value: "http://keycloak-service.keycloak.svc.cluster.local:8080"
            - name: KEYCLOAK_HEALTH_URL
              value: "https://keycloak-service.keycloak.svc.cluster.local:9000"
            - name: REALM
              value: "k8s"
            - name: CLIENT_ID
              value: "oauth2-proxy"
            - name: KEYCLOAK_ADMIN
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin-credentials
                  key: username
            - name: KEYCLOAK_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin-credentials
                  key: password
            - name: CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: oauth2-proxy-oidc-client-secret
                  key: client-secret
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              echo "=== Creating OAuth2 Proxy client in Keycloak ==="

              # Wait for Keycloak to be ready (up to 20 min - keycloak depends on
              # cnpg, external-secrets, cert-manager and can take ~13 min to start)
              echo "Waiting for Keycloak to be ready..."
              MAX_RETRIES=240
              RETRY_INTERVAL=5
              RETRY_COUNT=0

              until curl -sk -o /dev/null -w "%{http_code}" "${KEYCLOAK_HEALTH_URL}/health/ready" | grep -q "200"; do
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
                  echo "ERROR: Keycloak not ready after $((MAX_RETRIES * RETRY_INTERVAL)) seconds"
                  exit 1
                fi
                [ $((RETRY_COUNT % 12)) -eq 0 ] && echo "Keycloak not ready yet (attempt ${RETRY_COUNT}/${MAX_RETRIES})"
                sleep $RETRY_INTERVAL
              done
              echo "Keycloak is ready!"

              # Wait for realm to exist (realm import happens after Keycloak starts,
              # there is a ~60s gap between health check and realm availability)
              echo "Waiting for realm '$REALM'..."
              REALM_READY=false
              for i in $(seq 1 120); do
                if curl -sk -o /dev/null -w "%{http_code}" "${KEYCLOAK_URL}/realms/${REALM}/.well-known/openid-configuration" | grep -q "200"; then
                  echo "Realm '$REALM' is ready (after $i attempts)"
                  REALM_READY=true
                  break
                fi
                [ $((i % 12)) -eq 0 ] && echo "Attempt $i/120 - Realm not ready, waiting..."
                sleep 5
              done

              if [ "$REALM_READY" != "true" ]; then
                echo "ERROR: Realm '$REALM' not ready after 10 minutes"
                exit 1
              fi

              # Get admin token
              echo "Getting admin token..."
              TOKEN=$(curl -sk -X POST "${KEYCLOAK_URL}/realms/master/protocol/openid-connect/token" \
                -H "Content-Type: application/x-www-form-urlencoded" \
                -d "username=${KEYCLOAK_ADMIN}" \
                -d "password=${KEYCLOAK_ADMIN_PASSWORD}" \
                -d "grant_type=password" \
                -d "client_id=admin-cli" | sed -n 's/.*"access_token":"\([^"]*\)".*/\1/p')

              if [ -z "$TOKEN" ]; then
                echo "ERROR: Failed to get admin token"
                exit 1
              fi
              echo "Got admin token"

              # Check if client exists
              echo "Checking if client exists..."
              CLIENT_EXISTS=$(curl -sk -o /dev/null -w "%{http_code}" \
                -H "Authorization: Bearer ${TOKEN}" \
                "${KEYCLOAK_URL}/admin/realms/${REALM}/clients?clientId=${CLIENT_ID}")

              # Client payload - OAuth2 Proxy needs specific redirect URIs
              # Also includes redirect URIs for Envoy Gateway native OIDC
              CLIENT_PAYLOAD=$(cat <<EOF
              {
                "clientId": "${CLIENT_ID}",
                "name": "OAuth2 Proxy",
                "description": "OAuth2 Proxy for protecting apps (Prometheus, Alertmanager, Hubble, Longhorn, Harbor)",
                "enabled": true,
                "clientAuthenticatorType": "client-secret",
                "secret": "${CLIENT_SECRET}",
                "redirectUris": [
                  "https://oauth2.${DOMAIN}/oauth2/callback",
                  "https://prometheus.${DOMAIN}/oauth2/callback",
                  "https://alertmanager.${DOMAIN}/oauth2/callback",
                  "https://hubble.${DOMAIN}/oauth2/callback",
                  "https://longhorn.${DOMAIN}/oauth2/callback",
                  "https://jaeger.${DOMAIN}/oauth2/callback",
                  "https://harbor.${DOMAIN}/oauth2/callback"
                ],
                "webOrigins": [
                  "https://prometheus.${DOMAIN}",
                  "https://alertmanager.${DOMAIN}",
                  "https://hubble.${DOMAIN}",
                  "https://longhorn.${DOMAIN}",
                  "https://harbor.${DOMAIN}"
                ],
                "publicClient": false,
                "protocol": "openid-connect",
                "standardFlowEnabled": true,
                "implicitFlowEnabled": false,
                "directAccessGrantsEnabled": false,
                "serviceAccountsEnabled": false,
                "attributes": {
                  "pkce.code.challenge.method": "S256",
                  "post.logout.redirect.uris": "https://prometheus.${DOMAIN}/*##https://alertmanager.${DOMAIN}/*##https://hubble.${DOMAIN}/*##https://longhorn.${DOMAIN}/*##https://harbor.${DOMAIN}/*"
                },
                "defaultClientScopes": [
                  "openid",
                  "profile",
                  "email",
                  "groups"
                ]
              }
              EOF
              )

              # Create or update client
              EXISTING_CLIENT=$(curl -sk \
                -H "Authorization: Bearer ${TOKEN}" \
                "${KEYCLOAK_URL}/admin/realms/${REALM}/clients?clientId=${CLIENT_ID}")

              if echo "$EXISTING_CLIENT" | grep -q "\"id\""; then
                # Client exists, get ID and update
                CLIENT_UUID=$(echo "$EXISTING_CLIENT" | sed -n 's/\[{"id":"\([^"]*\)".*/\1/p')
                echo "Client exists with ID: ${CLIENT_UUID}, updating..."

                RESPONSE=$(curl -sk -w "\n%{http_code}" -X PUT \
                  -H "Authorization: Bearer ${TOKEN}" \
                  -H "Content-Type: application/json" \
                  -d "${CLIENT_PAYLOAD}" \
                  "${KEYCLOAK_URL}/admin/realms/${REALM}/clients/${CLIENT_UUID}")
                HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

                if [ "$HTTP_CODE" = "204" ]; then
                  echo "Client updated successfully"
                else
                  echo "ERROR: Failed to update client (HTTP $HTTP_CODE)"
                  echo "$RESPONSE"
                  exit 1
                fi
              else
                # Client doesn't exist, create it
                echo "Creating new client..."
                RESPONSE=$(curl -sk -w "\n%{http_code}" -X POST \
                  -H "Authorization: Bearer ${TOKEN}" \
                  -H "Content-Type: application/json" \
                  -d "${CLIENT_PAYLOAD}" \
                  "${KEYCLOAK_URL}/admin/realms/${REALM}/clients")
                HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

                if [ "$HTTP_CODE" = "201" ]; then
                  echo "Client created successfully"
                else
                  echo "ERROR: Failed to create client (HTTP $HTTP_CODE)"
                  echo "$RESPONSE"
                  exit 1
                fi
              fi

              echo "=== Done ==="
