---
# =============================================================================
# OAuth2 Proxy ApplicationSet - Wave 81 (Authentication)
# =============================================================================
# Déploie OAuth2 Proxy pour l'authentification OIDC avec Keycloak
# Utilisé en mode ext_authz avec Istio (auth seulement, pas de proxy du trafic)
# Docs: https://oauth2-proxy.github.io/oauth2-proxy/
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: oauth2-proxy
  namespace: argo-cd
  annotations:
    argocd.argoproj.io/sync-wave: "81"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/oauth2-proxy/config/*.yaml

  template:
    metadata:
      name: oauth2-proxy
      namespace: argo-cd
      annotations:
        argocd.argoproj.io/sync-wave: "81"
    spec:
      project: default

      source:
        repoURL: https://oauth2-proxy.github.io/manifests
        targetRevision: '{{ .oauth2Proxy.version }}'
        chart: oauth2-proxy

      destination:
        server: https://kubernetes.default.svc
        namespace: oauth2-proxy

      syncPolicy:
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 5m

  templatePatch: |
    spec:
      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
          - {{ . }}
        {{- end }}
      {{- if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
      sources:
        # Source 1: Namespace, AuthorizationPolicies (with domain patches)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/oauth2-proxy/resources
          kustomize:
            patches:
              - target:
                  kind: AuthorizationPolicy
                  name: oauth2-proxy-prometheus
                patch: |
                  - op: replace
                    path: /spec/rules/0/to/0/operation/hosts/0
                    value: prometheus.{{ .common.domain }}
              - target:
                  kind: AuthorizationPolicy
                  name: oauth2-proxy-alertmanager
                patch: |
                  - op: replace
                    path: /spec/rules/0/to/0/operation/hosts/0
                    value: alertmanager.{{ .common.domain }}
              - target:
                  kind: AuthorizationPolicy
                  name: oauth2-proxy-hubble
                patch: |
                  - op: replace
                    path: /spec/rules/0/to/0/operation/hosts/0
                    value: hubble.{{ .common.domain }}
              - target:
                  kind: AuthorizationPolicy
                  name: oauth2-proxy-longhorn
                patch: |
                  - op: replace
                    path: /spec/rules/0/to/0/operation/hosts/0
                    value: longhorn.{{ .common.domain }}
        # Source 2: Encrypted secrets (KSOPS)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/oauth2-proxy/secrets/{{ .environment }}
        {{- if .features.gatewayAPI.httpRoute.enabled }}
        # Source 3: HTTPRoute (Gateway API)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/oauth2-proxy/httproute
          kustomize:
            patches:
              - target:
                  kind: HTTPRoute
                  name: oauth2-proxy
                patch: |
                  - op: replace
                    path: /spec/hostnames/0
                    value: oauth2.{{ .common.domain }}
        {{- end }}
        # Source 4: Helm chart
        - repoURL: https://oauth2-proxy.github.io/manifests
          targetRevision: '{{ .oauth2Proxy.version }}'
          chart: oauth2-proxy
          helm:
            valuesObject:
              # Replica count
              replicaCount: {{ .oauth2Proxy.replicas | default 1 }}

              # Configuration for ext_authz mode
              config:
                # Use existing secret containing client-id, client-secret, cookie-secret
                existingSecret: oauth2-proxy-secrets
                cookieName: "_oauth2_proxy"

              extraArgs:
                # OIDC Provider (Keycloak)
                provider: oidc
                provider-display-name: "Keycloak"
                # Internal URL for OIDC discovery (server-to-server)
                # Note: Keycloak returns HTTPS URLs in discovery, so browser redirects work correctly
                oidc-issuer-url: "http://keycloak-service.keycloak.svc.cluster.local:8080/realms/k8s"
                # Internal URLs for server-to-server communication (more efficient than external)
                redeem-url: "http://keycloak-service.keycloak.svc.cluster.local:8080/realms/k8s/protocol/openid-connect/token"
                profile-url: "http://keycloak-service.keycloak.svc.cluster.local:8080/realms/k8s/protocol/openid-connect/userinfo"
                oidc-jwks-url: "http://keycloak-service.keycloak.svc.cluster.local:8080/realms/k8s/protocol/openid-connect/certs"

                # Redirect URL (OAuth2 Proxy's callback)
                redirect-url: "https://oauth2.{{ .common.domain }}/oauth2/callback"

                # PKCE (Proof Key for Code Exchange) - required by Keycloak
                code-challenge-method: S256

                # Cookie settings
                cookie-domain: ".{{ .common.domain }}"
                cookie-expire: "168h"
                cookie-refresh: "1h"
                cookie-samesite: "none"
                cookie-secure: "true"
                cookie-csrf-per-request: "false"
                cookie-csrf-expire: "5m"

                # Whitelist domains for redirects
                whitelist-domain: ".{{ .common.domain }}"

                # Email/user settings
                email-domain: "*"

                # Skip provider verification for self-signed certs (dev)
                {{- if .oauth2Proxy.oidc.skipProviderVerify }}
                skip-provider-button: true
                insecure-oidc-skip-issuer-verification: true
                ssl-insecure-skip-verify: true
                {{- end }}

                # Upstream for health checks only (not used in ext_authz mode)
                upstream: "static://200"

                # Enable auth response headers
                set-xauthrequest: true
                set-authorization-header: true
                pass-access-token: true
                pass-authorization-header: true

                # Reverse proxy mode (for ext_authz)
                reverse-proxy: true

              # Service for ext_authz
              service:
                type: ClusterIP
                portNumber: 4180

              # Ingress disabled (we use HTTPRoute)
              ingress:
                enabled: false

              {{- if .features.monitoring.enabled }}
              # Prometheus metrics
              metrics:
                enabled: true
                servicemonitor:
                  enabled: true
                  labels:
                    release: "{{ .features.monitoring.release }}"
              {{- end }}

              {{- if and .features.sso.enabled (eq .features.sso.provider "keycloak") }}
              # Init container to wait for Keycloak OIDC discovery endpoint
              # Only when using local Keycloak as SSO provider
              initContainers:
                - name: wait-for-keycloak
                  image: curlimages/curl:8.5.0
                  command:
                    - /bin/sh
                    - -c
                    - |
                      echo "Waiting for Keycloak OIDC discovery endpoint..."
                      until curl -sf http://keycloak-service.keycloak.svc.cluster.local:8080/realms/k8s/.well-known/openid-configuration > /dev/null 2>&1; do
                        echo "Keycloak not ready yet, waiting 5s..."
                        sleep 5
                      done
                      echo "Keycloak OIDC discovery endpoint is available!"
              {{- end }}

              # Resources
              resources:
                requests:
                  cpu: {{ .oauth2Proxy.resources.requests.cpu | default "50m" }}
                  memory: {{ .oauth2Proxy.resources.requests.memory | default "64Mi" }}
                limits:
                  cpu: {{ .oauth2Proxy.resources.limits.cpu | default "100m" }}
                  memory: {{ .oauth2Proxy.resources.limits.memory | default "128Mi" }}
