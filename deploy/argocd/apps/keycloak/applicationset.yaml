---
# =============================================================================
# Keycloak ApplicationSet (Identity & Access Management)
# =============================================================================
# Deploie l'operateur Keycloak officiel et une instance Keycloak
# avec PostgreSQL gere par CloudNativePG
# Docs: https://www.keycloak.org/operator/installation
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: keycloak
  namespace: argo-cd
  annotations:
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Config de base (valeurs par defaut)
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # Config specifique a l'application
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/keycloak/config/*.yaml

  template:
    metadata:
      name: keycloak
      namespace: argo-cd
      annotations:
    spec:
      project: default

      sources:
        # Source 1: Keycloak Operator (CRDs + Deployment) - repo officiel
        - repoURL: https://github.com/keycloak/keycloak-k8s-resources
          targetRevision: '{{ .keycloak.operatorVersion }}'
          path: kubernetes

      destination:
        server: https://kubernetes.default.svc
        namespace: keycloak

      syncPolicy:
        retry:
          limit: 10
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 10m

  templatePatch: |
    spec:
      # Ignore fields managed by controllers (CNPG, Prometheus Operator, External Secrets)
      ignoreDifferences:
        - group: postgresql.cnpg.io
          kind: Cluster
          managedFieldsManagers:
            - manager
          jqPathExpressions:
            - .spec
        - group: monitoring.coreos.com
          kind: PodMonitor
          jqPathExpressions:
            - .spec.podMetricsEndpoints
        - group: external-secrets.io
          kind: ExternalSecret
          jqPathExpressions:
            - .spec.data[].remoteRef.conversionStrategy
            - .spec.data[].remoteRef.decodingStrategy
            - .spec.data[].remoteRef.metadataPolicy
            - .spec.target.deletionPolicy
            - .status
      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
          - {{ . }}
        {{- end }}
      {{- if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
      sources:
        # Source: PreSync hook - Wait for CNPG webhook before creating PostgreSQL Cluster
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "cnpg-webhook-presync-check.yaml"

        {{- if eq .features.storage.provider "rook" }}
        # Source: PreSync hook - Wait for Ceph storage before creating PostgreSQL PVC
        # Prevents ~9 min wait when PVC is created before Ceph is ready
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "ceph-storage-presync-check.yaml"
        {{- end }}

        {{- if .rke2.cis.enabled }}
        # Source: Namespace with PSA labels for CIS profile compatibility
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "namespace.yaml"
        {{- end }}
        # Source 1: Keycloak Operator (CRDs + Deployment) - repo officiel
        - repoURL: https://github.com/keycloak/keycloak-k8s-resources
          targetRevision: '{{ .keycloak.operatorVersion }}'
          path: kubernetes

        # Source 2: PostgreSQL Cluster (CNPG) - sync-wave -1
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "cluster-postgresql.yaml"

        # Source 2b: DB Readiness Check Job - sync-wave 0
        # Waits for PostgreSQL to be ready before Keycloak CR is created
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "db-readiness-check.yaml"

        # Source 3: Keycloak CR instance (with domain patches) - sync-wave 1
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/kustomize/custom-resources
          kustomize:
            patches:
              - target:
                  kind: Keycloak
                  name: keycloak
                patch: |
                  - op: replace
                    path: /spec/hostname/hostname
                    value: https://keycloak.{{ .common.domain }}
              - target:
                  kind: Certificate
                  name: keycloak-tls-cert
                patch: |
                  - op: replace
                    path: /spec/commonName
                    value: keycloak.{{ .common.domain }}
                  - op: replace
                    path: /spec/dnsNames/0
                    value: keycloak.{{ .common.domain }}

        # Source 4: KeycloakRealmImport - Realm k8s (base: groups, roles, scopes, admin)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "realm-k8s.yaml"

        # Source 5: ClusterSecretStore (pour ExternalSecrets cross-namespace)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "cluster-secret-store.yaml"

        # Source 6: ExternalSecrets for OIDC clients (reverse sync from app namespaces)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "external-secrets-oidc-clients.yaml"

        # Source 7: Secrets (KSOPS) - environment specific
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/secrets/{{ .environment }}

        {{- if .features.networkPolicy.defaultDenyPodIngress.enabled }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium internal ingress policy (pod-to-pod communication)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "cilium-ingress-policy.yaml"
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico internal ingress policy (pod-to-pod communication)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "calico-ingress-policy.yaml"
          {{- end }}
        {{- end }}

        {{- if .features.networkPolicy.ingressPolicy.enabled }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium ingress policy - conditional per Gateway provider
        {{- if eq .features.gatewayAPI.controller.provider "istio" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "cilium-ingress-policy-istio.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "apisix" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "cilium-ingress-policy-apisix.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "traefik" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "cilium-ingress-policy-traefik.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "nginx-gwf" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "cilium-ingress-policy-nginx-gwf.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "envoy-gateway" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "cilium-ingress-policy-envoy-gateway.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "cilium" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "cilium-ingress-policy-cilium.yaml"
        {{- end }}
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico ingress policy - conditional per Gateway provider
        {{- if eq .features.gatewayAPI.controller.provider "istio" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "calico-ingress-policy-istio.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "apisix" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "calico-ingress-policy-apisix.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "traefik" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "calico-ingress-policy-traefik.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "nginx-gwf" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "calico-ingress-policy-nginx-gwf.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "envoy-gateway" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "calico-ingress-policy-envoy-gateway.yaml"
        {{- else if eq .features.gatewayAPI.controller.provider "cilium" }}
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "calico-ingress-policy-cilium.yaml"
        {{- end }}
          {{- end }}
        {{- end }}
        {{- if .features.kyverno.enabled }}
        # Source: Kyverno PolicyException (allows SA token mount for K8s API access)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/resources
          directory:
            include: "kyverno-policy-exception.yaml"
        {{- end }}

        {{- if .features.gatewayAPI.enabled }}
        {{- if .features.gatewayAPI.httpRoute.enabled }}
        # Source 9: HTTPRoute (Gateway API standard)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/kustomize/httproute
          kustomize:
            patches:
              - target:
                  kind: HTTPRoute
                  name: keycloak
                patch: |
                  - op: replace
                    path: /spec/hostnames/0
                    value: keycloak.{{ .common.domain }}
                  - op: replace
                    path: /spec/parentRefs/0/namespace
                    value: '{{ .features.gatewayAPI.controller.gatewayNamespace }}'
        {{- else if eq .features.gatewayAPI.controller.provider "apisix" }}
        # Source 9: APISIX native CRDs (when HTTPRoute disabled and provider is apisix)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/kustomize/apisix
          kustomize:
            patches:
              - target:
                  kind: ApisixRoute
                  name: keycloak
                patch: |
                  - op: replace
                    path: /spec/http/0/match/hosts/0
                    value: keycloak.{{ .common.domain }}
        {{- end }}
        {{- end }}

        {{- if .features.monitoring.enabled }}
        # Source 10: Prometheus monitoring (conditional)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/keycloak/kustomize/monitoring
          kustomize:
            commonLabels:
              release: '{{ .features.monitoring.release }}'
              grafana_dashboard: '{{ .features.monitoring.dashboard.label }}'
            commonAnnotations:
              "{{ .features.monitoring.dashboard.folderAnnotation }}": '{{ .features.monitoring.dashboard.baseFolder }}/{{ .dashboard.folder }}'
        {{- end }}
