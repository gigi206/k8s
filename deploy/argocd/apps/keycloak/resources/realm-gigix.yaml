---
# =============================================================================
# KeycloakRealmImport - Realm "gigix" (Base)
# =============================================================================
# Ce CRD importe le realm de base avec:
# - Groupes (admins, developers, readonly)
# - Roles realm (admin, developer, readonly)
# - Client scope "groups" pour mapper les groupes dans les tokens
# - Utilisateur admin initial
#
# NOTE: Les clients OIDC sont deployés par chaque application individuellement
# via leur propre KeycloakRealmImport (architecture apps autonomes).
# Voir: argocd/resources/keycloak-client.yaml
#       prometheus-stack/resources/keycloak-client.yaml
# =============================================================================

apiVersion: k8s.keycloak.org/v2alpha1
kind: KeycloakRealmImport
metadata:
  name: gigix-realm
  namespace: keycloak
spec:
  keycloakCRName: keycloak
  realm:
    # ===================
    # Realm Configuration
    # ===================
    id: gigix
    realm: gigix
    displayName: "Gigix Infrastructure"
    enabled: true

    # Token lifespans
    accessTokenLifespan: 300           # 5 minutes
    ssoSessionIdleTimeout: 1800        # 30 minutes
    ssoSessionMaxLifespan: 36000       # 10 heures
    accessCodeLifespan: 60             # 1 minute
    accessCodeLifespanUserAction: 300  # 5 minutes

    # ===================
    # Realm Roles
    # ===================
    roles:
      realm:
        - name: admin
          description: "Administrateur complet de l'infrastructure"
          composite: false
        - name: developer
          description: "Developpeur avec acces lecture/ecriture limite"
          composite: false
        - name: readonly
          description: "Acces en lecture seule"
          composite: false

    # ===================
    # Groups
    # ===================
    groups:
      - name: admins
        path: /admins
        realmRoles:
          - admin
        attributes:
          description:
            - "Groupe des administrateurs infrastructure"
      - name: developers
        path: /developers
        realmRoles:
          - developer
        attributes:
          description:
            - "Groupe des developpeurs"
      - name: readonly
        path: /readonly
        realmRoles:
          - readonly
        attributes:
          description:
            - "Groupe lecture seule"

    # ===================
    # Client Scopes
    # ===================
    clientScopes:
      # Scope pour inclure les groupes dans les tokens
      - name: groups
        protocol: openid-connect
        description: "Scope pour inclure les groupes utilisateur dans le token"
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"
        protocolMappers:
          - name: groups
            protocol: openid-connect
            protocolMapper: oidc-group-membership-mapper
            consentRequired: false
            config:
              full.path: "false"
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: "groups"
              userinfo.token.claim: "true"

    # ===================
    # Default Client Scopes
    # ===================
    defaultDefaultClientScopes:
      - profile
      - email
      - roles
      - web-origins
      - acr
    defaultOptionalClientScopes:
      - offline_access
      - address
      - phone
      - microprofile-jwt
      - groups

    # ===================
    # NOTE: Les clients OIDC sont deployés par chaque app (voir note en-tête)
    # ===================

    # ===================
    # Users
    # ===================
    users:
      - username: admin
        enabled: true
        email: admin@gigix
        emailVerified: true
        firstName: Admin
        lastName: Infrastructure
        credentials:
          - type: password
            value: "$(env:ADMIN_PASSWORD)"
            temporary: true
        groups:
          - /admins
        realmRoles:
          - admin

  # ===================
  # Secret Placeholders
  # ===================
  # Reference au secret K8s pour le mot de passe admin
  # NOTE: Les secrets des clients OIDC sont gérés par chaque app
  placeholders:
    ADMIN_PASSWORD:
      secret:
        name: keycloak-admin-credentials
        key: admin-password
