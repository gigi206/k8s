---
# =============================================================================
# KeycloakRealmImport - Realm "k8s" (Base)
# =============================================================================
# Ce CRD importe le realm de base avec:
# - Groupes (admins, developers, readonly)
# - Roles realm (admin, developer, readonly)
# - Client scope "groups" pour mapper les groupes dans les tokens
# - Utilisateur admin initial
#
# NOTE: Les clients OIDC sont deployés par chaque application individuellement
# via leur propre KeycloakRealmImport (architecture apps autonomes).
# Voir: argocd/resources/keycloak-client.yaml
#       prometheus-stack/resources/keycloak-client.yaml
# =============================================================================

apiVersion: k8s.keycloak.org/v2alpha1
kind: KeycloakRealmImport
metadata:
  name: k8s-realm
  namespace: keycloak
spec:
  keycloakCRName: keycloak
  realm:
    # ===================
    # Realm Configuration
    # ===================
    id: k8s
    realm: k8s
    displayName: "K8s Infrastructure"
    enabled: true

    # Token lifespans
    accessTokenLifespan: 300           # 5 minutes
    ssoSessionIdleTimeout: 1800        # 30 minutes
    ssoSessionMaxLifespan: 36000       # 10 heures
    accessCodeLifespan: 60             # 1 minute
    accessCodeLifespanUserAction: 300  # 5 minutes

    # ===================
    # Realm Roles
    # ===================
    roles:
      realm:
        - name: admin
          description: "Administrateur complet de l'infrastructure"
          composite: false
        - name: developer
          description: "Developpeur avec acces lecture/ecriture limite"
          composite: false
        - name: readonly
          description: "Acces en lecture seule"
          composite: false

    # ===================
    # Groups
    # ===================
    groups:
      - name: admins
        path: /admins
        realmRoles:
          - admin
        attributes:
          description:
            - "Groupe des administrateurs infrastructure"
      - name: developers
        path: /developers
        realmRoles:
          - developer
        attributes:
          description:
            - "Groupe des developpeurs"
      - name: readonly
        path: /readonly
        realmRoles:
          - readonly
        attributes:
          description:
            - "Groupe lecture seule"

    # ===================
    # Client Scopes
    # ===================
    clientScopes:
      # Standard OIDC scopes
      - name: openid
        protocol: openid-connect
        description: "OpenID Connect scope"
        attributes:
          include.in.token.scope: "true"

      - name: profile
        protocol: openid-connect
        description: "OpenID Connect profile scope"
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"
          consent.screen.text: "${profileScopeConsentText}"
        protocolMappers:
          - name: username
            protocol: openid-connect
            protocolMapper: oidc-usermodel-property-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: "username"
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: "preferred_username"
              jsonType.label: "String"
          - name: full name
            protocol: openid-connect
            protocolMapper: oidc-full-name-mapper
            consentRequired: false
            config:
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
          - name: family name
            protocol: openid-connect
            protocolMapper: oidc-usermodel-property-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: "lastName"
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: "family_name"
              jsonType.label: "String"
          - name: given name
            protocol: openid-connect
            protocolMapper: oidc-usermodel-property-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: "firstName"
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: "given_name"
              jsonType.label: "String"

      - name: email
        protocol: openid-connect
        description: "OpenID Connect email scope"
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"
          consent.screen.text: "${emailScopeConsentText}"
        protocolMappers:
          - name: email
            protocol: openid-connect
            protocolMapper: oidc-usermodel-property-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: "email"
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: "email"
              jsonType.label: "String"
          - name: email verified
            protocol: openid-connect
            protocolMapper: oidc-usermodel-property-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: "emailVerified"
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: "email_verified"
              jsonType.label: "boolean"

      - name: roles
        protocol: openid-connect
        description: "OpenID Connect roles scope"
        attributes:
          include.in.token.scope: "false"
        protocolMappers:
          - name: realm roles
            protocol: openid-connect
            protocolMapper: oidc-usermodel-realm-role-mapper
            consentRequired: false
            config:
              user.attribute: "foo"
              access.token.claim: "true"
              claim.name: "realm_access.roles"
              jsonType.label: "String"
              multivalued: "true"
          - name: audience resolve
            protocol: openid-connect
            protocolMapper: oidc-audience-resolve-mapper
            consentRequired: false

      - name: web-origins
        protocol: openid-connect
        description: "OpenID Connect web origins scope"
        attributes:
          include.in.token.scope: "false"
        protocolMappers:
          - name: allowed web origins
            protocol: openid-connect
            protocolMapper: oidc-allowed-origins-mapper
            consentRequired: false

      - name: acr
        protocol: openid-connect
        description: "OpenID Connect ACR scope"
        attributes:
          include.in.token.scope: "false"
        protocolMappers:
          - name: acr loa level
            protocol: openid-connect
            protocolMapper: oidc-acr-mapper
            consentRequired: false
            config:
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"

      # Scope pour inclure les groupes dans les tokens
      - name: groups
        protocol: openid-connect
        description: "Scope pour inclure les groupes utilisateur dans le token"
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"
        protocolMappers:
          - name: groups
            protocol: openid-connect
            protocolMapper: oidc-group-membership-mapper
            consentRequired: false
            config:
              full.path: "false"
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: "groups"
              userinfo.token.claim: "true"

    # ===================
    # Default Client Scopes
    # ===================
    defaultDefaultClientScopes:
      - openid  # Required for OIDC
      - profile
      - email
      - roles
      - web-origins
      - acr
      - groups  # Include groups in all clients by default
    defaultOptionalClientScopes:
      - offline_access
      - address
      - phone
      - microprofile-jwt

    # ===================
    # NOTE: Les clients OIDC sont deployés par chaque app (voir note en-tête)
    # ===================

    # ===================
    # Users
    # ===================
    users:
      - username: admin
        enabled: true
        email: admin@k8s.lan
        emailVerified: true
        firstName: Admin
        lastName: Infrastructure
        credentials:
          - type: password
            value: "$(env:ADMIN_PASSWORD)"
            temporary: false
        groups:
          - /admins
        realmRoles:
          - admin

  # ===================
  # Secret Placeholders
  # ===================
  # Reference au secret K8s pour le mot de passe admin
  # NOTE: Les secrets des clients OIDC sont gérés par chaque app
  placeholders:
    ADMIN_PASSWORD:
      secret:
        name: keycloak-admin-credentials
        key: password
