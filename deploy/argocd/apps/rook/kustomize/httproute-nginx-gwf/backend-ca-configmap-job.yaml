---
# =============================================================================
# Job - Extract Ceph Dashboard CA certificate for BackendTLSPolicy
# =============================================================================
# Extracts the TLS certificate from the Ceph Dashboard and creates a ConfigMap
# that can be referenced by BackendTLSPolicy for nginx-gateway-fabric.
#
# The Ceph Dashboard uses a self-signed certificate, so we use the certificate
# itself as the CA for validation purposes.
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: ceph-dashboard-extract-ca
  namespace: rook-ceph
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  backoffLimit: 10
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: ceph-dashboard-ca-extractor
      containers:
        - name: extract-ca
          image: docker.io/bitnami/kubectl:latest
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -e
              echo "=== Extracting Ceph Dashboard CA Certificate ==="

              # Wait for the dashboard service to be ready
              echo "Waiting for Ceph Dashboard to be accessible..."
              for i in $(seq 1 60); do
                if timeout 5 bash -c "echo | openssl s_client -connect ceph-dashboard-https.rook-ceph.svc:8443 2>/dev/null" | grep -q "BEGIN CERTIFICATE"; then
                  echo "Ceph Dashboard is accessible"
                  break
                fi
                echo "Attempt $i/60 - Dashboard not ready, waiting..."
                sleep 10
              done

              # Extract the certificate
              CERT=$(echo | openssl s_client -connect ceph-dashboard-https.rook-ceph.svc:8443 2>/dev/null | openssl x509)
              if [ -z "$CERT" ]; then
                echo "ERROR: Failed to extract certificate"
                exit 1
              fi

              echo "Certificate extracted successfully"
              echo "$CERT"

              # Create or update the ConfigMap
              echo "Creating/updating ConfigMap ceph-dashboard-backend-ca..."
              kubectl create configmap ceph-dashboard-backend-ca \
                --namespace=rook-ceph \
                --from-literal=ca.crt="$CERT" \
                --dry-run=client -o yaml | kubectl apply -f -

              echo "=== CA Certificate Extraction Complete ==="
---
# ServiceAccount for the Job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ceph-dashboard-ca-extractor
  namespace: rook-ceph
---
# Role to create/update ConfigMaps
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ceph-dashboard-ca-extractor
  namespace: rook-ceph
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["create", "update", "patch", "get"]
---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ceph-dashboard-ca-extractor
  namespace: rook-ceph
subjects:
  - kind: ServiceAccount
    name: ceph-dashboard-ca-extractor
    namespace: rook-ceph
roleRef:
  kind: Role
  name: ceph-dashboard-ca-extractor
  apiGroup: rbac.authorization.k8s.io
