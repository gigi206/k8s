---
# =============================================================================
# Alloy ApplicationSet (Log Collector)
# =============================================================================
# Deploys Grafana Alloy as a DaemonSet for log collection.
# Sends logs to Loki .
# Docs: https://grafana.com/docs/alloy/latest/
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: alloy
  namespace: argo-cd
  annotations:
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Global config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # App-specific config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/alloy/config/*.yaml

  template:
    metadata:
      name: alloy
      namespace: argo-cd
      annotations:
    spec:
      project: default

      source:
        repoURL: https://grafana.github.io/helm-charts
        targetRevision: '{{ .alloy.version }}'
        chart: alloy

      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ .alloy.namespace }}'

      syncPolicy:
        retry:
          limit: 10
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 10m

  templatePatch: |
    spec:
      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
          - {{ . }}
        {{- end }}
      {{- if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
      sources:
        {{- if .rke2.cis.enabled }}
        # Source: Namespace with PSA labels for CIS profile compatibility
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/alloy/resources
          directory:
            include: "namespace.yaml"
        {{- end }}
        {{- if .features.networkPolicy.ingressPolicy.enabled }}
          {{- if eq .cni.primary "cilium" }}
        # Source: Cilium ingress policy
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/alloy/resources
          directory:
            include: "cilium-ingress-policy.yaml"
          {{- else if eq .cni.primary "calico" }}
        # Source: Calico ingress policy
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/alloy/resources
          directory:
            include: "calico-ingress-policy.yaml"
          {{- end }}
        {{- end }}
        {{- if .features.kubescape.enabled }}
        # Source: Kubescape exceptions for log collector hostPath access
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/alloy/resources
          directory:
            include: "kubescape-exceptions.yaml"
        {{- end }}
        {{- if .features.kyverno.enabled }}
        # Source: Kyverno PolicyException (allows SA token mount for K8s API access)
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/alloy/resources
          directory:
            include: "kyverno-policy-exception.yaml"
        {{- end }}

        # Source 1: Alloy Helm Chart
        - repoURL: https://grafana.github.io/helm-charts
          targetRevision: '{{ .alloy.version }}'
          chart: alloy
          helm:
            releaseName: alloy
            valuesObject:
              # Config reloader resources
              {{- if .alloy.configReloader }}
              {{- if .alloy.configReloader.resources }}
              configReloader:
                resources:
                  requests:
                    cpu: '{{ .alloy.configReloader.resources.requests.cpu }}'
                    memory: '{{ .alloy.configReloader.resources.requests.memory }}'
                  limits:
                    cpu: '{{ .alloy.configReloader.resources.limits.cpu }}'
                    memory: '{{ .alloy.configReloader.resources.limits.memory }}'
              {{- end }}
              {{- end }}

              # Controller type (daemonset for log collection)
              controller:
                type: '{{ .alloy.controller.type }}'
                {{- if or .alloy.logs.journal.enabled .alloy.logs.rke2.enabled (and .rke2.cis.enabled .alloy.logs.audit.enabled) }}
                volumes:
                  extra:
                    {{- if .alloy.logs.journal.enabled }}
                    - name: journal
                      hostPath:
                        path: /var/log/journal
                        type: Directory
                    {{- end }}
                    {{- if .alloy.logs.rke2.enabled }}
                    - name: rke2-logs
                      hostPath:
                        path: /var/lib/rancher/rke2/agent/logs
                        type: Directory
                    - name: rke2-containerd
                      hostPath:
                        path: /var/lib/rancher/rke2/agent/containerd
                        type: Directory
                    {{- end }}
                    {{- if and .rke2.cis.enabled .alloy.logs.audit.enabled }}
                    # Kubernetes API audit logs (only on control-plane nodes)
                    - name: rke2-audit
                      hostPath:
                        path: /var/lib/rancher/rke2/server/logs
                        type: DirectoryOrCreate
                    {{- end }}
                {{- end }}

              {{- if .alloy.logs.journal.enabled }}
              # Pod security context for journal access (GID 999=systemd-journal, 4=adm)
              global:
                podSecurityContext:
                  fsGroup: 999
                  supplementalGroups:
                    - 999
                    - 4
              {{- end }}

              # Alloy configuration
              alloy:
                # Enable clustering for HA
                clustering:
                  enabled: false

                # Resources
                {{- if .alloy.resources }}
                resources:
                  requests:
                    cpu: '{{ .alloy.resources.requests.cpu }}'
                    memory: '{{ .alloy.resources.requests.memory }}'
                  limits:
                    cpu: '{{ .alloy.resources.limits.cpu }}'
                    memory: '{{ .alloy.resources.limits.memory }}'
                {{- end }}

                {{- if or .alloy.logs.journal.enabled .alloy.logs.rke2.enabled (and .rke2.cis.enabled .alloy.logs.audit.enabled) }}
                # Volume mounts for node logs
                mounts:
                  extra:
                    {{- if .alloy.logs.journal.enabled }}
                    - name: journal
                      mountPath: /var/log/journal
                      readOnly: true
                    {{- end }}
                    {{- if .alloy.logs.rke2.enabled }}
                    - name: rke2-logs
                      mountPath: /var/lib/rancher/rke2/agent/logs
                      readOnly: true
                    - name: rke2-containerd
                      mountPath: /var/lib/rancher/rke2/agent/containerd
                      readOnly: true
                    {{- end }}
                    {{- if and .rke2.cis.enabled .alloy.logs.audit.enabled }}
                    # Kubernetes API audit logs (only present on control-plane nodes)
                    - name: rke2-audit
                      mountPath: /var/lib/rancher/rke2/server/logs
                      readOnly: true
                    {{- end }}
                {{- end }}

                # Alloy River configuration
                configMap:
                  content: |
                    // =============================================================================
                    // Grafana Alloy Configuration - Log Collection for Kubernetes
                    // =============================================================================

                    // Logging configuration
                    logging {
                      level  = "info"
                      format = "logfmt"
                    }

                    {{- if .alloy.logs.pods.enabled }}
                    // =============================================================================
                    // Kubernetes Pod Discovery
                    // =============================================================================
                    discovery.kubernetes "pods" {
                      role = "pod"
                    }

                    // Relabel discovered pods to extract useful labels
                    discovery.relabel "pods" {
                      targets = discovery.kubernetes.pods.targets

                      // Keep only running pods
                      rule {
                        source_labels = ["__meta_kubernetes_pod_phase"]
                        regex         = "Pending|Succeeded|Failed|Unknown"
                        action        = "drop"
                      }

                      // Extract namespace
                      rule {
                        source_labels = ["__meta_kubernetes_namespace"]
                        target_label  = "namespace"
                      }

                      // Extract pod name
                      rule {
                        source_labels = ["__meta_kubernetes_pod_name"]
                        target_label  = "pod"
                      }

                      // Extract container name
                      rule {
                        source_labels = ["__meta_kubernetes_pod_container_name"]
                        target_label  = "container"
                      }

                      // Extract node name
                      rule {
                        source_labels = ["__meta_kubernetes_pod_node_name"]
                        target_label  = "node"
                      }

                      // Extract app label if present
                      rule {
                        source_labels = ["__meta_kubernetes_pod_label_app"]
                        target_label  = "app"
                      }

                      // Extract app.kubernetes.io/name label if present
                      rule {
                        source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
                        target_label  = "app_name"
                      }

                      // Set job label from namespace/container
                      rule {
                        source_labels = ["namespace", "container"]
                        separator     = "/"
                        target_label  = "job"
                      }
                    }

                    // =============================================================================
                    // Log Collection from Kubernetes Pods
                    // =============================================================================
                    loki.source.kubernetes "pods" {
                      targets    = discovery.relabel.pods.output
                      forward_to = [loki.process.pods.receiver]
                    }

                    // Process logs (add labels, parse structured logs)
                    loki.process "pods" {
                      forward_to = [loki.write.default.receiver]

                      // Drop empty logs
                      stage.drop {
                        expression = "^\\s*$"
                      }

                      // Try to parse JSON logs (keep non-JSON logs)
                      stage.json {
                        expressions = {
                          level = "level",
                          msg   = "msg",
                        }
                        drop_malformed = false
                      }

                      // Extract traceID from W3C Traceparent header (format: 00-<traceid>-<spanid>-<flags>)
                      stage.regex {
                        expression = "Traceparent:\\[00-(?P<traceID>[a-f0-9]+)-"
                      }

                      // Extract traceID from B3 header if not found
                      stage.regex {
                        expression = "X-B3-Traceid:\\[(?P<traceID>[a-f0-9]+)\\]"
                      }

                      // Add traceID as label for Tempo correlation
                      stage.labels {
                        values = {
                          traceID = "",
                        }
                      }

                      // Normalize log level
                      stage.label_drop {
                        values = ["level"]
                      }
                    }
                    {{- end }}

                    {{- if .alloy.logs.events.enabled }}
                    // =============================================================================
                    // Kubernetes Events Collection
                    // =============================================================================
                    // Collects cluster events: pod scheduling, errors, warnings, etc.
                    loki.source.kubernetes_events "cluster" {
                      job_name   = "kubernetes-events"
                      forward_to = [loki.process.events.receiver]
                    }

                    // Process Kubernetes events
                    loki.process "events" {
                      forward_to = [loki.write.default.receiver]

                      // Add source label to identify events
                      stage.static_labels {
                        values = {
                          source = "kubernetes-events",
                        }
                      }
                    }
                    {{- end }}

                    {{- if .alloy.logs.journal.enabled }}
                    // =============================================================================
                    // Node Journal Logs (systemd/journald)
                    // =============================================================================
                    // Collects logs from kubelet, containerd, and other system services
                    loki.source.journal "node" {
                      path         = "/var/log/journal"
                      relabel_rules = discovery.relabel.journal.rules
                      forward_to   = [loki.process.journal.receiver]
                    }

                    // Relabel journal entries to extract useful labels
                    discovery.relabel "journal" {
                      targets = []

                      // Extract systemd unit name
                      rule {
                        source_labels = ["__journal__systemd_unit"]
                        target_label  = "unit"
                      }

                      // Extract hostname
                      rule {
                        source_labels = ["__journal__hostname"]
                        target_label  = "node"
                      }

                      // Extract priority (log level)
                      rule {
                        source_labels = ["__journal_priority_keyword"]
                        target_label  = "level"
                      }

                      // Set job label
                      rule {
                        replacement  = "journal"
                        target_label = "job"
                      }
                    }

                    // Process journal logs
                    loki.process "journal" {
                      forward_to = [loki.write.default.receiver]

                      // Add source label to identify journal logs
                      stage.static_labels {
                        values = {
                          source = "journal",
                        }
                      }
                    }
                    {{- end }}

                    {{- if .alloy.logs.rke2.enabled }}
                    // =============================================================================
                    // RKE2 Node Logs (file-based: kubelet.log, containerd.log)
                    // =============================================================================
                    local.file_match "rke2_logs" {
                      path_targets = [
                        {
                          __path__ = "/var/lib/rancher/rke2/agent/logs/*.log",
                          type     = "kubelet",
                        },
                        {
                          __path__ = "/var/lib/rancher/rke2/agent/containerd/containerd.log",
                          type     = "containerd",
                        },
                      ]
                    }

                    loki.source.file "rke2" {
                      targets    = local.file_match.rke2_logs.targets
                      forward_to = [loki.process.rke2.receiver]
                    }

                    loki.process "rke2" {
                      forward_to = [loki.write.default.receiver]

                      // Add source and type labels
                      stage.static_labels {
                        values = {
                          source = "rke2",
                        }
                      }
                    }
                    {{- end }}

                    {{- if and .rke2.cis.enabled .alloy.logs.audit.enabled }}
                    // =============================================================================
                    // Kubernetes API Audit Logs (CIS compliance)
                    // =============================================================================
                    // Collects kube-apiserver audit logs from control-plane nodes
                    // Path: /var/lib/rancher/rke2/server/logs/audit.log
                    // Format: JSON (one event per line)
                    local.file_match "audit_logs" {
                      path_targets = [
                        {
                          __path__ = "/var/lib/rancher/rke2/server/logs/audit.log",
                        },
                      ]
                    }

                    loki.source.file "audit" {
                      targets    = local.file_match.audit_logs.targets
                      forward_to = [loki.process.audit.receiver]
                    }

                    loki.process "audit" {
                      forward_to = [loki.write.default.receiver]

                      // Add source label
                      stage.static_labels {
                        values = {
                          source = "kubernetes-audit",
                          job    = "audit",
                        }
                      }

                      // Parse JSON audit log entries
                      stage.json {
                        expressions = {
                          level       = "level",
                          verb        = "verb",
                          user        = "user.username",
                          resource    = "objectRef.resource",
                          subresource = "objectRef.subresource",
                          namespace   = "objectRef.namespace",
                          name        = "objectRef.name",
                          stage       = "stage",
                          statusCode  = "responseStatus.code",
                        }
                      }

                      // Add extracted fields as labels for querying
                      stage.labels {
                        values = {
                          audit_level       = "level",
                          audit_verb        = "verb",
                          audit_user        = "user",
                          audit_resource    = "resource",
                          audit_subresource = "subresource",
                          audit_namespace   = "namespace",
                          audit_stage       = "stage",
                        }
                      }
                    }
                    {{- end }}

                    // =============================================================================
                    // Send Logs to Loki
                    // =============================================================================
                    loki.write "default" {
                      endpoint {
                        url = "{{ .alloy.loki.url }}"
                      }
                    }

                    {{- if .features.monitoring.enabled }}
                    // =============================================================================
                    // Expose Metrics for Prometheus
                    // =============================================================================
                    prometheus.exporter.self "alloy" {}

                    prometheus.scrape "alloy" {
                      targets    = prometheus.exporter.self.alloy.targets
                      forward_to = [prometheus.remote_write.default.receiver]
                    }

                    prometheus.remote_write "default" {
                      endpoint {
                        url = "http://prometheus-stack-kube-prom-prometheus.monitoring.svc:9090/api/v1/write"
                      }
                    }
                    {{- end }}

              # ServiceMonitor for Prometheus
              {{- if .features.monitoring.enabled }}
              serviceMonitor:
                enabled: true
                additionalLabels:
                  release: '{{ .features.monitoring.release }}'
              {{- end }}

        {{- if .features.monitoring.enabled }}
        # Source 2: PrometheusRules for Alloy monitoring
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/alloy/kustomize/monitoring
          kustomize:
            commonLabels:
              release: '{{ .features.monitoring.release }}'
        {{- end }}
