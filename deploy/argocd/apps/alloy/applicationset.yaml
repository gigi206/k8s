---
# =============================================================================
# Alloy ApplicationSet - Wave 74 (Log Collector)
# =============================================================================
# Deploys Grafana Alloy as a DaemonSet for log collection.
# Sends logs to Loki (Wave 73).
# Docs: https://grafana.com/docs/alloy/latest/
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: alloy
  namespace: argo-cd
  annotations:
    argocd.argoproj.io/sync-wave: "74"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - merge:
        mergeKeys:
          - environment
        generators:
          # Global config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/config/config.yaml

          # App-specific config
          - git:
              repoURL: https://github.com/gigi206/k8s
              revision: 'HEAD'
              files:
                - path: deploy/argocd/apps/alloy/config/*.yaml

  template:
    metadata:
      name: alloy
      namespace: argo-cd
      annotations:
        argocd.argoproj.io/sync-wave: "74"
    spec:
      project: default

      source:
        repoURL: https://grafana.github.io/helm-charts
        targetRevision: '{{ .alloy.version }}'
        chart: alloy

      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ .alloy.namespace }}'

      syncPolicy:
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 5m

  templatePatch: |
    spec:
      syncPolicy:
        syncOptions:
        {{- range .syncPolicy.syncOptions }}
          - {{ . }}
        {{- end }}
      {{- if .syncPolicy.automated.enabled }}
        automated:
          prune: {{ .syncPolicy.automated.prune }}
          selfHeal: {{ .syncPolicy.automated.selfHeal }}
      {{- end }}
      sources:
        # Source 0: Namespace
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/alloy/resources
          directory:
            include: "namespace.yaml"

        # Source 1: Alloy Helm Chart
        - repoURL: https://grafana.github.io/helm-charts
          targetRevision: '{{ .alloy.version }}'
          chart: alloy
          helm:
            releaseName: alloy
            valuesObject:
              # Controller type (daemonset for log collection)
              controller:
                type: '{{ .alloy.controller.type }}'

              # Alloy configuration
              alloy:
                # Enable clustering for HA
                clustering:
                  enabled: false

                # Resources
                {{- if .alloy.resources }}
                resources:
                  requests:
                    cpu: '{{ .alloy.resources.requests.cpu }}'
                    memory: '{{ .alloy.resources.requests.memory }}'
                  limits:
                    cpu: '{{ .alloy.resources.limits.cpu }}'
                    memory: '{{ .alloy.resources.limits.memory }}'
                {{- end }}

                # Alloy River configuration
                configMap:
                  content: |
                    // =============================================================================
                    // Grafana Alloy Configuration - Log Collection for Kubernetes
                    // =============================================================================

                    // Logging configuration
                    logging {
                      level  = "info"
                      format = "logfmt"
                    }

                    // =============================================================================
                    // Kubernetes Pod Discovery
                    // =============================================================================
                    discovery.kubernetes "pods" {
                      role = "pod"
                    }

                    // Relabel discovered pods to extract useful labels
                    discovery.relabel "pods" {
                      targets = discovery.kubernetes.pods.targets

                      // Keep only running pods
                      rule {
                        source_labels = ["__meta_kubernetes_pod_phase"]
                        regex         = "Pending|Succeeded|Failed|Unknown"
                        action        = "drop"
                      }

                      // Extract namespace
                      rule {
                        source_labels = ["__meta_kubernetes_namespace"]
                        target_label  = "namespace"
                      }

                      // Extract pod name
                      rule {
                        source_labels = ["__meta_kubernetes_pod_name"]
                        target_label  = "pod"
                      }

                      // Extract container name
                      rule {
                        source_labels = ["__meta_kubernetes_pod_container_name"]
                        target_label  = "container"
                      }

                      // Extract node name
                      rule {
                        source_labels = ["__meta_kubernetes_pod_node_name"]
                        target_label  = "node"
                      }

                      // Extract app label if present
                      rule {
                        source_labels = ["__meta_kubernetes_pod_label_app"]
                        target_label  = "app"
                      }

                      // Extract app.kubernetes.io/name label if present
                      rule {
                        source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
                        target_label  = "app_name"
                      }

                      // Set job label from namespace/container
                      rule {
                        source_labels = ["namespace", "container"]
                        separator     = "/"
                        target_label  = "job"
                      }
                    }

                    // =============================================================================
                    // Log Collection from Kubernetes Pods
                    // =============================================================================
                    loki.source.kubernetes "pods" {
                      targets    = discovery.relabel.pods.output
                      forward_to = [loki.process.pods.receiver]
                    }

                    // Process logs (add labels, parse structured logs)
                    loki.process "pods" {
                      forward_to = [loki.write.default.receiver]

                      // Drop empty logs
                      stage.drop {
                        expression = "^\\s*$"
                      }

                      // Try to parse JSON logs (keep non-JSON logs)
                      stage.json {
                        expressions = {
                          level = "level",
                          msg   = "msg",
                        }
                        drop_malformed = false
                      }

                      // Extract traceID from W3C Traceparent header (format: 00-<traceid>-<spanid>-<flags>)
                      stage.regex {
                        expression = "Traceparent:\\[00-(?P<traceID>[a-f0-9]+)-"
                      }

                      // Extract traceID from B3 header if not found
                      stage.regex {
                        expression = "X-B3-Traceid:\\[(?P<traceID>[a-f0-9]+)\\]"
                      }

                      // Add traceID as label for Tempo correlation
                      stage.labels {
                        values = {
                          traceID = "",
                        }
                      }

                      // Normalize log level
                      stage.label_drop {
                        values = ["level"]
                      }
                    }

                    // =============================================================================
                    // Send Logs to Loki
                    // =============================================================================
                    loki.write "default" {
                      endpoint {
                        url = "{{ .alloy.loki.url }}"
                      }
                    }

                    {{- if .features.monitoring.enabled }}
                    // =============================================================================
                    // Expose Metrics for Prometheus
                    // =============================================================================
                    prometheus.exporter.self "alloy" {}

                    prometheus.scrape "alloy" {
                      targets    = prometheus.exporter.self.alloy.targets
                      forward_to = [prometheus.remote_write.default.receiver]
                    }

                    prometheus.remote_write "default" {
                      endpoint {
                        url = "http://prometheus-stack-kube-prom-prometheus.monitoring.svc:9090/api/v1/write"
                      }
                    }
                    {{- end }}

              # ServiceMonitor for Prometheus
              {{- if .features.monitoring.enabled }}
              serviceMonitor:
                enabled: true
                additionalLabels:
                  release: '{{ .features.monitoring.release }}'
              {{- end }}

        {{- if .features.monitoring.enabled }}
        # Source 2: PrometheusRules for Alloy monitoring
        - repoURL: https://github.com/gigi206/k8s
          targetRevision: '{{ .git.revision }}'
          path: deploy/argocd/apps/alloy/kustomize
          kustomize:
            commonLabels:
              release: '{{ .features.monitoring.release }}'
        {{- end }}
