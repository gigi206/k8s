---
# =============================================================================
# CiliumNetworkPolicy - Envoy Gateway Controller Ingress
# =============================================================================
# Allows traffic to the Envoy Gateway controller:
# - xDS from proxy pods (18000/18001)
# - Prometheus metrics (19001)
# =============================================================================
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: envoy-gateway-controller-ingress
  namespace: envoy-gateway-system
spec:
  description: "Allow ingress to Envoy Gateway controller"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: gateway-helm

  ingress:
    # Allow xDS from proxy pods within namespace
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: envoy-gateway-system
      toPorts:
        - ports:
            - port: "18000"  # xDS server
              protocol: TCP
            - port: "18001"  # xDS server (TLS)
              protocol: TCP
            - port: "18002"  # xDS server
              protocol: TCP
            - port: "9443"   # Webhook
              protocol: TCP

    # Allow from monitoring namespace (Prometheus scrape)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: monitoring
      toPorts:
        - ports:
            - port: "19001"  # Envoy admin/metrics
              protocol: TCP

---
# =============================================================================
# CiliumNetworkPolicy - Envoy Proxy Ingress
# =============================================================================
# Allows traffic to Envoy proxy pods:
# - External clients via LoadBalancer (80/443)
# - Internal cluster traffic (hairpin NAT)
# - Prometheus metrics (19001)
# =============================================================================
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: envoy-gateway-proxy-ingress
  namespace: envoy-gateway-system
spec:
  description: "Allow ingress to Envoy proxy pods"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: envoy

  ingress:
    # Allow external traffic from world (LoadBalancer clients via MetalLB)
    - fromEntities:
        - world
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
            - port: "443"
              protocol: TCP
            - port: "10080"  # Alternative HTTP
              protocol: TCP
            - port: "10443"  # Alternative HTTPS
              protocol: TCP

    # Allow internal cluster traffic (pods accessing services via LoadBalancer IP)
    - fromEntities:
        - cluster
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
            - port: "443"
              protocol: TCP
            - port: "10080"
              protocol: TCP
            - port: "10443"
              protocol: TCP

    # Allow from monitoring namespace (Prometheus scrape)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: monitoring
      toPorts:
        - ports:
            - port: "19001"  # Envoy admin/metrics
              protocol: TCP
