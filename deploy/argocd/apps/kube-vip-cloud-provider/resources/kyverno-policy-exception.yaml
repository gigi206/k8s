---
# =============================================================================
# Kyverno PolicyException for kube-vip-cloud-provider
# =============================================================================
# Allows kube-vip-cloud-provider to mount ServiceAccount token
# Required for Kubernetes API access to watch/update Services
# =============================================================================
apiVersion: kyverno.io/v2
kind: PolicyException
metadata:
  name: kube-vip-cloud-provider
  namespace: kube-system
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "-10"
spec:
  exceptions:
    - policyName: disallow-auto-mount-service-account-token
      ruleNames:
        - validate-automountServiceAccountToken
        - validate-pod-automountServiceAccountToken
  match:
    any:
      - resources:
          kinds:
            - Deployment
            - Pod
          namespaces:
            - kube-system
          names:
            - kube-vip-cloud-provider*
