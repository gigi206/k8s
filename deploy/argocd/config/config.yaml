---
# =============================================================================
# Configuration de Base - Infrastructure Dev
# =============================================================================
# Ce fichier contient les paramètres communs partagés entre tous les environnements
# et le sélecteur d'environnement actif.
#
# Chaque application a ses propres fichiers de configuration :
#   metallb/config-dev.yaml, metallb/config-prod.yaml
#   cert-manager/config-dev.yaml, cert-manager/config-prod.yaml
#   etc.
#
# Pour basculer d'environnement, changer la valeur ci-dessous :
#   environment: dev  → pour développement
#   environment: prod → pour production
#
# Le Merge Generator fusionnera automatiquement ce fichier avec
# le fichier config-{environment}.yaml de chaque application.
# =============================================================================

# Environnement actif (dev ou prod)
environment: dev

# Politique de synchronisation (base, peut être override par environnement)
syncPolicy:
  automated:
    enabled: false
  retry:
    limit: 5
    backoff:
      duration: 5s
      factor: 2
      maxDuration: 5m
  syncOptions:
    - CreateNamespace=true
    - ServerSideApply=true
    - PruneLast=true
    - SkipDryRunOnMissingResource=true
    - RespectIgnoreDifferences=true

# Paramètres communs partagés
common:
  domain: "k8s.lan"
  certEmail: "admin@example.com"
  clusterIssuer: "selfsigned-cluster-issuer"

# Configuration Git
git:
  revision: "HEAD"

# Feature flags - Activation des composants
# =============================================================================
# Ces flags contrôlent le déploiement dynamique des ApplicationSets.
# Le script deploy-applicationsets.sh lit ces valeurs et construit
# automatiquement la liste des applications à déployer.
#
# Dépendances automatiques (résolues par le script):
#   - sso.provider=keycloak → active databaseOperator, externalSecrets, certManager
#   - gatewayAPI.controller.provider=istio → active serviceMesh (istio), gatewayAPI
#   - cilium.monitoring.enabled → active monitoring
#   - storage.provider=longhorn → active csiSnapshotter (recommandé)
# =============================================================================

features:
  # === Infrastructure Core ===
  metallb:
    enabled: true  # Wave 10: LoadBalancer Layer 2

  kubeVip:
    enabled: true  # Wave 15: VIP pour API Kubernetes HA

  # === Certificates ===
  certManager:
    enabled: true  # Wave 20: Gestion des certificats TLS
    issuerType: "letsencrypt-staging"
    # issuerType: "letsencrypt-prod"

  # === Secrets Management ===
  externalSecrets:
    enabled: true  # Wave 25: External Secrets Operator

  # === DNS ===
  externalDns:
    enabled: true  # Wave 30: Automation DNS
    # provider: "coredns"  # ou: aws, google, azure, cloudflare, etc.

  # === Service Mesh ===
  serviceMesh:
    enabled: true      # Wave 40: Service Mesh (control plane + data plane)
    provider: "istio"  # istio, linkerd (futur)

  # === Gateway API ===
  gatewayAPI:
    enabled: true  # Wave 15: Gateway API CRDs (gateway-api-controller)
    httpRoute:
      enabled: true  # Utilise HTTPRoute dans les ApplicationSets
    controller:
      provider: "istio"  # Wave 41: istio, nginx-gateway-fabric, envoy-gateway, apisix, traefik, nginx

  # === Legacy Ingress (déprécié) ===
  ingress:
    enabled: false  # Support Ingress legacy (patch des ressources)
    class: "istio"  # Classe dérivée de gatewayAPI.controller.provider si non spécifiée

  # === Storage ===
  storage:
    enabled: true        # Wave 60: Stockage distribué
    provider: "longhorn" # Provider selection: longhorn (seul provider actuellement supporté)
    class: "longhorn"    # Kubernetes StorageClass name (used by workloads for PVCs)
    csiSnapshotter: true # Wave 55: CSI External Snapshotter (requis pour snapshots)

  # === Database Operator ===
  databaseOperator:
    enabled: true    # Wave 65: Opérateur PostgreSQL
    provider: "cnpg" # cnpg (CloudNativePG)

  # === Monitoring ===
  monitoring:
    enabled: true  # Wave 75: Prometheus + Grafana
    prometheus: true
    grafana: true
    release: "prometheus-stack"  # Release name for ServiceMonitor discovery
    dashboard:
      label: "1"  # Label value for grafana_dashboard (enables auto-import)
      baseFolder: "/tmp/dashboards"  # Base folder for dashboard organization
      folderAnnotation: "grafana_dashboard_folder"  # Annotation name for dashboard folder path

  # === Cilium Monitoring ===
  cilium:
    monitoring:
      enabled: true  # Wave 76: ServiceMonitors pour Cilium/Hubble (requiert monitoring.enabled)

  # === Distributed Tracing ===
  tracing:
    enabled: true      # Wave 77: Jaeger distributed tracing
    provider: "jaeger" # jaeger (seul provider actuellement supporté)
    waypoints:
      enabled: true    # Deploy Istio Waypoint proxies for L7 tracing
      namespaces:      # Namespaces to enable L7 tracing via Waypoints
        - monitoring
        - keycloak
        - oauth2-proxy

  # === SSO / Authentication ===
  # sso.provider=keycloak déploie Keycloak local
  # sso.provider=external utilise un IdP externe (Okta, Auth0, Azure AD, etc.)
  # When disabled:
  #   - Keycloak is NOT deployed
  #   - ArgoCD uses local admin authentication
  #   - Grafana uses local admin (admin/password from secrets)
  #   - Kiali uses anonymous authentication
  #   - Prometheus/Alertmanager/Hubble/Longhorn are accessible without auth
  sso:
    enabled: true
    provider: "keycloak"  # Wave 80: keycloak ou external (IdP externe)

  # === OAuth2 Proxy ===
  # Indépendant du SSO - peut être utilisé avec Keycloak local OU IdP externe
  # Utilisé en mode ext_authz avec Istio (auth seulement, pas de proxy du trafic)
  oauth2Proxy:
    enabled: true  # Wave 81: OAuth2 Proxy pour authentification OIDC
