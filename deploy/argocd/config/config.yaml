---
# =============================================================================
# Configuration de Base - Infrastructure Dev
# =============================================================================
# Ce fichier contient les paramètres communs partagés entre tous les environnements
# et le sélecteur d'environnement actif.
#
# Chaque application a ses propres fichiers de configuration :
#   metallb/config-dev.yaml, metallb/config-prod.yaml
#   cert-manager/config-dev.yaml, cert-manager/config-prod.yaml
#   etc.
#
# Pour basculer d'environnement, changer la valeur ci-dessous :
#   environment: dev  → pour développement
#   environment: prod → pour production
#
# Le Merge Generator fusionnera automatiquement ce fichier avec
# le fichier config-{environment}.yaml de chaque application.
# =============================================================================

# Environnement actif (dev ou prod)
environment: dev

# Politique de synchronisation (base, peut être override par environnement)
syncPolicy:
  automated:
    enabled: false
  retry:
    limit: 5
    backoff:
      duration: 5s
      factor: 2
      maxDuration: 5m
  syncOptions:
    - CreateNamespace=true
    - ServerSideApply=true
    - PruneLast=true
    - SkipDryRunOnMissingResource=true
    - RespectIgnoreDifferences=true

# Paramètres communs partagés
common:
  domain: "k8s.lan"
  certEmail: "admin@example.com"
  clusterIssuer: "selfsigned-cluster-issuer"

# Images communes utilisées par les Jobs
images:
  curl:
    repository: curlimages/curl
    tag: "8.18.0"

# Configuration Git
git:
  revision: "HEAD"

# Feature flags - Activation des composants
# =============================================================================
# Ces flags contrôlent le déploiement dynamique des ApplicationSets.
# Le script deploy-applicationsets.sh lit ces valeurs et construit
# automatiquement la liste des applications à déployer.
#
# Dépendances automatiques (résolues par le script):
#   - sso.provider=keycloak → active databaseOperator, externalSecrets, certManager
#   - gatewayAPI.controller.provider=istio → active serviceMesh (istio), gatewayAPI
#   - cilium.monitoring.enabled → active monitoring
#   - storage.provider=longhorn → active csiSnapshotter (recommandé)
# =============================================================================

features:
  # === Infrastructure Core ===
  metallb:
    enabled: true  # Wave 10: LoadBalancer Layer 2

  kubeVip:
    enabled: true  # Wave 15: VIP pour API Kubernetes HA

  # === Certificates ===
  certManager:
    enabled: true  # Wave 20: Gestion des certificats TLS
    issuerType: "letsencrypt-staging"
    # issuerType: "letsencrypt-prod"

  # === Secrets Management ===
  externalSecrets:
    enabled: true  # Wave 25: External Secrets Operator

  # === Configuration Reload ===
  reloader:
    enabled: true  # Wave 25: Auto-reload pods on ConfigMap/Secret changes

  # === DNS ===
  externalDns:
    enabled: true  # Wave 30: Automation DNS
    loadBalancerIP: "192.168.121.201"  # MetalLB IP for external-dns CoreDNS
    # provider: "coredns"  # ou: aws, google, azure, cloudflare, etc.

  # === Service Mesh ===
  serviceMesh:
    enabled: false      # Wave 40: Service Mesh (control plane + data plane)
    provider: "istio"  # istio, linkerd (futur)
    istio:
      accessLogs:
        # Provider "access-log-json" disponible pour activation par namespace via Telemetry API
        # Format JSON avec trace_id pour corrélation log-trace
        # Pour activer sur un namespace: créer Telemetry avec providers: [{name: access-log-json}]
        providerName: "access-log-json"  # Nom du provider à utiliser dans Telemetry
      waypoints:
        enabled: false   # Istio Waypoint proxies pour L7 (requiert istio.io/dataplane-mode=ambient sur les namespaces)

  # === Gateway API ===
  gatewayAPI:
    enabled: true  # Wave 15: Gateway API CRDs (gateway-api-controller)
    httpRoute:
      enabled: false  # true = utilise HTTPRoute standard (Gateway API)
    controller:
      provider: "apisix"  # Wave 41: istio, apisix, nginx-gwf, envoy-gateway, traefik
      # Gateway namespace (depends on provider):
      # - istio: istio-system
      # - apisix: apisix
      # - envoy-gateway: envoy-gateway-system
      # - traefik: traefik
      # - nginx-gwf: nginx-gateway
      gatewayNamespace: "apisix"
      # Gateway LoadBalancer IP (used for MetalLB pool and external-dns)
      loadBalancerIP: "192.168.121.210"

  # === Legacy Ingress (déprécié) ===
  ingress:
    enabled: false  # Support Ingress legacy (patch des ressources)
    class: "istio"  # Classe dérivée de gatewayAPI.controller.provider si non spécifiée

  # === Storage ===
  storage:
    enabled: true        # Wave 60: Stockage distribué
    provider: "rook"       # Provider selection: longhorn | rook
    class: "ceph-block"    # Kubernetes StorageClass name: longhorn | ceph-block (rook)
    csiSnapshotter: true # Wave 55: CSI External Snapshotter (requis pour snapshots)

  # === Database Operator ===
  databaseOperator:
    enabled: true    # Wave 65: Opérateur PostgreSQL
    provider: "cnpg" # cnpg (CloudNativePG)

  # === Monitoring ===
  monitoring:
    enabled: true  # Wave 75: Prometheus + Grafana
    prometheus: true
    grafana: true
    release: "prometheus-stack"  # Release name for ServiceMonitor discovery
    dashboard:
      label: "1"  # Label value for grafana_dashboard (enables auto-import)
      baseFolder: "/tmp/dashboards"  # Base folder for dashboard organization
      folderAnnotation: "grafana_dashboard_folder"  # Annotation name for dashboard folder path

  # === Cilium (CNI installé par RKE2) ===
  cilium:
    monitoring:
      enabled: true     # Wave 76: ServiceMonitors pour Cilium/Hubble (requiert monitoring.enabled)
    egressPolicy:
      enabled: true     # CiliumClusterwideNetworkPolicy default-deny egress + per-app policies
    ingressPolicy:
      enabled: true     # CiliumClusterwideNetworkPolicy default-deny host ingress (SSH, API, HTTP/HTTPS)
    defaultDenyPodIngress:
      enabled: true     # CiliumClusterwideNetworkPolicy default-deny pod-to-pod ingress (Zero Trust)
                        # Requires per-app CiliumNetworkPolicy to allow traffic
                        # Excludes: kube-system (DNS, API, CNI)

  # === Observability: Logging ===
  logging:
    enabled: true        # Active le logging centralisé
    loki:
      enabled: true      # Wave 73: Grafana Loki (backend stockage logs)
      collector: "alloy" # Wave 74: alloy (recommandé), fluent-bit (futur)

  # === Distributed Tracing ===
  tracing:
    enabled: true      # Wave 77: Distributed tracing
    provider: "tempo"  # tempo (recommandé, corrélation Loki) ou jaeger
    sampling: 100      # Pourcentage de traces échantillonnées (1-100)

  # === SSO / Authentication ===
  # sso.provider=keycloak déploie Keycloak local
  # sso.provider=external utilise un IdP externe (Okta, Auth0, Azure AD, etc.)
  # When disabled:
  #   - Keycloak is NOT deployed
  #   - ArgoCD uses local admin authentication
  #   - Grafana uses local admin (admin/password from secrets)
  #   - Kiali uses anonymous authentication
  #   - Prometheus/Alertmanager/Hubble/Longhorn are accessible without auth
  sso:
    enabled: true
    provider: "keycloak"  # Wave 80: keycloak ou external (IdP externe)

  # === OAuth2 Proxy ===
  # Indépendant du SSO - peut être utilisé avec Keycloak local OU IdP externe
  # Utilisé en mode ext_authz avec Istio (auth seulement, pas de proxy du trafic)
  oauth2Proxy:
    enabled: true  # Wave 81: OAuth2 Proxy pour authentification OIDC

  # === Container Security ===
  neuvector:
    enabled: false  # Wave 82: NeuVector container security platform (Controller, Enforcer, Manager, Scanner)
