# https://github.com/isItObservable/Otel-Collector-Observek8s
# https://www.youtube.com/watch?v=NTsK_0t9eRU&list=PL6VBQyIvTlRjAMeeZN5yfD07X8DdYonnI&index=11

# https://github.com/antonmedv/expr/blob/master/docs/Language-Definition.md

apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: otelcontribcol
  name: otelcontribcol
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otelcontribcol
  labels:
    app: otelcontribcol
rules:
  - apiGroups:
      - ""
    resources:
      - events
      - namespaces
      - namespaces/status
      - nodes
      - nodes/spec
      - nodes/stats
      - nodes/proxy
      - pods
      - pods/status
      - replicationcontrollers
      - replicationcontrollers/status
      - resourcequotas
      - services
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - apps
    resources:
      - daemonsets
      - deployments
      - replicasets
      - statefulsets
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
    resources:
      - daemonsets
      - deployments
      - replicasets
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - batch
    resources:
      - jobs
      - cronjobs
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - autoscaling
    resources:
      - horizontalpodautoscalers
    verbs:
      - get
      - list
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otelcontribcol
  labels:
    app: otelcontribcol
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: otelcontribcol
subjects:
  - kind: ServiceAccount
    name: otelcontribcol
    namespace: default
---
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: simplest
spec:
  # image: otel/opentelemetry-collector-contrib-dev:latest
  # https://hub.docker.com/r/otel/opentelemetry-collector-contrib/tags
  image: otel/opentelemetry-collector-contrib:0.71.0
  serviceAccount: otelcontribcol
  mode: daemonset
  hostNetwork: true
  # resources:
  #   limits:
  #   requests:
  volumes:
    - name: varlog
      hostPath:
        path: /var/log
  volumeMounts:
    - mountPath: /var/log
      name: varlog
      readOnly: true
  ports:
    - name: metric
      port: 9090
      targetPort: 9090
      protocol: TCP
  env:
    - name: K8S_NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    - name: K8S_CLUSTER_NAME
      value: K8S_GIGIX_DEMO
  config: |
    # https://github.com/open-telemetry/opentelemetry-collector/tree/main/receiver
    # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver
    receivers:
      otlp: https://github.com/open-telemetry/opentelemetry-collector/tree/main/receiver/otlpreceiver
        protocols:
          grpc:
          http:
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/filelogreceiver
      filelog:
        include:
          - /var/log/pods/*/*/*.log
        exclude:
          - /var/log/pods/*/otc-container/*.log
        # start_at: beginning
        start_at: end
        include_file_path: true
        include_file_name: false
        # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/pkg/stanza/docs/operators/README.md
        operators:
          # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/pkg/stanza/docs/operators/router.md
          # Find out which format is used by kubernetes
          - type: router
            id: get-format
            routes:
              - output: parser-containerd
                expr: 'body matches "^[^ Z]+Z"'
          # Parse CRI-Containerd format
          - type: regex_parser
            id: parser-containerd
            regex: '^(?P<time>[^ ^Z]+Z) (?P<stream>stdout|stderr) (?P<logtag>[^ ]*) (?P<log>.*)$'
            output: extract_metadata_from_filepath
            timestamp:
              parse_from: attributes.time
              layout: '%Y-%m-%dT%H:%M:%S.%LZ'
            # severity:
            #   parse_from: sev
            # severity:
            #   parse_from: level
            #   mapping:
            #     error: E
            #     info: I
            # trace:
            #   trace_id:
            #     parse_from: attributes.trace_id
          # Extract metadata from file path
          - type: regex_parser
            id: extract_metadata_from_filepath
            regex: '^.*\/(?P<namespace>[^_]+)_(?P<pod_name>[^_]+)_(?P<uid>[a-f0-9\-]{36})\/(?P<container_name>[^\._]+)\/(?P<run_id>\d+)\.log$'
            parse_from: attributes["log.file.path"]
          # Rename attributes
          - type: move
            from: attributes.stream
            to: attributes["log.iostream"]
          - type: move
            from: attributes.container_name
            to: attributes["k8s.container.name"]
          - type: move
            from: attributes.namespace
            to: attributes["k8s.namespace.name"]
          - type: move
            from: attributes.pod_name
            to: attributes["k8s.pod.name"]
          - type: move
            from: attributes.restart_count
            to: attributes["k8s.container.restart_count"]
          - type: move
            from: attributes.uid
            to: attributes["k8s.pod.uid"]
          - type: add
            field: attributes["k8s.cluster.name"]
            value: '${K8S_CLUSTER_NAME}'
          - type: add
            field: attributes["k8s.node.name"]
            value: '${K8S_NODE_NAME}'
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/hostmetricsreceiver
      hostmetrics:
          collection_interval: 30s
          scrapers:
            cpu:
            disk:
            load:
              cpu_average: true
            filesystem:
            memory:
            network:
            paging:
            processes:
            process:
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/k8sclusterreceiver
      k8s_cluster:
        collection_interval: 10s
        node_conditions_to_report: [Ready,MemoryPressure,DiskPressure,NetworkUnavailable,PIDPressure]
        allocatable_types_to_report:
          - cpu
          - memory
          - storage
          # - ephemeral-storage
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/k8seventsreceiver
      k8s_events:
        auth_type : serviceAccount
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/k8sobjectsreceiver
      # k8sobjects:
      #   auth_type: serviceAccount
      #   objects:
      #     - name: pods
      #       mode: pull
      #       label_selector: environment in (production),tier in (frontend)
      #       field_selector: status.phase=Running
      #       interval: 15m
      #     - name: events
      #       mode: watch
      #       # group: events.k8s.io
      #       # namespaces: [default]
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/receivercreator
      # receiver_creator:
      #   watch_observers: [k8s_observer]
      #   # watch_observers: [k8s_observer,host_observer]
      #   receivers:
      #     kubeletstats:
      #       rule: type == "k8s.node"
      #       config:
      #         collection_interval: 10s
      #         auth_type: serviceAccount
      #         # endpoint: "`endpoint`:`kubelet_endpoint_port`"
      #         insecure_skip_verify: true
      #         extra_metadata_labels:
      #           - container.id
      #           - k8s.volume.type
      #         metric_groups:
      #           - node
      #           - pod
      #           - volume
      #           - container
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/kubeletstatsreceiver
      kubeletstats:
        collection_interval: 10s
        auth_type: serviceAccount
        # endpoint: "`endpoint`:`kubelet_endpoint_port`"
        insecure_skip_verify: true
        extra_metadata_labels:
          - container.id
          - k8s.volume.type
        metric_groups:
          - node
          - pod
          - volume
          - container
    processors:
      # https://github.com/open-telemetry/opentelemetry-collector/tree/main/processor/batchprocessor
      batch:
        send_batch_max_size: 1000
        timeout: 30s
        send_batch_size : 800
      # https://github.com/open-telemetry/opentelemetry-collector/tree/main/processor/memorylimiterprocessor
      memory_limiter:
         check_interval: 1s
         limit_percentage: 70
         spike_limit_percentage: 30
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/metricstransformprocessor
      # metricstransform:
      #   transforms:
      #      include: .+
      #      match_type: regexp
      #      action: update
      #      operations:
      #        - action: add_label
      #          new_label: kubernetes.cluster.id
      #          new_value: CLUSTER_ID_TO_REPLACE
      #        - action: add_label
      #          new_label: kubernetes.name
      #          new_value: CLUSTER_NAME_TO_REPLACE
    processors:
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/k8sattributesprocessor
      k8sattributes:
        auth_type: serviceAccount
        passthrough: false
        filter:
          node_from_env_var: K8S_NODE_NAME
        extract:
          metadata:
            - k8s.pod.name
            - k8s.pod.uid
            - k8s.deployment.name
            - k8s.namespace.name
            - k8s.node.name
            - k8s.pod.start_time
      resourcedetection:
        detectors: [env, system]
    exporters:
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/prometheusexporter
      prometheus:
        endpoint: "0.0.0.0:9090"
        metric_expiration: 180m
        resource_to_telemetry_conversion:
          enabled: true
      # https://github.com/open-telemetry/opentelemetry-collector/blob/main/exporter/loggingexporter/README.md
      logging:
        loglevel: debug
        # verbosity: detailed
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/lokiexporter
      loki:
         endpoint: http://LOKI_TO_REPLACE.loki.svc.cluster.local:3100/loki/api/v1/push
         labels:
           resource:
             container.name: "container_name"
             k8s.cluster.name: "k8s_cluster_name"
             k8s.event.reason: "k8s_event_reason"
             k8s.object.kind: "k8s_object_kind"
             k8s.object.name: "k8s_object_name"
             k8s.object.uid: "k8s_object_uid"
             k8s.object.fieldpath: "k8s_object_fieldpath"
             k8s.object.api_version: "k8s_object_api_version"
           attributes:
             k8s.event.reason: "k8s_event_reason"
             k8s.event.action: "k8s_event_action"
             k8s.event.start_time: "k8s_event_start_time"
             k8s.event.name: "k8s_event_name"
             k8s.event.uid: "k8s_event_uid"
             k8s.namespace.name: "k8s_namespace_name"
             k8s.event.count: "k8s_event_count"
           record:
             traceID: "traceid"
    extensions:
      # https://github.com/open-telemetry/opentelemetry-collector/tree/main/extension/ballastextension
      memory_ballast:
        size_in_percentage: 20
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/extension/observer/README.md
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/extension/observer/k8sobserver/README.md
      k8s_observer:
        auth_type: serviceAccount
        node: ${K8S_NODE_NAME}
        observe_pods: true
        observe_nodes: true
      # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/extension/observer/hostobserver/README.md
      # host_observer:
      #   refresh_interval: 10s
    service:
      extensions: [k8s_observer,memory_ballast]
      pipelines:
        logs:
          receivers: [k8s_events]
          processors: [memory_limiter,k8sattributes,batch]
          # exporters: [loki,logging]
          exporters: [logging]
        metrics:
          receivers: [k8s_cluster,kubeletstats]
          processors: [memory_limiter,k8sattributes,batch]
          # processors: [memory_limiter,resourcedetection,metricstransform,k8sattributes,batch]
          # exporters: [prometheus]
          exporters: [logging]